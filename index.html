<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parking Pro - Gest√£o de Estacionamento & Lava-r√°pido</title>
    
    <!-- PWA META TAGS -->
    <meta name="theme-color" content="#0891b2">
    <meta name="description" content="Parking Pro - Gest√£o Inteligente de Estacionamento e Lava-r√°pido">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Parking Pro">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/256/75/75905.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tesseract.js para OCR (Leitura de Placas) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Firebase App & Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            .no-print { display: none !important; }
        }

        .ticket-paper { font-family: 'Courier New', Courier, monospace; width: 300px; margin: 0 auto; background: #fff; color: #000; padding: 10px; text-align: center; border: 1px dashed #ccc; }
        .ticket-divider { border-bottom: 1px dashed #000; margin: 10px 0; }
        .os-paper { font-family: 'Arial', sans-serif; width: 100%; background: #fff; color: #000; padding: 20px; border: 1px solid #000; }
        .barcode { height: 40px; width: 100%; background-image: linear-gradient(90deg, #000 2%, transparent 2%, transparent 4%, #000 4%, #000 5%, transparent 5%, transparent 6%, #000 6%, #000 8%, transparent 8%, transparent 9%, #000 9%, #000 12%, transparent 12%, transparent 13%, #000 13%, #000 15%, transparent 15%, transparent 16%, #000 16%, #000 19%, transparent 19%, transparent 20%, #000 20%, #000 23%, transparent 23%, transparent 24%, #000 24%, #000 25%, transparent 25%, transparent 26%, #000 26%, #000 29%, transparent 29%, transparent 30%, #000 30%, #000 31%, transparent 31%, transparent 32%, #000 32%, #000 35%, transparent 35%, transparent 36%, #000 36%, #000 38%, transparent 38%, transparent 39%, #000 39%, #000 42%, transparent 42%, transparent 43%, #000 43%, #000 45%, transparent 45%, transparent 46%, #000 46% ); background-size: 100% 100%; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator, input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONSTANTES DE CONFIGURA√á√ÉO ---
        const APP_ID_STABLE = "estacionamento-332eb";
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDYdrt4kbKtyPbx7ipHHb7wftUAlKeOZeE",
            authDomain: "estacionamento-332eb.firebaseapp.com",
            projectId: "estacionamento-332eb",
            storageBucket: "estacionamento-332eb.firebasestorage.app",
            messagingSenderId: "467691522256",
            appId: "1:467691522256:web:6d4495458c494e753cb6d5"
        };

        // --- IMPLEMENTA√á√ÉO DO COFRE DIGITAL (SEGURAN√áA E CRIPTOGRAFIA) ---
        const Security = {
            encrypt: (data) => {
                if (typeof data !== 'object' && typeof data !== 'string') return data;
                const str = typeof data === 'object' ? JSON.stringify(data) : data;
                return btoa(unescape(encodeURIComponent(str)));
            },
            decrypt: (encryptedData) => {
                try {
                    if (typeof encryptedData !== 'string') return encryptedData;
                    const decoded = decodeURIComponent(escape(atob(encryptedData)));
                    try { return JSON.parse(decoded); } catch(e) { return decoded; }
                } catch (e) {
                    return encryptedData; 
                }
            }
        };

        // --- COMPONENTE TOAST ---
        const Toast = ({ message, type, show, onClose }) => {
            if (!show) return null;
            const colors = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-emerald-600' : (type === 'info' ? 'bg-blue-600' : 'bg-cyan-600'));
            return (
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 md:left-auto md:translate-x-0 md:right-4 ${colors} text-white px-6 py-4 rounded-lg shadow-2xl z-[70] flex items-center gap-3 animate-fade-in w-[90%] md:w-auto`}>
                    <i className="ph-fill ph-info text-xl"></i>
                    <span className="font-bold text-sm md:text-base">{message}</span>
                </div>
            );
        };

        // --- COMPONENTE CHART ---
        const ParkingChart = ({ historyData, financeData }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                if (chartRef.current) chartRef.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                const last7Days = [...Array(7)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toLocaleDateString('pt-BR');
                }).reverse();

                const parkingRevenue = last7Days.map(date => {
                    return (Array.isArray(historyData) ? historyData : []).filter(h => new Date(h.exitTime).toLocaleDateString('pt-BR') === date)
                                .reduce((acc, curr) => acc + (curr.total || 0), 0);
                });

                const expensesData = last7Days.map(date => {
                    return (Array.isArray(financeData) ? financeData : []).filter(f => f.type === 'Despesa' && new Date(f.date + 'T12:00:00').toLocaleDateString('pt-BR') === date)
                                .reduce((acc, curr) => acc + (curr.value || 0), 0);
                });

                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: last7Days,
                        datasets: [
                            { label: 'Receita', data: parkingRevenue, backgroundColor: '#0891b2', borderRadius: 4 },
                            { label: 'Despesas', data: expensesData, backgroundColor: '#ef4444', borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', labels: { color: '#cbd5e1', font: { size: 10 } } } },
                        scales: {
                            y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', font: { size: 10 } } },
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } }
                        }
                    }
                });
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [historyData, financeData]);

            return <div className="h-64 w-full"><canvas ref={canvasRef}></canvas></div>;
        };

        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
        
        const BrandLogo = ({ title }) => {
            const displayText = title && title.trim() !== '' ? title : "PARKING PRO";
            const isDefault = displayText.replace(/\s/g, '').toUpperCase() === 'PARKINGPRO';
            return (
                <div className="flex items-center gap-2">
                    <div className="w-8 h-8 md:w-10 md:h-10 bg-cyan-500 rounded flex items-center justify-center shadow-lg shadow-cyan-900/50 flex-shrink-0">
                        <i className="ph-fill ph-car text-white text-xl md:text-2xl"></i>
                    </div>
                    <div className="min-w-0 text-left">
                        {isDefault ? (
                            <h1 className="text-lg md:text-xl font-black italic tracking-tighter text-white leading-none whitespace-nowrap">PARKING<span className="text-cyan-400">PRO</span></h1>
                        ) : (
                            <h1 className="text-lg md:text-xl font-black italic tracking-tighter text-white leading-none uppercase truncate max-w-[180px]">{displayText}</h1>
                        )}
                        <p className="text-[8px] md:text-[9px] text-slate-400 font-bold uppercase tracking-widest">Sistema Inteligente</p>
                    </div>
                </div>
            );
        };

        // --- TELA DE LOGIN ATUALIZADA (L√ìGICA DE IDENTIDADE) ---
        const LoginScreen = ({ onLogin, loginMode, setLoginMode, systemName, remember, setRemember }) => {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [email, setEmail] = useState('');

            useEffect(() => {
                const savedUser = localStorage.getItem('parkingpro_saved_user');
                const savedPass = localStorage.getItem('parkingpro_saved_pass');
                if (savedUser && savedPass) {
                    setU(savedUser);
                    setP(savedPass);
                    setRemember(true);
                }
            }, []);

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(u, p, email);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950 relative overflow-hidden px-4">
                    <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'url("https://images.unsplash.com/photo-1506521781263-d8422e82f27a?q=80&w=2070&auto=format&fit=crop")', backgroundSize: 'cover', backgroundPosition: 'center'}}></div>
                    <div className="bg-slate-900/90 backdrop-blur-xl p-8 rounded-2xl shadow-2xl w-full max-w-md z-10 border border-slate-800">
                        <div className="flex justify-center mb-6"><BrandLogo title={systemName} /></div>
                        <h2 className="text-center text-cyan-500 font-black uppercase text-sm mb-6 tracking-widest">
                            {loginMode === 'register' ? 'Criar Identidade na Nuvem' : 'Acesso ao Cofre Master'}
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-black text-slate-500 uppercase mb-2">Nome de Usu√°rio (Login)</label>
                                <input id="login_field" className="w-full p-4 bg-slate-950 border border-slate-800 rounded-xl text-white focus:border-cyan-500 outline-none transition" placeholder="Ex: gestor_pro" value={u} onChange={e=>setU(e.target.value)} />
                            </div>
                            
                            {loginMode === 'register' && (
                                <div>
                                    <label className="block text-xs font-black text-slate-500 uppercase mb-2">E-mail de Recupera√ß√£o</label>
                                    <input id="email_field" type="email" className="w-full p-4 bg-slate-950 border border-slate-800 rounded-xl text-white focus:border-cyan-500 outline-none transition" placeholder="seu@email.com" value={email} onChange={e=>setEmail(e.target.value)} />
                                </div>
                            )}

                            <div>
                                <label className="block text-xs font-black text-slate-500 uppercase mb-2">Sua Senha</label>
                                <input id="pass_field" type="password" className="w-full p-4 bg-slate-950 border border-slate-800 rounded-xl text-white focus:border-cyan-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={p} onChange={e=>setP(e.target.value)} />
                            </div>

                            <div className="flex items-center gap-2">
                                <input type="checkbox" id="remember_me" checked={remember} onChange={e => setRemember(e.target.checked)} className="w-4 h-4 accent-cyan-600 rounded cursor-pointer" />
                                <label htmlFor="remember_me" className="text-sm text-slate-400 cursor-pointer select-none">Lembrar meus dados para o pr√≥ximo acesso</label>
                            </div>

                            <button className="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-black py-4 rounded-xl transition-all shadow-lg shadow-cyan-900/20 active:scale-95 uppercase tracking-widest">
                                {loginMode === 'register' ? 'Cadastrar e Abrir' : 'Entrar no Sistema'}
                            </button>
                        </form>
                        
                        <div className="mt-6 text-center">
                            {loginMode === 'login' ? (
                                <button onClick={() => setLoginMode('register')} className="text-cyan-500 text-xs font-black hover:underline uppercase tracking-wider">PRIMEIRO ACESSO? CADASTRE-SE AQUI</button>
                            ) : (
                                <button onClick={() => setLoginMode('login')} className="text-slate-500 text-xs font-bold hover:underline uppercase">J√Å TENHO CADASTRO. FAZER LOGIN</button>
                            )}
                        </div>

                        <div className="mt-8 border-t border-slate-800 pt-6 text-center text-[10px] text-slate-600 uppercase font-black tracking-widest">
                            <p>¬© 2026 SoftGest√£o - Adriana Mendes da Cruz Sousa</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [view, setView] = useState('loading');
            const [userRole, setUserRole] = useState('admin'); 
            const [userLogin, setUserLogin] = useState('');
            const [loginMode, setLoginMode] = useState('login');
            const [rememberMe, setRememberMe] = useState(false);
            const [isLogged, setIsLogged] = useState(false);

            const [toast, setToast] = useState({ show: false, msg: '', type: 'info' });
            const notify = (msg, type='success') => { setToast({ show: true, msg, type }); setTimeout(()=>setToast(prev => ({...prev, show: false})), 3000); };

            const [config, setConfig] = useState({ 
                name: '', address: 'Av. Paulista, 1000 - SP', totalSpots: 50, priceCarHour: 15.00, priceMotoHour: 8.00, toleranceMin: 15, dailyRate: 60.00,
                requireLogin: true
            });

            // Listas de Dados
            const [tickets, setTickets] = useState([]); 
            const [history, setHistory] = useState([]); 
            const [subscribers, setSubscribers] = useState([]); 
            const [agreements, setAgreements] = useState([]); 
            const [checklists, setChecklists] = useState([]); 
            const [finances, setFinances] = useState([]); 
            const [team, setTeam] = useState([]); 
            const [clients, setClients] = useState([]); 
            const [suppliers, setSuppliers] = useState([]); 
            const [servicesList, setServicesList] = useState([]);

            const [tab, setTab] = useState('dashboard');
            const [modal, setModal] = useState(null);
            const [activeTicket, setActiveTicket] = useState(null); 
            const [filterPlate, setFilterPlate] = useState('');
            const [paymentMethod, setPaymentMethod] = useState('Dinheiro');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false); 
            const [loadingCamera, setLoadingCamera] = useState(false);

            const [db, setDb] = useState(null);
            const [isOnline, setIsOnline] = useState(false);

            // Estados de formul√°rio (Mantidos do Parking Pro)
            const [entryForm, setEntryForm] = useState({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] });
            const [agreementForm, setAgreementForm] = useState({ name: '', discountType: 'free_time', value: 0 });
            const [checklistForm, setChecklistForm] = useState({ plate: '', model: '', fuel: '1/2', items: [], notes: '', date: '' });
            const [financeForm, setFinanceForm] = useState({ type: 'Despesa', description: '', value: 0, date: '', category: 'Geral', file: null, fileName: '' });
            const [teamForm, setTeamForm] = useState({ name: '', role: 'Operador', shift: 'Manh√£', phone: '' });
            const [serviceConfigForm, setServiceConfigForm] = useState({ name: '', price: 0 });
            const [addServiceForm, setAddServiceForm] = useState({ ticketId: '', selectedServices: [] });
            const [clientForm, setClientForm] = useState({ name: '', phone: '', plate: '', points: 0, notes: '' });
            const [supplierForm, setSupplierForm] = useState({ name: '', contact: '', category: 'Pe√ßas', notes: '' });
            const [subscriberForm, setSubscriberForm] = useState({ name: '', plate: '', model: '', plan: 'Integral', dueDay: 10, active: true });
            const [editTicketForm, setEditTicketForm] = useState({ plate: '', model: '', type: 'Carro', notes: '' });

            const [editClient, setEditClient] = useState(null);
            const [editSubscriber, setEditSubscriber] = useState(null);
            const [editSupplier, setEditSupplier] = useState(null);
            const [editingServiceId, setEditingServiceId] = useState(null);
            const [editingAgreementId, setEditingAgreementId] = useState(null);
            const [editingTeamId, setEditingTeamId] = useState(null);
            const [editingFinanceId, setEditingFinanceId] = useState(null);
            const [editingItemIsHistory, setEditingItemIsHistory] = useState(false); 

            const commonDamages = ['Arranh√µes', 'Amassados', 'Vidro Trincado', 'Farol Quebrado', 'Pneu Murcho', 'Antena Quebrada', 'Retrovisor Danif.'];

            const tabNames = { dashboard: 'Vis√£o Geral', patio: 'P√°tio & Entrada', carwash: 'Lava-r√°pido', finance: 'Financeiro', suppliers: 'Fornecedores', team: 'Equipe', clients: 'Fidelidade', subscribers: 'Mensalistas', agreements: 'Conv√™nios', config: 'Configura√ß√µes' };

            // --- INICIALIZA√á√ÉO FIREBASE ---
            useEffect(() => {
                if (!firebase.apps.length) {
                    try {
                        firebase.initializeApp(FIREBASE_CONFIG);
                        const firestore = firebase.firestore();
                        setDb(firestore);
                        setIsOnline(true);
                        
                        // Persist√™ncia Offline
                        firestore.enablePersistence().catch(err => console.log("Erro persist√™ncia:", err.code));
                    } catch (e) {
                        setIsOnline(false);
                    }
                } else {
                    setDb(firebase.firestore());
                    setIsOnline(true);
                }
                
                // Auth An√¥nima Inicial
                firebase.auth().signInAnonymously().catch(e => console.log("Auth error:", e));
            }, []);

            // --- L√ìGICA DO COFRE DIGITAL: COLE√á√ïES ISOLADAS ---
            const getIsolatedCollection = (name) => {
                if (!isLogged || !userLogin || !db) return null;
                return db.collection('artifacts').doc(APP_ID_STABLE).collection('public').doc('data').collection(`${userLogin}_${name}`);
            };

            // --- L√ìGICA DE LOGIN COM IDENTIDADE ---
            const handleIdentityLogin = async (userVal, passVal, emailVal) => {
                if (!userVal || !passVal) { notify("Preencha todos os campos.", "error"); return; }
                if (rememberMe) {
                    localStorage.setItem('parkingpro_saved_user', userVal);
                    localStorage.setItem('parkingpro_saved_pass', passVal);
                }

                try {
                    const docRef = db.collection('artifacts').doc(APP_ID_STABLE).collection('public').doc('data').collection(`${userVal}_config_seguranca`).doc('status');
                    const docSnap = await docRef.get();

                    if (loginMode === 'register') {
                        if (docSnap.exists) { notify("Este usu√°rio j√° existe.", "error"); return; }
                        const regData = { login: userVal, pass: Security.encrypt(passVal), recovery: Security.encrypt(emailVal || ''), status: 'registered', date: new Date().toISOString() };
                        await docRef.set({ payload: Security.encrypt(regData) });
                        notify("‚úÖ Identidade criada! Agora entre.", "success");
                        setLoginMode('login');
                        return;
                    }

                    if (!docSnap.exists) { notify("Usu√°rio n√£o encontrado.", "error"); return; }

                    const storedData = Security.decrypt(docSnap.data().payload);
                    if (Security.decrypt(storedData.pass) === passVal) {
                        setUserLogin(userVal);
                        setIsLogged(true);
                        localStorage.setItem('parkingpro_session_active', 'true');
                        localStorage.setItem('parkingpro_session_user', userVal);
                        setUserRole(userVal.toLowerCase() === 'admin' ? 'admin' : 'operator');
                        setView('app');
                    } else {
                        notify("Senha incorreta.", "error");
                    }
                } catch (e) {
                    notify("Erro ao conectar com o cofre digital.", "error");
                }
            };

            // --- SINCRONIZA√á√ÉO DE DADOS ISOLADOS ---
            const useSync = (collectionName, setState) => {
                useEffect(() => {
                    const col = getIsolatedCollection(collectionName);
                    if (col) {
                        const unsubscribe = col.onSnapshot(snapshot => {
                            const data = snapshot.docs.map(doc => {
                                const d = doc.data();
                                const decrypted = d.payload ? Security.decrypt(d.payload) : d;
                                return { ...decrypted, id: doc.id };
                            });
                            setState(data);
                        }, err => console.error(`Erro sync ${collectionName}`, err));
                        return () => unsubscribe();
                    } else {
                        const stored = localStorage.getItem(`parkingpro_${userLogin}_${collectionName}`);
                        if (stored) setState(JSON.parse(stored));
                    }
                }, [db, isLogged, userLogin]);
            };

            useSync('tickets', setTickets);
            useSync('history', setHistory);
            useSync('finances', setFinances);
            useSync('subscribers', setSubscribers);
            useSync('clients', setClients);
            useSync('team', setTeam);
            useSync('suppliers', setSuppliers);
            useSync('agreements', setAgreements);
            useSync('servicesList', setServicesList);
            useSync('config', (data) => data.length > 0 && setConfig(data[0]));

            // --- PERSIST√äNCIA E LOGIN AUTOM√ÅTICO ---
            useEffect(() => {
                const sessionActive = localStorage.getItem('parkingpro_session_active');
                const sessionUser = localStorage.getItem('parkingpro_session_user');
                const storedConfig = localStorage.getItem('parkingpro_config');

                if (storedConfig) setConfig(JSON.parse(storedConfig));

                if (sessionActive === 'true' && sessionUser) {
                    setUserLogin(sessionUser);
                    setIsLogged(true);
                    setUserRole(sessionUser.toLowerCase() === 'admin' ? 'admin' : 'operator');
                    setView('app');
                } else {
                    setView('login');
                }
            }, []);

            // --- CRUD HELPERS ---
            const saveItem = async (colName, item, idOverride) => {
                const col = getIsolatedCollection(colName);
                if (!col) return;
                const id = idOverride ? String(idOverride) : String(item.id || Date.now());
                const encrypted = { payload: Security.encrypt(item) };
                try {
                    await col.doc(id).set(encrypted);
                } catch(e) { notify('Erro ao salvar no cofre', 'error'); }
            };

            const deleteItem = async (colName, id) => {
                const col = getIsolatedCollection(colName);
                if (col) await col.doc(String(id)).delete();
            };

            // --- FUNCIONALIDADES DO SISTEMA (MANTIDAS) ---
            const handleEntry = () => { 
                if (!entryForm.plate) return notify('Placa √© obrigat√≥ria', 'error'); 
                const entryDateObj = entryForm.manualEntry ? new Date(entryForm.manualEntry) : new Date(); 
                const isSub = subscribers.find(s => s.plate === entryForm.plate.toUpperCase() && s.active); 
                const loyaltyClient = clients.find(c => c.plate === entryForm.plate.toUpperCase()); 
                
                if (loyaltyClient) { 
                    const updated = { ...loyaltyClient, points: (loyaltyClient.points || 0) + 1 }; 
                    saveItem('clients', updated, updated.id); 
                    notify(`Cliente Fidelidade: ${loyaltyClient.name}. +1 Ponto!`, 'success'); 
                } 
                
                const newTicket = { id: Date.now(), plate: entryForm.plate.toUpperCase(), model: entryForm.model, type: entryForm.type, entryTime: entryDateObj.toISOString(), isSubscriber: !!isSub, isLoyalty: !!loyaltyClient, loyaltyClientId: loyaltyClient ? loyaltyClient.id : null, subscriberName: isSub ? isSub.name : null, notes: entryForm.notes, damages: entryForm.damages || [], services: [], status: 'active' }; 

                if (entryForm.manualExit) {
                    const exitDateObj = new Date(entryForm.manualExit);
                    if (exitDateObj <= entryDateObj) return notify('Sa√≠da deve ser ap√≥s entrada.', 'error');
                    const diffMins = Math.floor((exitDateObj - entryDateObj) / 60000);
                    const diffHours = Math.ceil(diffMins / 60);
                    let total = 0;
                    if (!isSub) {
                        if (diffMins > config.toleranceMin) {
                            const rate = entryForm.type === 'Carro' ? config.priceCarHour : config.priceMotoHour;
                            total = diffHours >= 8 ? config.dailyRate : diffHours * rate;
                        }
                    }
                    const historyItem = { ...newTicket, exitTime: exitDateObj.toISOString(), durationMins: diffMins, durationHours: diffHours, subTotal: total, total: total, paymentMethod: 'Dinheiro (Manual)', status: 'finished', isHistory: true };
                    saveItem('history', historyItem);
                    setEntryForm({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] });
                    notify('Lan√ßamento realizado!');
                    return;
                }
                saveItem('tickets', newTicket);
                setEntryForm({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] });
                setActiveTicket(newTicket);
                setModal('print_entry');
                notify('Ve√≠culo registrado!');
            };

            const confirmExit = () => { 
                const finished = {...activeTicket, paymentMethod, status: 'finished', isHistory: true}; 
                saveItem('history', finished); 
                deleteItem('tickets', activeTicket.id);
                setModal('print_exit'); notify('Sa√≠da registrada!'); 
            };

            const saveFinance = () => { 
                const val = parseFloat(financeForm.value);
                if (editingFinanceId) {
                    if (editingItemIsHistory) {
                        const original = history.find(h => h.id === editingFinanceId);
                        if (original) {
                            const updated = { ...original, total: val, exitTime: new Date(financeForm.date + 'T12:00:00').toISOString() };
                            saveItem('history', updated, editingFinanceId);
                        }
                    } else {
                        const updated = { ...financeForm, id: editingFinanceId, value: val };
                        saveItem('finances', updated, editingFinanceId);
                    }
                } else {
                    const newFinance = { ...financeForm, id: Date.now(), value: val }; 
                    saveItem('finances', newFinance); 
                }
                setFinanceForm({ type: 'Despesa', description: '', value: 0, date: '', category: 'Geral', file: null, fileName: '' }); 
                setModal(null); 
                setEditingFinanceId(null);
            };

            // Estat√≠sticas
            const stats = useMemo(() => {
                const occupied = tickets.length; const free = config.totalSpots - occupied;
                const ticketsRevenue = history.filter(h => new Date(h.exitTime).toDateString() === new Date().toDateString()).reduce((acc, curr) => acc + curr.total, 0);
                const extraRevenue = finances.filter(f => f.type === 'Receita' && new Date(f.date + 'T12:00:00').toDateString() === new Date().toDateString()).reduce((acc, curr) => acc + curr.value, 0);
                const expenses = finances.filter(f => f.type === 'Despesa' && new Date(f.date + 'T12:00:00').toDateString() === new Date().toDateString()).reduce((acc, curr) => acc + curr.value, 0);
                const totalRevenue = ticketsRevenue + extraRevenue;
                return { occupied, free, totalRevenue, expenses, balance: totalRevenue - expenses, activeSubscribers: subscribers.filter(s => s.active).length };
            }, [tickets, history, subscribers, finances, config]);

            if (view === 'loading') return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-cyan-500 font-bold animate-pulse">SINCRONIZANDO COFRE DIGITAL...</div>;
            
            if (!isLogged) return (
                <LoginScreen 
                    onLogin={handleIdentityLogin} 
                    loginMode={loginMode} 
                    setLoginMode={setLoginMode} 
                    systemName={config.name} 
                    remember={rememberMe} 
                    setRemember={setRememberMe} 
                />
            );

            return (
                <div className="flex h-screen overflow-hidden bg-slate-900 text-slate-100 font-sans">
                    <Toast {...toast} onClose={()=>setToast(prev => ({...prev, show:false}))} />
                    
                    {isMobileMenuOpen && <div className="fixed inset-0 bg-black/50 z-40 md:hidden" onClick={() => setIsMobileMenuOpen(false)}></div>}

                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-950 transition-transform duration-300 ease-in-out md:relative md:translate-x-0 flex flex-col ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-slate-800 flex justify-between items-center">
                            <BrandLogo title={config.name} />
                            <button className="md:hidden text-slate-400" onClick={() => setIsMobileMenuOpen(false)}><i className="ph-bold ph-x text-2xl"></i></button>
                        </div>
                        <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                            {[
                                { id: 'dashboard', label: 'Vis√£o Geral', icon: 'gauge', roles: ['admin', 'operator'] },
                                { id: 'patio', label: 'P√°tio & Entrada', icon: 'car-profile', roles: ['admin', 'operator'] },
                                { id: 'carwash', label: 'Lava-r√°pido', icon: 'drop-half', roles: ['admin', 'operator'] }, 
                                { id: 'finance', label: 'Financeiro', icon: 'currency-dollar', roles: ['admin', 'operator'] },
                                { id: 'team', label: 'Equipe', icon: 'users', roles: ['admin'] },
                                { id: 'clients', label: 'Fidelidade', icon: 'identification-card', roles: ['admin', 'operator'] },
                                { id: 'subscribers', label: 'Mensalistas', icon: 'users-three', roles: ['admin', 'operator'] },
                                { id: 'agreements', label: 'Conv√™nios', icon: 'handshake', roles: ['admin'] },
                                { id: 'config', label: 'Configura√ß√µes', icon: 'gear', roles: ['admin'] },
                            ].filter(i => i.roles.includes(userRole)).map(item => (
                                <button key={item.id} onClick={() => { setTab(item.id); setIsMobileMenuOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-sm font-bold ${tab === item.id ? 'bg-cyan-600 text-white shadow-lg shadow-cyan-900/50' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                    <i className={`ph ph-${item.icon} text-xl`}></i> {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-800">
                             <div className="flex items-center gap-2 mb-4">
                                <div className="w-8 h-8 rounded-full bg-cyan-600 flex items-center justify-center font-black text-xs">{userLogin.charAt(0).toUpperCase()}</div>
                                <div className="min-w-0">
                                    <p className="text-xs font-bold text-white truncate">{userLogin}</p>
                                    <p className="text-[10px] text-slate-500 uppercase">{userRole}</p>
                                </div>
                             </div>
                             <button onClick={() => { localStorage.removeItem('parkingpro_session_active'); window.location.reload(); }} className="w-full py-2 bg-slate-800 hover:bg-red-900/30 text-slate-400 hover:text-red-400 rounded text-[10px] font-black uppercase transition-all">Sair do Sistema</button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden relative w-full">
                        <header className="h-16 bg-slate-900/80 backdrop-blur border-b border-slate-800 flex items-center justify-between px-4 md:px-6 z-10">
                            <div className="flex items-center gap-3">
                                <button className="md:hidden text-slate-300" onClick={() => setIsMobileMenuOpen(true)}><i className="ph-bold ph-list text-2xl"></i></button>
                                <h2 className="text-lg md:text-xl font-bold text-white tracking-wide uppercase truncate">{tabNames[tab]}</h2>
                            </div>
                            <div className="text-right">
                                <p className="text-[10px] md:text-xs text-slate-400">Vagas Livres</p>
                                <p className={`text-lg md:text-xl font-black ${stats.free < 5 ? 'text-red-500' : 'text-emerald-400'}`}>{stats.free} <span className="text-xs md:text-sm font-normal text-slate-500">/ {config.totalSpots}</span></p>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-6 relative bg-slate-900">
                            
                            {/* DASHBOARD */}
                            {tab === 'dashboard' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-cyan-500 shadow-lg"><p className="text-xs text-slate-400 uppercase font-bold">Ocupa√ß√£o</p><h3 className="text-3xl font-bold text-white mt-2">{stats.occupied}</h3></div>
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-emerald-500 shadow-lg"><p className="text-xs text-slate-400 uppercase font-bold">Receita (Dia)</p><h3 className="text-3xl font-bold text-emerald-400 mt-2">{formatCurrency(stats.totalRevenue)}</h3></div>
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-red-500 shadow-lg"><p className="text-xs text-slate-400 uppercase font-bold">Despesas (Dia)</p><h3 className="text-3xl font-bold text-red-400 mt-2">{formatCurrency(stats.expenses)}</h3></div>
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-blue-500 shadow-lg"><p className="text-xs text-slate-400 uppercase font-bold">Balan√ßo (Dia)</p><h3 className={`text-3xl font-bold mt-2 ${stats.balance >= 0 ? 'text-blue-400' : 'text-red-400'}`}>{formatCurrency(stats.balance)}</h3></div>
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <div className="lg:col-span-2 bg-slate-800 rounded-xl p-6 border border-slate-700"><h3 className="font-bold text-lg mb-4 text-white">Fluxo Financeiro (7 Dias)</h3><ParkingChart historyData={history} financeData={finances} /></div>
                                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700"><h3 className="font-bold text-lg mb-4 text-white">Mapa de Vagas</h3><div className="grid grid-cols-5 gap-2 max-h-64 overflow-y-auto pr-2">{Array.from({length: parseInt(config.totalSpots)}).map((_, i) => { const isOccupied = i < tickets.length; return (<div key={i} className={`aspect-square rounded-md flex items-center justify-center text-xs font-bold transition ${isOccupied ? 'bg-red-500/20 text-red-500 border border-red-500' : 'bg-emerald-500/20 text-emerald-500 border border-emerald-500'}`}>{i + 1}</div>); })}</div></div>
                                    </div>
                                    
                                    {/* SUPORTE E SEGURAN√áA NO DASHBOARD */}
                                    <div className="bg-gradient-to-r from-cyan-900/50 to-slate-900 border border-cyan-800/50 rounded-2xl p-6 flex flex-col md:flex-row items-center justify-between gap-6 shadow-2xl">
                                        <div className="flex items-center gap-4">
                                            <div className="w-12 h-12 bg-cyan-600 rounded-xl flex items-center justify-center text-2xl shadow-lg shadow-cyan-900/50"><i className="ph-fill ph-shield-check"></i></div>
                                            <div>
                                                <h4 className="text-xl font-black uppercase italic text-white tracking-tighter">Cofre Digital Ativo</h4>
                                                <p className="text-xs text-slate-400 font-bold uppercase tracking-widest">Seus dados est√£o criptografados na nuvem</p>
                                            </div>
                                        </div>
                                        <a href="https://wa.me/5511932186193?text=Ol√°,%20preciso%20de%20suporte%20no%20Parking%20Pro." target="_blank" className="bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-3 rounded-xl font-black shadow-lg hover:scale-105 transition-all uppercase text-sm flex items-center gap-2">
                                            <i className="ph-bold ph-whatsapp-logo"></i> Falar com Suporte Master
                                        </a>
                                    </div>
                                </div>
                            )}

                            {/* P√ÅTIO (MANTIDO) */}
                            {tab === 'patio' && (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in h-full">
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 h-fit shadow-xl">
                                        <h3 className="font-bold text-xl text-cyan-400 mb-6 flex items-center gap-2"><i className="ph-bold ph-gate"></i> Nova Entrada</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-xs text-slate-400 uppercase font-bold block mb-1">Placa</label>
                                                <div className="flex gap-2">
                                                    <input className="w-full bg-slate-900 border-2 border-slate-700 p-4 rounded-lg text-white font-mono text-2xl uppercase focus:border-cyan-500 outline-none text-center tracking-widest" placeholder="ABC-1234" value={entryForm.plate} onChange={e => setEntryForm({...entryForm, plate: e.target.value.toUpperCase()})} />
                                                    <label className="bg-slate-700 hover:bg-slate-600 text-white p-3 rounded-lg border-2 border-slate-600 flex items-center justify-center w-16 cursor-pointer">
                                                        <i className="ph-bold ph-camera text-2xl"></i>
                                                        <input type="file" accept="image/*" capture="environment" className="hidden" onChange={async (e) => {
                                                            const file = e.target.files[0];
                                                            if (!file) return;
                                                            setLoadingCamera(true); notify('Processando imagem...', 'info');
                                                            try {
                                                                const { data: { text } } = await Tesseract.recognize(file, 'eng');
                                                                const cleanText = text.replace(/[^A-Z0-9]/ig, '').toUpperCase();
                                                                const match = cleanText.match(/[A-Z]{3}[0-9][A-Z0-9][0-9]{2}/) || cleanText.match(/[A-Z]{3}[0-9]{4}/);
                                                                if (match) { setEntryForm(prev => ({ ...prev, plate: match[0] })); notify(`Placa: ${match[0]}`); }
                                                                else notify('N√£o identificado.', 'error');
                                                            } finally { setLoadingCamera(false); }
                                                        }} />
                                                    </label>
                                                </div>
                                            </div>
                                            <div className="flex bg-slate-900 rounded-lg p-1 border border-slate-700"><button onClick={()=>setEntryForm({...entryForm, type: 'Carro'})} className={`flex-1 py-3 rounded text-base md:text-sm font-bold transition ${entryForm.type === 'Carro' ? 'bg-cyan-600 text-white' : 'text-slate-400'}`}>Carro</button><button onClick={()=>setEntryForm({...entryForm, type: 'Moto'})} className={`flex-1 py-3 rounded text-base md:text-sm font-bold transition ${entryForm.type === 'Moto' ? 'bg-cyan-600 text-white' : 'text-slate-400'}`}>Moto</button></div>
                                            <input className="w-full bg-slate-900 border border-slate-700 p-4 rounded-lg text-white" placeholder="Modelo (Opcional)" value={entryForm.model} onChange={e=>setEntryForm({...entryForm, model:e.target.value})} />
                                            <button onClick={handleEntry} className="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-4 rounded-lg shadow-lg flex items-center justify-center gap-2 mt-4 text-lg active:scale-95 transition"><i className="ph-bold ph-ticket"></i> {entryForm.manualExit ? 'Lan√ßar Hist√≥rico' : 'Gerar Ticket'}</button>
                                        </div>
                                    </div>
                                    <div className="lg:col-span-2 bg-slate-800 rounded-xl p-4 md:p-6 border border-slate-700 flex flex-col min-h-[500px]">
                                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4"><h3 className="font-bold text-xl text-white">Ve√≠culos no P√°tio</h3><input className="bg-slate-900 border border-slate-700 rounded-lg py-3 px-4 text-white w-full md:w-64" placeholder="Filtrar placa..." value={filterPlate} onChange={e=>setFilterPlate(e.target.value.toUpperCase())} /></div>
                                        <div className="flex-1 overflow-y-auto pr-2 space-y-3">
                                            {tickets.filter(t => t.plate.includes(filterPlate)).map(t => (
                                                <div key={t.id} className="bg-slate-900 p-4 rounded-lg border border-slate-700 flex flex-col md:flex-row justify-between items-start md:items-center hover:border-cyan-500 transition group gap-4">
                                                    <div className="flex items-center gap-4">
                                                        <div className={`p-3 rounded-lg ${t.type === 'Carro' ? 'bg-blue-900/30 text-blue-400' : 'bg-orange-900/30 text-orange-400'}`}><i className={`ph-fill ${t.type === 'Carro' ? 'ph-car' : 'ph-motorcycle'} text-2xl`}></i></div>
                                                        <div>
                                                            <div className="flex items-center gap-2"><h4 className="font-bold text-white text-xl font-mono">{t.plate}</h4>{t.isSubscriber && <span className="bg-violet-600 text-white text-[10px] uppercase font-bold px-2 py-0.5 rounded">Mensalista</span>}</div>
                                                            <p className="text-sm text-slate-400">{t.model} ‚Ä¢ {new Date(t.entryTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2 w-full md:w-auto">
                                                        <button onClick={() => { const msg = `Ol√°! Ticket do ${config.name}:\nüöô Placa: ${t.plate}\nüïí Entrada: ${new Date(t.entryTime).toLocaleString()}`; window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`); }} className="p-3 bg-emerald-600 text-white rounded"><i className="ph-bold ph-whatsapp-logo"></i></button>
                                                        <button onClick={() => { const now = new Date(); const entry = new Date(t.entryTime); const diffMins = Math.floor((now - entry) / 60000); const diffHours = Math.ceil(diffMins / 60); let fee = 0; if (!t.isSubscriber) { if (diffMins > config.toleranceMin) { const rate = t.type === 'Carro' ? config.priceCarHour : config.priceMotoHour; fee = diffHours >= 8 ? config.dailyRate : diffHours * rate; } } const total = fee + (t.services || []).reduce((acc, s) => acc + s.price, 0); setActiveTicket({ ...t, exitTime: now.toISOString(), durationMins: diffMins, durationHours: diffHours, parkingFee: fee, total, subTotal: total }); setPaymentMethod('Dinheiro'); setModal('confirm_exit'); }} className="flex-1 md:flex-none bg-red-600 text-white px-4 py-3 rounded-lg font-bold flex items-center justify-center gap-2"><i className="ph-bold ph-sign-out"></i> Sa√≠da</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* CONFIGURA√á√ïES E COFRE DIGITAL */}
                            {tab === 'config' && (
                                <div className="max-w-4xl mx-auto space-y-6 animate-fade-in pb-10">
                                    <div className="bg-slate-800 p-8 rounded-xl border border-slate-700 shadow-2xl">
                                        <h3 className="font-bold text-2xl text-white mb-6 border-b border-slate-700 pb-4 flex items-center gap-2"><i className="ph-fill ph-gear"></i> Ajustes Gerais</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                            <div className="space-y-4">
                                                <div><label className="text-xs font-black text-slate-500 uppercase mb-2">Nome da Empresa</label><input className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white focus:border-cyan-500 outline-none" value={config.name} onChange={e=>setConfig({...config, name:e.target.value})} /></div>
                                                <div><label className="text-xs font-black text-slate-500 uppercase mb-2">Pre√ßo Hora (Carro)</label><input type="number" className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white" value={config.priceCarHour} onChange={e=>setConfig({...config, priceCarHour:parseFloat(e.target.value)})} /></div>
                                            </div>
                                            <div className="space-y-4">
                                                <div><label className="text-xs font-black text-slate-500 uppercase mb-2">Vagas Totais</label><input type="number" className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white" value={config.totalSpots} onChange={e=>setConfig({...config, totalSpots:parseInt(e.target.value)})} /></div>
                                                <div><label className="text-xs font-black text-slate-500 uppercase mb-2">Toler√¢ncia (Minutos)</label><input type="number" className="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white" value={config.toleranceMin} onChange={e=>setConfig({...config, toleranceMin:parseInt(e.target.value)})} /></div>
                                            </div>
                                        </div>
                                        <button onClick={() => { localStorage.setItem('parkingpro_config', JSON.stringify(config)); saveItem('config', config, 'current'); notify('Configura√ß√µes salvas no cofre!'); }} className="w-full bg-cyan-600 text-white font-black py-4 rounded-xl uppercase tracking-widest shadow-lg shadow-cyan-900/50">Salvar Altera√ß√µes</button>
                                    </div>

                                    {/* BLOCO: ENTENDA SUA SEGURAN√áA (COFRE DIGITAL MASTER) */}
                                    <div className="bg-gradient-to-br from-gray-900 to-black rounded-2xl shadow-2xl p-8 border-t-4 border-cyan-600">
                                        <div className="flex items-center gap-4 mb-8">
                                            <div className="text-4xl">üõ°Ô∏è</div>
                                            <h3 className="text-2xl font-black text-cyan-400 uppercase italic tracking-tighter">Cofre Digital: Sua Seguran√ßa Master</h3>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            <div className="bg-slate-800/50 p-6 rounded-2xl border border-cyan-900/30">
                                                <h4 className="text-cyan-500 font-black mb-3 flex items-center gap-2 text-sm uppercase"><i className="ph-fill ph-key"></i> Pasta Secreta</h4>
                                                <p className="text-slate-400 text-xs leading-relaxed">Seus dados s√£o salvos em uma pasta exclusiva associada ao seu login. Outros usu√°rios n√£o podem ver suas placas ou faturamento.</p>
                                            </div>
                                            <div className="bg-slate-800/50 p-6 rounded-2xl border border-cyan-900/30">
                                                <h4 className="text-cyan-500 font-black mb-3 flex items-center gap-2 text-sm uppercase"><i className="ph-fill ph-fingerprint"></i> Dados Embaralhados</h4>
                                                <p className="text-slate-400 text-xs leading-relaxed">Usamos criptografia Master. Mesmo se algu√©m acessar o banco de dados, ver√° apenas c√≥digos ileg√≠veis sem as suas chaves pessoais.</p>
                                            </div>
                                            <div className="bg-slate-800/50 p-6 rounded-2xl border border-cyan-900/30">
                                                <h4 className="text-cyan-500 font-black mb-3 flex items-center gap-2 text-sm uppercase"><i className="ph-fill ph-lock-keyhole"></i> Privacidade Total</h4>
                                                <p className="text-slate-400 text-xs leading-relaxed">O desenvolvedor n√£o tem acesso aos seus relat√≥rios. O controle √© 100% seu atrav√©s da sua Identidade Digital.</p>
                                            </div>
                                        </div>
                                        <div className="mt-8 pt-6 border-t border-slate-800 flex flex-col md:flex-row items-center justify-between gap-4">
                                            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Sua sess√£o expira ao fechar o navegador sem "Lembrar Me"</p>
                                            <button onClick={() => { if(confirm("Deseja mesmo sair?")) { localStorage.removeItem('parkingpro_session_active'); window.location.reload(); } }} className="text-red-500 text-xs font-black uppercase hover:underline">Encerrar Sess√£o com Seguran√ßa</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* FINANCEIRO (MANTIDO) */}
                            {tab === 'finance' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                        <h3 className="font-bold text-xl text-white">Controle Financeiro</h3>
                                        <button onClick={() => {setEditingFinanceId(null); setFinanceForm({type: 'Despesa', description: '', value: 0, date: new Date().toISOString().split('T')[0], category: 'Geral'}); setModal('finance');}} className="bg-emerald-600 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2"><i className="ph-bold ph-plus"></i> Lan√ßar Transa√ß√£o</button>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl overflow-hidden border border-slate-700">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left text-sm text-slate-300 min-w-[600px]">
                                                <thead className="bg-slate-950 text-slate-500 uppercase font-black text-[10px] tracking-widest">
                                                    <tr><th className="p-4">Data</th><th className="p-4">Descri√ß√£o</th><th className="p-4 text-center">Tipo</th><th className="p-4 text-right">Valor</th></tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-700">
                                                    {[...history.map(h => ({date: h.exitTime, desc: `Ticket ${h.plate}`, type: 'Receita', value: h.total})), 
                                                      ...finances]
                                                      .sort((a, b) => new Date(b.date) - new Date(a.date))
                                                      .map((item, idx) => (
                                                        <tr key={idx} className="hover:bg-slate-700/30 transition">
                                                            <td className="p-4 text-slate-500">{new Date(item.date).toLocaleDateString()}</td>
                                                            <td className="p-4 font-bold text-white uppercase">{item.desc || item.description}</td>
                                                            <td className="p-4 text-center"><span className={`px-2 py-1 rounded text-[10px] font-black ${item.type === 'Receita' ? 'text-emerald-400 bg-emerald-900/20' : 'text-red-400 bg-red-900/20'}`}>{item.type.toUpperCase()}</span></td>
                                                            <td className={`p-4 text-right font-bold ${item.type === 'Receita' ? 'text-emerald-400' : 'text-red-400'}`}>{formatCurrency(item.value)}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* MODAIS (MANTIDOS E ATUALIZADOS) */}
                    {modal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 no-print">
                            {modal === 'print_entry' && activeTicket && (
                                <div className="bg-white text-black p-6 rounded-xl max-w-sm w-full relative">
                                    <button onClick={() => setModal(null)} className="absolute top-2 right-2 text-gray-400"><i className="ph-bold ph-x text-xl"></i></button>
                                    <div id="print-area" className="text-center font-mono">
                                        <h2 className="font-bold text-xl">{config.name || 'PARKING PRO'}</h2>
                                        <div className="my-4 border-b-2 border-dashed border-black"></div>
                                        <h3 className="text-3xl font-black tracking-tighter uppercase">{activeTicket.plate}</h3>
                                        <p className="text-xs uppercase">{activeTicket.model}</p>
                                        <p className="text-[10px] mt-4">ENTRADA: {new Date(activeTicket.entryTime).toLocaleString()}</p>
                                        <div className="barcode mt-6"></div>
                                        <p className="text-[8px] mt-4 uppercase">Obrigado pela prefer√™ncia</p>
                                    </div>
                                    <button onClick={() => window.print()} className="w-full bg-cyan-600 text-white font-black py-4 rounded-xl mt-6 uppercase text-xs tracking-widest shadow-lg">Imprimir Ticket</button>
                                </div>
                            )}

                            {modal === 'confirm_exit' && activeTicket && (
                                <div className="bg-slate-800 text-white p-6 rounded-2xl max-w-md w-full border border-slate-700 shadow-2xl animate-fade-in">
                                    <h3 className="text-xl font-black uppercase italic tracking-tighter mb-6">Fechar Ticket: {activeTicket.plate}</h3>
                                    <div className="space-y-4 mb-8">
                                        <div className="flex justify-between border-b border-slate-700 pb-2"><span className="text-slate-400 text-xs font-bold uppercase">Perman√™ncia</span><span className="font-bold">{activeTicket.durationHours}h {activeTicket.durationMins % 60}m</span></div>
                                        <div className="flex justify-between items-center"><span className="text-sm font-bold uppercase text-slate-400">Total a Pagar</span><span className="text-4xl font-black text-emerald-400 tracking-tighter">{formatCurrency(activeTicket.total)}</span></div>
                                        <div className="pt-4"><label className="text-[10px] font-black text-slate-500 uppercase mb-2 block">M√©todo de Pagamento</label>
                                            <select className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white outline-none focus:border-cyan-500" value={paymentMethod} onChange={e=>setPaymentMethod(e.target.value)}>
                                                <option>Dinheiro</option><option>PIX</option><option>Cart√£o Cr√©dito</option><option>Cart√£o D√©bito</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={()=>setModal(null)} className="flex-1 bg-slate-700 py-4 rounded-xl font-black uppercase text-xs">Cancelar</button>
                                        <button onClick={confirmExit} className="flex-1 bg-emerald-600 py-4 rounded-xl font-black uppercase text-xs shadow-lg shadow-emerald-900/20 active:scale-95 transition-all">Confirmar e Finalizar</button>
                                    </div>
                                </div>
                            )}

                            {modal === 'finance' && (
                                <div className="bg-slate-800 w-full max-w-md p-8 rounded-2xl border border-slate-700 shadow-2xl">
                                    <h3 className="text-xl font-black text-white mb-6 uppercase tracking-tighter italic">Novo Lan√ßamento no Cofre</h3>
                                    <div className="space-y-4">
                                        <select className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white" value={financeForm.type} onChange={e=>setFinanceForm({...financeForm, type:e.target.value})}><option>Receita</option><option>Despesa</option></select>
                                        <input className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white" placeholder="Descri√ß√£o" value={financeForm.description} onChange={e=>setFinanceForm({...financeForm, description:e.target.value})} />
                                        <input className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white" type="number" placeholder="Valor (R$)" value={financeForm.value} onChange={e=>setFinanceForm({...financeForm, value:parseFloat(e.target.value)})} />
                                        <input className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white" type="date" value={financeForm.date} onChange={e=>setFinanceForm({...financeForm, date:e.target.value})} />
                                    </div>
                                    <div className="flex justify-end gap-4 mt-8">
                                        <button onClick={()=>setModal(null)} className="text-slate-500 font-bold text-xs uppercase">Cancelar</button>
                                        <button onClick={saveFinance} className="bg-emerald-600 text-white px-8 py-3 rounded-xl font-black uppercase text-xs shadow-lg">Salvar no Cofre</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
