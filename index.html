<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parking Pro - Gestão de Estacionamento & Lava-rápido</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tesseract.js para OCR (Leitura de Placas) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Firebase App (o núcleo do SDK do Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <!-- Firebase Firestore (o banco de dados) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; user-select: none; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            .no-print { display: none !important; }
        }
        .ticket-paper { font-family: 'Courier New', Courier, monospace; width: 300px; margin: 0 auto; background: #fff; color: #000; padding: 10px; text-align: center; border: 1px dashed #ccc; }
        .ticket-divider { border-bottom: 1px dashed #000; margin: 10px 0; }
        .os-paper { font-family: 'Arial', sans-serif; width: 100%; background: #fff; color: #000; padding: 20px; border: 1px solid #000; }
        .barcode { height: 40px; width: 100%; background-image: linear-gradient(90deg, #000 2%, transparent 2%, transparent 4%, #000 4%, #000 5%, transparent 5%, transparent 6%, #000 6%, #000 8%, transparent 8%, transparent 9%, #000 9%, #000 12%, transparent 12%, transparent 13%, #000 13%, #000 15%, transparent 15%, transparent 16%, #000 16%, #000 19%, transparent 19%, transparent 20%, #000 20%, #000 23%, transparent 23%, transparent 24%, #000 24%, #000 25%, transparent 25%, transparent 26%, #000 26%, #000 29%, transparent 29%, transparent 30%, #000 30%, #000 31%, transparent 31%, transparent 32%, #000 32%, #000 35%, transparent 35%, transparent 36%, #000 36%, #000 38%, transparent 38%, transparent 39%, #000 39%, #000 42%, transparent 42%, transparent 43%, #000 43%, #000 45%, transparent 45%, transparent 46%, #000 46%); background-size: 100% 100%; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator, input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- COMPONENTE TOAST (Notificações) ---
        const Toast = ({ message, type, show, onClose }) => {
            if (!show) return null;
            const colors = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-emerald-600' : 'bg-cyan-600');
            return (
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 md:left-auto md:translate-x-0 md:right-4 ${colors} text-white px-6 py-4 rounded-lg shadow-2xl z-[70] flex items-center gap-3 animate-fade-in w-[90%] md:w-auto`}>
                    <i className="ph-fill ph-info text-xl"></i>
                    <span className="font-bold text-sm md:text-base">{message}</span>
                </div>
            );
        };

        // --- CHART COMPONENT ---
        const ParkingChart = ({ historyData, financeData }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                if (chartRef.current) chartRef.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                const last7Days = [...Array(7)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toLocaleDateString('pt-BR');
                }).reverse();

                const parkingRevenue = last7Days.map(date => {
                    return (Array.isArray(historyData) ? historyData : []).filter(h => h && h.exitTime && new Date(h.exitTime).toLocaleDateString('pt-BR') === date)
                                .reduce((acc, curr) => acc + (Number(curr.total) || 0), 0);
                });

                const expensesData = last7Days.map(date => {
                    return (Array.isArray(financeData) ? financeData : []).filter(f => f && f.type === 'Despesa' && f.date && new Date(f.date + 'T12:00:00').toLocaleDateString('pt-BR') === date)
                                .reduce((acc, curr) => acc + (Number(curr.value) || 0), 0);
                });

                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: last7Days,
                        datasets: [
                            { label: 'Receita', data: parkingRevenue, backgroundColor: '#0891b2', borderRadius: 4 },
                            { label: 'Despesas', data: expensesData, backgroundColor: '#ef4444', borderRadius: 4 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } } }
                });
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [historyData, financeData]);

            return <div className="h-64 w-full"><canvas ref={canvasRef}></canvas></div>;
        };

        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
        const BrandLogo = () => (<div className="flex items-center gap-2"><div className="w-8 h-8 md:w-10 md:h-10 bg-cyan-500 rounded flex items-center justify-center shadow-lg"><i className="ph-fill ph-car text-white text-xl md:text-2xl"></i></div><div><h1 className="text-lg md:text-xl font-black italic text-white leading-none">PARKING<span className="text-cyan-400">PRO</span></h1></div></div>);

        // --- LOGIN SCREEN ---
        const LoginScreen = ({ onLogin }) => {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            useEffect(() => {
                const user = localStorage.getItem('parkingpro_user');
                const pass = localStorage.getItem('parkingpro_pass');
                if (user && pass) { setU(user); setP(pass); }
            }, []);
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950 p-4">
                    <div className="bg-slate-900 p-8 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-800">
                        <div className="flex justify-center mb-6"><BrandLogo /></div>
                        <form onSubmit={(e) => {e.preventDefault(); onLogin(u, p, true);}} className="space-y-4">
                            <input className="w-full p-3 bg-slate-950 border border-slate-800 rounded text-white" placeholder="Usuário" value={u} onChange={e=>setU(e.target.value)} />
                            <input type="password" className="w-full p-3 bg-slate-950 border border-slate-800 rounded text-white" placeholder="Senha" value={p} onChange={e=>setP(e.target.value)} />
                            <button className="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded">ABRIR SISTEMA</button>
                        </form>
                        <div className="text-center mt-4 text-xs text-slate-500">Admin / 1234</div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [view, setView] = useState('login');
            const [toast, setToast] = useState({ show: false, msg: '', type: 'info' });
            const notify = (msg, type='success') => { 
                setToast(prev => ({ ...prev, show: true, msg, type })); 
                setTimeout(() => setToast(prev => ({ ...prev, show: false })), 3000); 
            };

            // SUA CONFIGURAÇÃO DO FIREBASE (FIXA)
            const FIREBASE_CONFIG = {
                apiKey: "AIzaSyDYdrt4kbKtyPbx7ipHHb7wftUAlKeOZeE",
                authDomain: "estacionamento-332eb.firebaseapp.com",
                projectId: "estacionamento-332eb",
                storageBucket: "estacionamento-332eb.firebasestorage.app",
                messagingSenderId: "467691522256",
                appId: "1:467691522256:web:6d4495458c494e753cb6d5"
            };

            const [db, setDb] = useState(null);
            const [isOnline, setIsOnline] = useState(false);

            // Dados
            const [tickets, setTickets] = useState([]);
            const [history, setHistory] = useState([]);
            const [finances, setFinances] = useState([]);
            const [subscribers, setSubscribers] = useState([]);
            const [clients, setClients] = useState([]);
            const [team, setTeam] = useState([]);
            const [suppliers, setSuppliers] = useState([]);
            const [servicesList, setServicesList] = useState([]);
            const [agreements, setAgreements] = useState([]);
            const [config, setConfig] = useState({ name: 'Estacionamento', totalSpots: 50, priceCarHour: 10, priceMotoHour: 5, toleranceMin: 15, dailyRate: 50 });

            // UI
            const [tab, setTab] = useState('dashboard');
            const [modal, setModal] = useState(null);
            const [activeTicket, setActiveTicket] = useState(null);
            const [filterPlate, setFilterPlate] = useState('');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [loadingCamera, setLoadingCamera] = useState(false);

            // Formulários
            const [entryForm, setEntryForm] = useState({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] });
            const [financeForm, setFinanceForm] = useState({ type: 'Despesa', description: '', value: 0, date: '', category: 'Geral' });
            const [clientForm, setClientForm] = useState({ name: '', phone: '', plate: '', points: 0, notes: '' });
            const [supplierForm, setSupplierForm] = useState({ name: '', contact: '', category: 'Peças', notes: '' });
            const [teamForm, setTeamForm] = useState({ name: '', role: 'Operador', shift: 'Manhã', phone: '' });
            const [serviceConfigForm, setServiceConfigForm] = useState({ name: '', price: 0 });
            const [agreementForm, setAgreementForm] = useState({ name: '', discountType: 'free_time', value: 0 });
            const [checklistForm, setChecklistForm] = useState({ plate: '', model: '', fuel: '1/2', items: [], notes: '' });
            const [subscriberForm, setSubscriberForm] = useState({ name: '', plate: '', model: '', plan: 'Integral', dueDay: 10, active: true });
            
            // Edição
            const [editingId, setEditingId] = useState(null);
            const [editTicketForm, setEditTicketForm] = useState(null);
            const [paymentMethod, setPaymentMethod] = useState('Dinheiro');
            const [addServiceForm, setAddServiceForm] = useState({ ticketId: null, selectedServices: [] });

            const commonDamages = ['Arranhões', 'Amassados', 'Vidro Trincado', 'Farol Quebrado', 'Pneu Murcho', 'Antena Quebrada', 'Retrovisor Danif.'];
            const tabNames = { dashboard: 'Visão Geral', patio: 'Pátio & Entrada', carwash: 'Lava-rápido', finance: 'Financeiro', suppliers: 'Fornecedores', team: 'Equipe', clients: 'Fidelidade', subscribers: 'Mensalistas', agreements: 'Convênios', config: 'Configurações' };

            // Inicialização Firebase
            useEffect(() => {
                if (!firebase.apps.length) {
                    try {
                        firebase.initializeApp(FIREBASE_CONFIG);
                        setDb(firebase.firestore());
                        setIsOnline(true);
                    } catch (e) { console.error("Erro Firebase", e); setIsOnline(false); }
                } else {
                    setDb(firebase.firestore());
                    setIsOnline(true);
                }
            }, []);

            // Hook de Sincronização
            const useSync = (colName, setFn) => {
                useEffect(() => {
                    if (db) {
                        return db.collection(colName).onSnapshot(snap => {
                            const data = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                            setFn(data);
                        }, err => console.log("Sync wait/offline", err));
                    } else if (view === 'app') {
                        try {
                            const local = localStorage.getItem(`parkingpro_${colName}`);
                            if (local) setFn(JSON.parse(local));
                        } catch(e) { console.error("Erro localStorage", e); }
                    }
                }, [db, view]);
            };

            // Sincronizar todas as coleções
            useSync('tickets', setTickets);
            useSync('history', setHistory);
            useSync('finances', setFinances);
            useSync('subscribers', setSubscribers);
            useSync('clients', setClients);
            useSync('team', setTeam);
            useSync('suppliers', setSuppliers);
            useSync('servicesList', setServicesList);
            useSync('agreements', setAgreements);

            useEffect(() => {
                const savedConfig = localStorage.getItem('parkingpro_config');
                if (savedConfig) try { setConfig(JSON.parse(savedConfig)); } catch(e){}
            }, []);

            // Salvar Universal
            const saveItem = async (col, item, idOverwrite) => {
                const id = idOverwrite ? String(idOverwrite) : String(item.id || Date.now());
                const data = { ...item, id: id };
                
                // Atualização Otimista (Visual)
                if (!db) {
                    // Se offline, salvar no localStorage via Effect dos dados
                    // Aqui apenas atualizamos o estado local para parecer rápido
                    // (O Effect de localStorage fará a persistência real)
                }

                if (db) {
                    try {
                        await db.collection(col).doc(id).set(data);
                    } catch (e) { notify('Erro ao salvar na nuvem (mas salvo local)', 'error'); }
                }
                return data;
            };

            const deleteItem = async (col, id) => {
                if (db) await db.collection(col).doc(String(id)).delete();
            };

            // LocalStorage Backup
            useEffect(() => {
                if(view === 'app') {
                    const saveData = (k, v) => localStorage.setItem(`parkingpro_${k}`, JSON.stringify(v));
                    saveData('tickets', tickets); saveData('history', history); saveData('finances', finances);
                    saveData('subscribers', subscribers); saveData('clients', clients); saveData('team', team);
                    saveData('suppliers', suppliers); saveData('servicesList', servicesList); saveData('agreements', agreements);
                    saveData('config', config);
                }
            }, [tickets, history, finances, subscribers, clients, team, suppliers, servicesList, agreements, config]);

            // Handlers
            const handleLogin = (u, p, remember) => {
                if (u === 'admin' && p === '1234') { // Login Simplificado
                    if(remember) { localStorage.setItem('parkingpro_user', u); localStorage.setItem('parkingpro_pass', p); }
                    setView('app');
                } else notify('Senha incorreta', 'error');
            };

            const handleFileScan = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoadingCamera(true); notify('Lendo imagem...');
                try {
                    const { data: { text } } = await Tesseract.recognize(file, 'eng');
                    const clean = text.replace(/[^A-Z0-9]/ig, '').toUpperCase();
                    const match = clean.match(/[A-Z]{3}[0-9][A-Z0-9][0-9]{2}/) || clean.match(/[A-Z]{3}[0-9]{4}/);
                    if (match) { setEntryForm(p => ({...p, plate: match[0]})); notify('Placa encontrada!'); }
                    else notify('Placa não identificada', 'error');
                } catch(err) { notify('Erro na leitura', 'error'); }
                finally { setLoadingCamera(false); }
            };

            // Ações Específicas
            const handleEntry = () => {
                if(!entryForm.plate) return notify('Digite a placa', 'error');
                const newItem = { ...entryForm, id: Date.now(), entryTime: (entryForm.manualEntry || new Date()).toString(), services: [], status: 'active', plate: entryForm.plate.toUpperCase() };
                
                if (entryForm.manualExit) {
                    const exitTime = new Date(entryForm.manualExit);
                    const entryTime = new Date(newItem.entryTime);
                    if (exitTime <= entryTime) return notify('Saída anterior à entrada', 'error');
                    // Calculo simples para manual
                    newItem.exitTime = exitTime.toString();
                    newItem.status = 'finished';
                    newItem.total = 0; // Simplificado, ideal calcular
                    saveItem('history', newItem);
                    if(!db) setHistory(prev => [newItem, ...prev]);
                    notify('Histórico adicionado');
                } else {
                    saveItem('tickets', newItem);
                    if(!db) setTickets(prev => [...prev, newItem]);
                    notify('Veículo estacionado');
                    setActiveTicket(newItem);
                    setModal('print_entry');
                }
                setEntryForm({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] });
            };

            const handleFinanceSave = () => {
                const item = { ...financeForm, value: parseFloat(financeForm.value) || 0 };
                const id = editingId || Date.now();
                saveItem('finances', { ...item, id });
                if(!db) setFinances(prev => editingId ? prev.map(f => f.id === id ? {...item, id} : f) : [{...item, id}, ...prev]);
                setModal(null); notify('Salvo!');
            };

            const handleDelete = (col, id, setFn) => {
                if(confirm('Tem certeza?')) {
                    deleteItem(col, id);
                    if(!db) setFn(prev => prev.filter(i => i.id !== id));
                    notify('Removido');
                }
            };

            const stats = useMemo(() => {
                const occ = tickets.length;
                const rev = (Array.isArray(finances) ? finances : []).filter(f => f.type === 'Receita').reduce((a, b) => a + (Number(b.value) || 0), 0);
                const exp = (Array.isArray(finances) ? finances : []).filter(f => f.type === 'Despesa').reduce((a, b) => a + (Number(b.value) || 0), 0);
                // Soma receitas de tickets do dia também
                const todayTickets = (Array.isArray(history) ? history : []).filter(h => new Date(h.exitTime).toLocaleDateString() === new Date().toLocaleDateString())
                                    .reduce((a,b) => a + (Number(b.total) || 0), 0);
                return { occupied: occ, free: config.totalSpots - occ, totalRevenue: rev + todayTickets, expenses: exp, balance: (rev + todayTickets) - exp };
            }, [tickets, finances, history, config]);

            if (view === 'login') return <LoginScreen onLogin={handleLogin} />;

            return (
                <div className="flex h-screen bg-slate-900 text-slate-100 font-sans overflow-hidden">
                    <Toast {...toast} onClose={()=>setToast(p=>({...p, show:false}))} />
                    
                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 z-50 w-64 bg-slate-950 transition-transform ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0`}>
                        <div className="p-6 border-b border-slate-800 flex justify-between items-center"><BrandLogo /><button className="md:hidden" onClick={()=>setIsMobileMenuOpen(false)}><i className="ph-bold ph-x text-2xl"></i></button></div>
                        <nav className="p-4 space-y-1 overflow-y-auto h-full">
                            {Object.keys(tabNames).map(key => (
                                <button key={key} onClick={()=>{setTab(key); setIsMobileMenuOpen(false);}} className={`w-full flex items-center gap-3 px-4 py-3 rounded transition ${tab===key ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}>
                                    <span className="capitalize">{tabNames[key]}</span>
                                </button>
                            ))}
                            <div className="mt-8 p-4 text-center text-xs text-slate-600">
                                {isOnline ? <span className="text-emerald-500">● Online (Nuvem)</span> : <span className="text-orange-500">● Offline (Local)</span>}
                            </div>
                        </nav>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col relative w-full overflow-hidden">
                        <header className="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6">
                            <button className="md:hidden" onClick={()=>setIsMobileMenuOpen(true)}><i className="ph-bold ph-list text-2xl"></i></button>
                            <h2 className="text-xl font-bold uppercase">{tabNames[tab]}</h2>
                            <div className="text-right"><p className="text-xs text-slate-400">Vagas</p><p className={`text-xl font-bold ${stats.free < 5 ? 'text-red-500' : 'text-emerald-400'}`}>{stats.free}</p></div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-6">
                            {tab === 'dashboard' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div className="bg-slate-800 p-4 rounded border-t-4 border-cyan-500"><h3>Ocupação</h3><p className="text-2xl font-bold">{stats.occupied}</p></div>
                                        <div className="bg-slate-800 p-4 rounded border-t-4 border-emerald-500"><h3>Receita</h3><p className="text-2xl font-bold text-emerald-400">{formatCurrency(stats.totalRevenue)}</p></div>
                                        <div className="bg-slate-800 p-4 rounded border-t-4 border-red-500"><h3>Despesas</h3><p className="text-2xl font-bold text-red-400">{formatCurrency(stats.expenses)}</p></div>
                                        <div className="bg-slate-800 p-4 rounded border-t-4 border-blue-500"><h3>Balanço</h3><p className="text-2xl font-bold text-blue-400">{formatCurrency(stats.balance)}</p></div>
                                    </div>
                                    <div className="bg-slate-800 p-4 rounded border border-slate-700"><ParkingChart historyData={history} financeData={finances} /></div>
                                </div>
                            )}

                            {tab === 'patio' && (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in h-full">
                                    <div className="bg-slate-800 p-6 rounded h-fit">
                                        <h3 className="font-bold text-xl mb-4">Nova Entrada</h3>
                                        <div className="space-y-3">
                                            <div className="flex gap-2">
                                                <input className="w-full bg-slate-900 p-3 rounded uppercase text-center text-xl font-bold" placeholder="ABC-1234" value={entryForm.plate} onChange={e=>setEntryForm({...entryForm, plate:e.target.value})} />
                                                <label className="bg-slate-700 p-3 rounded cursor-pointer"><i className="ph-bold ph-camera text-xl"></i><input type="file" className="hidden" onChange={handleFileScan} /></label>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={()=>setEntryForm({...entryForm, type:'Carro'})} className={`flex-1 py-2 rounded ${entryForm.type==='Carro'?'bg-cyan-600':'bg-slate-700'}`}>Carro</button>
                                                <button onClick={()=>setEntryForm({...entryForm, type:'Moto'})} className={`flex-1 py-2 rounded ${entryForm.type==='Moto'?'bg-cyan-600':'bg-slate-700'}`}>Moto</button>
                                            </div>
                                            <input className="w-full bg-slate-900 p-3 rounded" placeholder="Modelo" value={entryForm.model} onChange={e=>setEntryForm({...entryForm, model:e.target.value})} />
                                            <button onClick={handleEntry} className="w-full bg-emerald-600 py-3 rounded font-bold">Registrar Entrada</button>
                                        </div>
                                    </div>
                                    <div className="lg:col-span-2 space-y-3">
                                        <input className="w-full bg-slate-800 p-3 rounded" placeholder="Buscar placa..." value={filterPlate} onChange={e=>setFilterPlate(e.target.value.toUpperCase())} />
                                        {tickets.filter(t=>t.plate && t.plate.includes(filterPlate)).map(t => (
                                            <div key={t.id} className="bg-slate-800 p-4 rounded flex justify-between items-center border-l-4 border-cyan-500">
                                                <div><h4 className="font-bold text-lg">{t.plate}</h4><p className="text-sm text-slate-400">{t.model} - {new Date(t.entryTime).toLocaleTimeString()}</p></div>
                                                <button onClick={()=>{setActiveTicket(t); setModal('exit_confirm');}} className="bg-red-600 px-4 py-2 rounded font-bold">Saída</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {tab === 'finance' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="flex justify-end"><button onClick={()=>{setEditingId(null); setFinanceForm({type:'Despesa', description:'', value:0, date:new Date().toISOString().split('T')[0], category:'Geral'}); setModal('finance');}} className="bg-emerald-600 px-4 py-2 rounded font-bold">Novo Lançamento</button></div>
                                    <div className="bg-slate-800 rounded overflow-x-auto">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-900 text-slate-400"><tr><th className="p-3">Data</th><th className="p-3">Desc</th><th className="p-3">Tipo</th><th className="p-3">Valor</th><th className="p-3">Ações</th></tr></thead>
                                            <tbody>
                                                {(Array.isArray(finances) ? finances : []).concat(Array.isArray(history) ? history.map(h => ({...h, date: h.exitTime, description: `Ticket ${h.plate}`, type: 'Receita', value: h.total, isHistory: true})) : [])
                                                .sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 50).map((item, i) => (
                                                    <tr key={i} className="border-b border-slate-700">
                                                        <td className="p-3">{new Date(item.date).toLocaleDateString()}</td>
                                                        <td className="p-3">{item.description || item.desc}</td>
                                                        <td className="p-3"><span className={`px-2 py-1 rounded text-xs ${item.type==='Receita'?'bg-emerald-900 text-emerald-400':'bg-red-900 text-red-400'}`}>{item.type}</span></td>
                                                        <td className="p-3 font-bold">{formatCurrency(item.value)}</td>
                                                        <td className="p-3">
                                                            {!item.isHistory && (
                                                                <div className="flex gap-2">
                                                                    <button onClick={()=>{setFinanceForm(item); setEditingId(item.id); setModal('finance');}} className="text-blue-400"><i className="ph-bold ph-pencil"></i></button>
                                                                    <button onClick={()=>handleDelete('finances', item.id, setFinances)} className="text-red-400"><i className="ph-bold ph-trash"></i></button>
                                                                </div>
                                                            )}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* Configurações (Restaurada) */}
                            {tab === 'config' && (
                                <div className="space-y-6 animate-fade-in max-w-3xl mx-auto">
                                    <div className="bg-slate-800 p-6 rounded border border-slate-700">
                                        <h3 className="font-bold text-xl mb-4">Geral</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div><label className="text-xs block mb-1">Nome</label><input className="w-full bg-slate-900 p-2 rounded" value={config.name} onChange={e=>setConfig({...config, name:e.target.value})} /></div>
                                            <div><label className="text-xs block mb-1">Vagas</label><input type="number" className="w-full bg-slate-900 p-2 rounded" value={config.totalSpots} onChange={e=>setConfig({...config, totalSpots:e.target.value})} /></div>
                                            <div><label className="text-xs block mb-1">Preço Hora (Carro)</label><input type="number" className="w-full bg-slate-900 p-2 rounded" value={config.priceCarHour} onChange={e=>setConfig({...config, priceCarHour:e.target.value})} /></div>
                                            <div><label className="text-xs block mb-1">Preço Hora (Moto)</label><input type="number" className="w-full bg-slate-900 p-2 rounded" value={config.priceMotoHour} onChange={e=>setConfig({...config, priceMotoHour:e.target.value})} /></div>
                                        </div>
                                        <button onClick={()=>{localStorage.setItem('parkingpro_config', JSON.stringify(config)); notify('Salvo!');}} className="mt-4 bg-cyan-600 px-6 py-2 rounded font-bold">Salvar Configurações</button>
                                    </div>

                                    <div className="bg-slate-800 p-6 rounded border border-slate-700">
                                        <h3 className="font-bold text-xl mb-4">Catálogo de Serviços</h3>
                                        <div className="flex gap-2 mb-4">
                                            <input className="flex-1 bg-slate-900 p-2 rounded" placeholder="Nome do Serviço" value={serviceConfigForm.name} onChange={e=>setServiceConfigForm({...serviceConfigForm, name:e.target.value})} />
                                            <input className="w-24 bg-slate-900 p-2 rounded" type="number" placeholder="R$" value={serviceConfigForm.price} onChange={e=>setServiceConfigForm({...serviceConfigForm, price:e.target.value})} />
                                            <button onClick={()=>{
                                                const newItem = { ...serviceConfigForm, id: Date.now(), price: parseFloat(serviceConfigForm.price) || 0 };
                                                saveItem('servicesList', newItem);
                                                if(!db) setServicesList(prev => [...prev, newItem]);
                                                setServiceConfigForm({name:'', price:0}); notify('Serviço adicionado');
                                            }} className="bg-emerald-600 px-4 rounded font-bold">+</button>
                                        </div>
                                        <div className="space-y-2">
                                            {servicesList.map(s => (
                                                <div key={s.id} className="flex justify-between items-center bg-slate-900 p-3 rounded">
                                                    <span>{s.name}</span>
                                                    <div className="flex items-center gap-4">
                                                        <span className="font-bold text-emerald-400">{formatCurrency(s.price)}</span>
                                                        <button onClick={()=>handleDelete('servicesList', s.id, setServicesList)} className="text-red-400"><i className="ph-bold ph-trash"></i></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* MODALS */}
                    {modal === 'finance' && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 p-6 rounded w-full max-w-md">
                                <h3 className="font-bold text-xl mb-4">{editingId ? 'Editar' : 'Novo'} Lançamento</h3>
                                <div className="space-y-3">
                                    <select className="w-full bg-slate-900 p-3 rounded" value={financeForm.type} onChange={e=>setFinanceForm({...financeForm, type:e.target.value})}><option>Receita</option><option>Despesa</option></select>
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Descrição" value={financeForm.description} onChange={e=>setFinanceForm({...financeForm, description:e.target.value})} />
                                    <input type="number" className="w-full bg-slate-900 p-3 rounded" placeholder="Valor" value={financeForm.value} onChange={e=>setFinanceForm({...financeForm, value:e.target.value})} />
                                    <input type="date" className="w-full bg-slate-900 p-3 rounded" value={financeForm.date} onChange={e=>setFinanceForm({...financeForm, date:e.target.value})} />
                                </div>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button onClick={()=>setModal(null)} className="px-4 py-2 text-slate-400">Cancelar</button>
                                    <button onClick={handleFinanceSave} className="bg-emerald-600 px-4 py-2 rounded font-bold">Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {modal === 'print_entry' && activeTicket && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-white text-black p-4 rounded w-[320px]">
                                <div id="print-area" className="ticket-paper">
                                    <div className="font-bold text-lg uppercase">{config.name}</div>
                                    <div className="text-3xl font-mono font-bold my-4">{activeTicket.plate}</div>
                                    <div>{new Date(activeTicket.entryTime).toLocaleString()}</div>
                                </div>
                                <div className="flex gap-2 mt-4 no-print">
                                    <button onClick={()=>window.print()} className="flex-1 bg-blue-600 text-white py-2 rounded font-bold">Imprimir</button>
                                    <button onClick={()=>setModal(null)} className="flex-1 bg-slate-600 text-white py-2 rounded font-bold">Fechar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {modal === 'exit_confirm' && activeTicket && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 p-6 rounded w-full max-w-sm">
                                <h3 className="font-bold text-xl mb-4">Confirmar Saída</h3>
                                <div className="bg-slate-900 p-4 rounded mb-4 text-center">
                                    <div className="text-2xl font-bold font-mono mb-2">{activeTicket.plate}</div>
                                    <div className="text-slate-400">Permanência: {Math.ceil((new Date() - new Date(activeTicket.entryTime)) / 60000)} min</div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={()=>setModal(null)} className="flex-1 py-3 text-slate-400 font-bold">Cancelar</button>
                                    <button onClick={()=>{
                                        const exitTime = new Date();
                                        const durationMins = Math.ceil((exitTime - new Date(activeTicket.entryTime)) / 60000);
                                        const hours = Math.ceil(durationMins / 60);
                                        const total = hours * (activeTicket.type === 'Carro' ? config.priceCarHour : config.priceMotoHour);
                                        const finished = { ...activeTicket, exitTime: exitTime.toString(), durationMins, total, status: 'finished' };
                                        
                                        saveItem('history', finished);
                                        deleteItem('tickets', activeTicket.id);
                                        
                                        if(!db) {
                                            setTickets(p => p.filter(t => t.id !== activeTicket.id));
                                            setHistory(p => [finished, ...p]);
                                        }
                                        setModal(null); notify('Saída registrada!');
                                    }} className="flex-1 bg-red-600 text-white py-3 rounded font-bold">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
