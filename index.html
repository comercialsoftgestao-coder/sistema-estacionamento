<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parking Pro - Gestão de Estacionamento & Lava-rápido</title>
    
    <!-- PWA META TAGS (Implantado conforme GUIA APP.pdf) -->
    <meta name="theme-color" content="#0891b2">
    <meta name="description" content="Parking Pro - Gestão Inteligente de Estacionamento e Lava-rápido">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Parking Pro">
    
    <!-- ÍCONE ATUALIZADO CONFORME PEDIDO -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/256/75/75905.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tesseract.js para OCR (Leitura de Placas) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Crypto JS para Cofre Digital -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- Firebase App & Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Scrollbar Dark */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Animações */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        /* Estilos de Impressão (Tickets) */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            .no-print { display: none !important; }
        }

        /* Ticket Style (Papel Térmico) */
        .ticket-paper {
            font-family: 'Courier New', Courier, monospace;
            width: 300px; /* Largura padrão impressora térmica */
            margin: 0 auto;
            background: #fff;
            color: #000;
            padding: 10px;
            text-align: center;
            border: 1px dashed #ccc;
        }

        .ticket-divider { border-bottom: 1px dashed #000; margin: 10px 0; }

        /* Estilo Ordem de Serviço A4/A5 */
        .os-paper {
            font-family: 'Arial', sans-serif;
            width: 100%;
            background: #fff;
            color: #000;
            padding: 20px;
            border: 1px solid #000;
        }

        /* Código de Barras CSS Simples */
        .barcode {
            height: 40px;
            width: 100%;
            background-image: linear-gradient(90deg, 
                #000 2%, transparent 2%, transparent 4%, #000 4%, #000 5%, transparent 5%, transparent 6%, #000 6%, 
                #000 8%, transparent 8%, transparent 9%, #000 9%, #000 12%, transparent 12%, transparent 13%, #000 13%, 
                #000 15%, transparent 15%, transparent 16%, #000 16%, #000 19%, transparent 19%, transparent 20%, #000 20%,
                #000 23%, transparent 23%, transparent 24%, #000 24%, #000 25%, transparent 25%, transparent 26%, #000 26%,
                #000 29%, transparent 29%, transparent 30%, #000 30%, #000 31%, transparent 31%, transparent 32%, #000 32%,
                #000 35%, transparent 35%, transparent 36%, #000 36%, #000 38%, transparent 38%, transparent 39%, #000 39%,
                #000 42%, transparent 42%, transparent 43%, #000 43%, #000 45%, transparent 45%, transparent 46%, #000 46%
            );
            background-size: 100% 100%;
        }
        
        /* Custom Input Date Dark Mode */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator, input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
    
    <!-- MANIFEST ESTÁTICO SIMPLIFICADO -->
    <script>
        (function() {
            const manifestData = {
                "name": "Parking Pro",
                "short_name": "ParkingPro",
                "start_url": window.location.href.split('?')[0],
                "display": "standalone",
                "background_color": "#0f172a",
                "theme_color": "#0891b2",
                "icons": [{"src": "https://cdn-icons-png.flaticon.com/256/75/75905.png", "sizes": "256x256", "type": "image/png"}]
            };
            try {
                const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
                const manifestURL = URL.createObjectURL(manifestBlob);
                const manifestLink = document.createElement('link');
                manifestLink.rel = 'manifest';
                manifestLink.href = manifestURL;
                document.head.appendChild(manifestLink);
            } catch(e) { console.log('Manifest skip'); }
        })();
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- SISTEMA DE COFRE DIGITAL (Encryption) ---
        const Security = {
            encrypt: (data, key) => {
                if (!data || !key) return data;
                try {
                    return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
                } catch (e) { console.error("Erro criptografia", e); return data; }
            },
            decrypt: (ciphertext, key) => {
                if (!ciphertext || !key) return ciphertext;
                try {
                    const bytes = CryptoJS.AES.decrypt(ciphertext, key);
                    const decryptedData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    return decryptedData;
                } catch (e) { 
                    return ciphertext; 
                }
            }
        };

        // --- COMPONENTE TOAST ---
        const Toast = ({ message, type, show, onClose }) => {
            if (!show) return null;
            const colors = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-emerald-600' : (type === 'info' ? 'bg-blue-600' : 'bg-cyan-600'));
            return (
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 md:left-auto md:translate-x-0 md:right-4 ${colors} text-white px-6 py-4 rounded-lg shadow-2xl z-[70] flex items-center gap-3 animate-fade-in w-[90%] md:w-auto`}>
                    <i className="ph-fill ph-info text-xl"></i>
                    <span className="font-bold text-sm md:text-base">{message}</span>
                </div>
            );
        };

        // --- COMPONENTE CHART ---
        const ParkingChart = ({ historyData, financeData }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                if (chartRef.current) chartRef.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                
                const last7Days = [...Array(7)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toLocaleDateString('pt-BR');
                }).reverse();

                const parkingRevenue = last7Days.map(date => {
                    return (Array.isArray(historyData) ? historyData : []).filter(h => new Date(h.exitTime).toLocaleDateString('pt-BR') === date)
                                .reduce((acc, curr) => acc + (curr.total || 0), 0);
                });

                const expensesData = last7Days.map(date => {
                    return (Array.isArray(financeData) ? financeData : []).filter(f => f.type === 'Despesa' && new Date(f.date + 'T12:00:00').toLocaleDateString('pt-BR') === date)
                                .reduce((acc, curr) => acc + (curr.value || 0), 0);
                });

                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: last7Days,
                        datasets: [
                            { label: 'Receita', data: parkingRevenue, backgroundColor: '#0891b2', borderRadius: 4 },
                            { label: 'Despesas', data: expensesData, backgroundColor: '#ef4444', borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', labels: { color: '#cbd5e1', font: { size: 10 } } } },
                        scales: {
                            y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', font: { size: 10 } } },
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } }
                        }
                    }
                });

                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [historyData, financeData]);

            return <div className="h-64 w-full"><canvas ref={canvasRef}></canvas></div>;
        };

        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
        const formatDate = (date) => new Date(date).toLocaleString('pt-BR');

        // COMPONENTE LOGO DINÂMICA
        const BrandLogo = ({ title }) => {
            const displayText = title && title.trim() !== '' ? title : "PARKING PRO";
            const isDefault = displayText.toUpperCase() === 'PARKING PRO' || displayText.replace(/\s/g, '').toUpperCase() === 'PARKINGPRO';

            return (
                <div className="flex items-center gap-2">
                    <div className="w-8 h-8 md:w-10 md:h-10 bg-cyan-500 rounded flex items-center justify-center shadow-lg shadow-cyan-900/50 flex-shrink-0">
                        <i className="ph-fill ph-car text-white text-xl md:text-2xl"></i>
                    </div>
                    <div className="min-w-0">
                        {isDefault ? (
                            <h1 className="text-lg md:text-xl font-black italic tracking-tighter text-white leading-none whitespace-nowrap">PARKING<span className="text-cyan-400">PRO</span></h1>
                        ) : (
                            <h1 className="text-lg md:text-xl font-black italic tracking-tighter text-white leading-none uppercase truncate max-w-[180px]">{displayText}</h1>
                        )}
                        <p className="text-[8px] md:text-[9px] text-slate-400 font-bold uppercase tracking-widest">Sistema Inteligente</p>
                    </div>
                </div>
            );
        };

        // --- NOVA TELA DE IDENTIDADE (LOGIN ÚNICO) ---
        const IdentityScreen = ({ onAuthenticate }) => {
            const [mode, setMode] = useState('login'); 
            const [formData, setFormData] = useState({ username: '', password: '', confirmPassword: '', email: '' });
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [isMasterConfigured, setIsMasterConfigured] = useState(localStorage.getItem('parkingpro_master_registered') === 'true');

            useEffect(() => {
                const savedUser = localStorage.getItem('parkingpro_user_session');
                const savedKey = localStorage.getItem('parkingpro_user_key');
                if (savedUser && savedKey) {
                    onAuthenticate(JSON.parse(savedUser), savedKey);
                }
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                const safeUsername = formData.username.trim().toLowerCase().replace(/[^a-z0-9]/g, '');

                if (!safeUsername || safeUsername.length < 3) {
                    setError('Usuário deve ter pelo menos 3 caracteres alfanuméricos.');
                    setLoading(false);
                    return;
                }

                // TRAVA MASTER: Se já existe administrador, bloqueia outros logins
                if (isMasterConfigured) {
                    const masterName = localStorage.getItem('parkingpro_master_name');
                    if (safeUsername !== masterName && mode === 'login') {
                        setError('Acesso negado. Administrador Master Inválido.');
                        setLoading(false);
                        return;
                    }
                }

                if (formData.password.length < 4) {
                    setError('Senha deve ter pelo menos 4 caracteres.');
                    setLoading(false);
                    return;
                }

                // CORREÇÃO DEFINITIVA ERRO 400: Eliminando a chamada problemático de Auth por e-mail na nuvem
                // Usaremos login anônimo como camada de rede para o Firestore e o login local para o cofre.
                try {
                    const auth = firebase.auth();
                    if (!auth.currentUser) {
                        try {
                            await auth.signInAnonymously();
                        } catch (firebaseErr) {
                            console.warn("Nuvem Offline - Usando modo seguro local.");
                        }
                    }
                } catch (err) {
                    console.warn("Modo Seguro Offline.");
                }

                const userData = { username: safeUsername, email: formData.email, role: 'admin' };
                const encryptionKey = formData.password; 

                if (mode === 'register') {
                    localStorage.setItem('parkingpro_master_registered', 'true');
                    localStorage.setItem('parkingpro_master_name', safeUsername);
                    setIsMasterConfigured(true);
                }

                localStorage.setItem('parkingpro_user_session', JSON.stringify(userData));
                localStorage.setItem('parkingpro_user_key', encryptionKey);

                setLoading(false);
                onAuthenticate(userData, encryptionKey);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950 relative overflow-hidden px-4">
                    <div className="absolute inset-0 opacity-20" style={{backgroundImage: 'url("https://images.unsplash.com/photo-1621929747188-0b4dc28498d2?q=80&w=2072&auto=format&fit=crop")', backgroundSize: 'cover', backgroundPosition: 'center'}}></div>
                    <div className="bg-slate-900/95 backdrop-blur-xl p-8 rounded-2xl shadow-2xl w-full max-w-sm z-10 border border-slate-800">
                        <div className="flex justify-center mb-6"><BrandLogo title="IDENTIDADE" /></div>
                        
                        <div className="flex justify-center mb-6 bg-slate-800 p-1 rounded-lg">
                            <button onClick={()=>setMode('login')} className={`flex-1 py-2 text-xs font-bold rounded transition ${mode==='login' ? 'bg-cyan-600 text-white shadow' : 'text-slate-400'}`}>LOGIN MASTER</button>
                            {!isMasterConfigured && (
                                <button onClick={()=>setMode('register')} className={`flex-1 py-2 text-xs font-bold rounded transition ${mode==='register' ? 'bg-cyan-600 text-white shadow' : 'text-slate-400'}`}>ATIVAR MASTER</button>
                            )}
                        </div>

                        {error && <div className="bg-red-500/20 border border-red-500/50 text-red-200 text-xs p-3 rounded mb-4 flex items-center gap-2"><i className="ph-fill ph-warning"></i> {error}</div>}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Administrador Único</label>
                                <input className="w-full p-3 bg-slate-950 border border-slate-700 rounded text-sm text-white focus:border-cyan-500 outline-none transition" 
                                    placeholder="Seu usuário" value={formData.username} onChange={e=>setFormData({...formData, username:e.target.value})} />
                            </div>
                            
                            {mode === 'register' && (
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">E-mail Master (Recuperação)</label>
                                    <input className="w-full p-3 bg-slate-950 border border-slate-700 rounded text-sm text-white focus:border-cyan-500 outline-none transition" 
                                        type="email" placeholder="seu@email.com" value={formData.email} onChange={e=>setFormData({...formData, email:e.target.value})} />
                                </div>
                            )}

                            <div>
                                <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Chave de Segurança (Senha)</label>
                                <input type="password" university-none="true" className="w-full p-3 bg-slate-950 border border-slate-700 rounded text-sm text-white focus:border-cyan-500 outline-none transition" 
                                    placeholder="********" value={formData.password} onChange={e=>setFormData({...formData, password:e.target.value})} />
                            </div>

                            {mode === 'register' && (
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Confirmar Chave</label>
                                    <input type="password" university-none="true" className="w-full p-3 bg-slate-950 border border-slate-700 rounded text-sm text-white focus:border-cyan-500 outline-none transition" 
                                        placeholder="********" value={formData.confirmPassword} onChange={e=>setFormData({...formData, confirmPassword:e.target.value})} />
                                </div>
                            )}

                            <button disabled={loading} className="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded transition-all shadow-lg shadow-cyan-900/20 active:scale-95 flex items-center justify-center gap-2">
                                {loading ? <i className="ph-bold ph-spinner animate-spin"></i> : (mode === 'login' ? 'ABRIR SISTEMA' : 'ATIVAR INSTALAÇÃO')}
                            </button>
                        </form>
                        
                        <div className="mt-6 border-t border-slate-800 pt-4 text-center">
                            <p className="text-[10px] text-slate-500 flex items-center justify-center gap-1"><i className="ph-fill ph-shield-check"></i> Proteção Master Ativa</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP ---
        function App() {
            const [view, setView] = useState('identity'); 
            const [userRole, setUserRole] = useState('admin');
            const [currentUser, setCurrentUser] = useState(null); 
            const [encryptionKey, setEncryptionKey] = useState(null); 
            const [toast, setToast] = useState({ show: false, msg: '', type: 'info' });
            const notify = (msg, type='success') => { setToast({ show: true, msg, type }); setTimeout(()=>setToast({...toast, show: false}), 3000); };

            const [config, setConfig] = useState({ 
                name: '', 
                address: 'Configuração Pendente', 
                totalSpots: 50, 
                priceCarHour: 15.00, 
                priceMotoHour: 8.00, 
                toleranceMin: 15, 
                dailyRate: 60.00,
                requireLogin: true, 
                loginUser: 'admin',
                loginPass: '1234'
            });

            const [tickets, setTickets] = useState([]); 
            const [history, setHistory] = useState([]); 
            const [subscribers, setSubscribers] = useState([]); 
            const [agreements, setAgreements] = useState([]); 
            const [checklists, setChecklists] = useState([]); 
            const [finances, setFinances] = useState([]); 
            const [team, setTeam] = useState([]); 
            const [clients, setClients] = useState([]); 
            const [suppliers, setSuppliers] = useState([]); 
            const [servicesList, setServicesList] = useState([]);

            const [tab, setTab] = useState('dashboard');
            const [modal, setModal] = useState(null);
            const [activeTicket, setActiveTicket] = useState(null); 
            const [filterPlate, setFilterPlate] = useState('');
            const [paymentMethod, setPaymentMethod] = useState('Dinheiro');
            const [editClient, setEditClient] = useState(null);
            const [editSubscriber, setEditSubscriber] = useState(null);
            const [editSupplier, setEditSupplier] = useState(null);
            const [editingServiceId, setEditingServiceId] = useState(null);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false); 
            const [loadingCamera, setLoadingCamera] = useState(false);

            const [db, setDb] = useState(null);
            const [isOnline, setIsOnline] = useState(false);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'parking-pro-cloud-fixed-id';
            const defaultFirebaseConfig = {
                apiKey: "AIzaSyDYdrt4kbKtyPbx7ipHHb7wftUAlKeOZeE",
                authDomain: "estacionamento-332eb.firebaseapp.com",
                projectId: "estacionamento-332eb",
                storageBucket: "estacionamento-332eb.firebasestorage.app",
                messagingSenderId: "467691522256",
                appId: "1:467691522256:web:6d4495458c494e753cb6d5"
            };
            
            const [entryForm, setEntryForm] = useState({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] });
            const [agreementForm, setAgreementForm] = useState({ name: '', discountType: 'free_time', value: 0 });
            const [checklistForm, setChecklistForm] = useState({ plate: '', model: '', fuel: '1/2', items: [], notes: '', date: '' });
            const [financeForm, setFinanceForm] = useState({ type: 'Despesa', description: '', value: 0, date: '', category: 'Geral', file: null, fileName: '' });
            const [teamForm, setTeamForm] = useState({ name: '', role: 'Operador', shift: 'Manhã', phone: '' });
            const [serviceConfigForm, setServiceConfigForm] = useState({ name: '', price: 0 });
            const [addServiceForm, setAddServiceForm] = useState({ ticketId: '', selectedServices: [] });
            const [clientForm, setClientForm] = useState({ name: '', phone: '', plate: '', points: 0, notes: '' });
            const [supplierForm, setSupplierForm] = useState({ name: '', contact: '', category: 'Peças', notes: '' });
            const [subscriberForm, setSubscriberForm] = useState({ name: '', plate: '', model: '', plan: 'Integral', dueDay: 10, active: true });
            const [passwordForm, setPasswordForm] = useState({ current: '', new: '', confirm: '' });
            const [editTicketForm, setEditTicketForm] = useState({ plate: '', model: '', type: 'Carro', notes: '' });

            const commonDamages = ['Arranhões', 'Amassados', 'Vidro Trincado', 'Farol Quebrado', 'Pneu Murcho', 'Antena Quebrada', 'Retrovisor Danif.'];

            const tabNames = {
                dashboard: 'Visão Geral',
                patio: 'Pátio & Entrada',
                carwash: 'Lava-rápido',
                finance: 'Financeiro',
                suppliers: 'Fornecedores',
                team: 'Equipe',
                clients: 'Fidelidade',
                subscribers: 'Mensalistas',
                agreements: 'Convênios',
                config: 'Configurações'
            };

            const hardAppReset = async () => {
                if (confirm("Executar rotina de MANUTENÇÃO? Isso recarregará as ferramentas do sistema.")) {
                    try {
                        if ('serviceWorker' in navigator) {
                            const registrations = await navigator.serviceWorker.getRegistrations();
                            for (let reg of registrations) { await reg.unregister(); }
                        }
                        if ('caches' in window) {
                            const cacheNames = await caches.keys();
                            await Promise.all(cacheNames.map(name => caches.delete(name)));
                        }
                        window.location.reload(true);
                    } catch (e) { window.location.reload(); }
                }
            };

            // --- INICIALIZAÇÃO FIREBASE SEGURA ---
            useEffect(() => {
                const initFirebase = async () => {
                    const configToUse = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : defaultFirebaseConfig;
                    if (!firebase.apps.length) {
                        try {
                            firebase.initializeApp(configToUse);
                        } catch (e) { console.error("Firebase Init", e); }
                    }
                    
                    try {
                        const firestore = firebase.firestore();
                        setDb(firestore);
                        setIsOnline(true);
                        
                        const auth = firebase.auth();
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token).catch(()=>null);
                        }
                    } catch(e) {
                        console.error("Firebase DB", e);
                        setIsOnline(false);
                    }
                };
                initFirebase();
            }, []);

            // --- PERSISTÊNCIA REFORÇADA ---
            useEffect(() => {
                if (currentUser && encryptionKey) {
                    const saveLocal = (key, data) => {
                        try {
                            const encrypted = Security.encrypt(data, encryptionKey);
                            localStorage.setItem(`parkingpro_secure_v3_${currentUser.username}_${key}`, encrypted);
                        } catch(e) { console.error("Erro backup local", e); }
                    };
                    
                    saveLocal('tickets', tickets);
                    saveLocal('history', history);
                    saveLocal('finances', finances);
                    saveLocal('subscribers', subscribers);
                    saveLocal('clients', clients);
                    saveLocal('team', team);
                    saveLocal('suppliers', suppliers);
                    saveLocal('agreements', agreements);
                    saveLocal('servicesList', servicesList);
                    saveLocal('config', config);
                }
            }, [tickets, history, finances, subscribers, clients, team, suppliers, agreements, servicesList, config, currentUser, encryptionKey]);

            // --- SINCRONIZAÇÃO HÍBRIDA ---
            const useSync = (collectionName, setState, fallbackData) => {
                useEffect(() => {
                    if (!currentUser || !encryptionKey) return;

                    const localKey = `parkingpro_secure_v3_${currentUser.username}_${collectionName}`;
                    const localData = localStorage.getItem(localKey);
                    if (localData) {
                        const decrypted = Security.decrypt(localData, encryptionKey);
                        if (decrypted) setState(decrypted);
                    } else if (fallbackData) {
                        setState(fallbackData);
                    }

                    if (db && isOnline) {
                        const unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`${currentUser.username}_${collectionName}`)
                            .onSnapshot(snapshot => {
                                const data = snapshot.docs.map(doc => {
                                    const rawData = doc.data();
                                    let decrypted = rawData;
                                    if (rawData.encryptedData) {
                                        decrypted = Security.decrypt(rawData.encryptedData, encryptionKey);
                                        if (!decrypted && rawData.encryptedData) {
                                            return { ...rawData, id: doc.id, decryptError: true };
                                        }
                                    }
                                    return { ...decrypted, id: doc.id };
                                }); 
                                if (data.length > 0) setState(data);
                            }, err => { console.warn(`Cloud offline para ${collectionName}`); });
                        return () => unsubscribe();
                    }
                }, [db, currentUser, encryptionKey, isOnline]);
            };

            useSync('tickets', setTickets, []);
            useSync('history', setHistory, []);
            useSync('finances', setFinances, []);
            useSync('subscribers', setSubscribers, []);
            useSync('clients', setClients, []);
            useSync('team', setTeam, []);
            useSync('suppliers', setSuppliers, []);
            useSync('agreements', setAgreements, []);
            useSync('servicesList', setServicesList, []);
            useSync('config', (data) => { if(data && data.length > 0) setConfig(data[0]); }, null);

            const saveItem = async (col, item, idOverride) => {
                if (!currentUser || !encryptionKey) { notify('Acesso Bloqueado', 'error'); return; }

                const id = idOverride ? String(idOverride) : String(item.id || Date.now());
                const itemToSave = { ...item, id: item.id || Date.now() };
                
                if (col === 'tickets') setTickets(prev => { const idx = prev.findIndex(i=>String(i.id)===id); return idx >= 0 ? prev.map(i=>String(i.id)===id?itemToSave:i) : [...prev, itemToSave] });
                if (col === 'history') setHistory(prev => { const idx = prev.findIndex(i=>String(i.id)===id); return idx >= 0 ? prev.map(i=>String(i.id)===id?itemToSave:i) : [itemToSave, ...prev] });
                if (col === 'finances') setFinances(prev => { const idx = prev.findIndex(i=>String(i.id)===id); return idx >= 0 ? prev.map(i=>String(i.id)===id?itemToSave:i) : [itemToSave, ...prev] });
                if (col === 'clients') setClients(prev => { const idx = prev.findIndex(i=>String(i.id)===id); return idx >= 0 ? prev.map(i=>String(i.id)===id?itemToSave:i) : [...prev, itemToSave] });

                if (db && isOnline) {
                    const encryptedPayload = {
                        encryptedData: Security.encrypt(itemToSave, encryptionKey),
                        updatedAt: new Date().toISOString(),
                        owner: currentUser.username
                    };
                    const securePathCollection = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`${currentUser.username}_${col}`);
                    try { await securePathCollection.doc(id).set(encryptedPayload); } catch(e) { console.warn('Falha na Nuvem.'); }
                }
            };

            const deleteItem = async (col, id) => {
                if (!currentUser) return;
                const strId = String(id);
                if (col === 'tickets') setTickets(prev => prev.filter(i => String(i.id) !== strId));
                if (col === 'history') setHistory(prev => prev.filter(i => String(i.id) !== strId));
                if (col === 'finances') setFinances(prev => prev.filter(i => String(i.id) !== strId));

                if (db && isOnline) {
                    const securePathCollection = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`${currentUser.username}_${col}`);
                    await securePathCollection.doc(strId).delete().catch(()=>null);
                }
            };

            const handleIdentityAuth = (user, key) => {
                setCurrentUser(user);
                setEncryptionKey(key);
                setView('app');
                notify(`Terminal Master Ativo`, 'success');
            };

            const handleLogout = () => {
                if(confirm("Deseja fechar o cofre master?")) {
                    localStorage.removeItem('parkingpro_user_session');
                    localStorage.removeItem('parkingpro_user_key');
                    setCurrentUser(null);
                    setEncryptionKey(null);
                    setView('identity');
                }
            };

            const handleFileScan = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoadingCamera(true); notify('Processando imagem...', 'info');
                try {
                    const { data: { text } } = await Tesseract.recognize(file, 'eng');
                    const cleanText = text.replace(/[^A-Z0-9]/ig, '').toUpperCase();
                    const match = cleanText.match(/[A-Z]{3}[0-9][A-Z0-9][0-9]{2}/) || cleanText.match(/[A-Z]{3}[0-9]{4}/);
                    if (match) { setEntryForm(prev => ({ ...prev, plate: match[0] })); notify(`Placa detectada: ${match[0]}`, 'success'); }
                    else { notify('Placa ilegível.', 'error'); }
                } catch (err) { notify('Erro OCR.', 'error'); }
                finally { setLoadingCamera(false); }
            };
            
            const handleEntry = () => { if (!entryForm.plate) return notify('Placa é obrigatória', 'error'); const entryDateObj = entryForm.manualEntry ? new Date(entryForm.manualEntry) : new Date(); const isSub = subscribers.find(s => s.plate === entryForm.plate.toUpperCase() && s.active); const loyaltyClient = clients.find(c => c.plate === entryForm.plate.toUpperCase()); if (loyaltyClient) { const updated = { ...loyaltyClient, points: (loyaltyClient.points || 0) + 1 }; saveItem('clients', updated, updated.id); notify(`Cliente Fidelidade: ${loyaltyClient.name}. +1 Ponto!`, 'success'); } const newTicket = { id: Date.now(), plate: entryForm.plate.toUpperCase(), model: entryForm.model, type: entryForm.type, entryTime: entryDateObj.toISOString(), isSubscriber: !!isSub, isLoyalty: !!loyaltyClient, loyaltyClientId: loyaltyClient ? loyaltyClient.id : null, subscriberName: isSub ? isSub.name : null, notes: entryForm.notes, damages: entryForm.damages || [], services: [], status: 'active' }; if (entryForm.manualExit) { const exitDateObj = new Date(entryForm.manualExit); if (exitDateObj <= entryDateObj) return notify('Saída deve ser após entrada.', 'error'); const diffMins = Math.floor((exitDateObj - entryDateObj) / 60000); const diffHours = Math.ceil(diffMins / 60); let total = 0; if (!isSub) { if (diffMins > config.toleranceMin) { const rate = entryForm.type === 'Carro' ? config.priceCarHour : config.priceMotoHour; total = diffHours >= 8 ? config.dailyRate : diffHours * rate; } } const historyItem = { ...newTicket, exitTime: exitDateObj.toISOString(), durationMins: diffMins, durationHours: diffHours, subTotal: total, total: total, paymentMethod: 'Dinheiro (Manual)', status: 'finished', isHistory: true }; saveItem('history', historyItem); setEntryForm({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] }); notify('Lançamento realizado!'); return; } saveItem('tickets', newTicket); setEntryForm({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] }); setActiveTicket(newTicket); setModal('print_entry'); notify('Veículo registrado!'); };
            const handleAddServices = () => { if(!addServiceForm.ticketId) return; const t = tickets.find(t => t.id === addServiceForm.ticketId); if(t) { const updated = { ...t, services: addServiceForm.selectedServices }; saveItem('tickets', updated, t.id); setModal(null); notify('Serviços atualizados!'); } };
            const toggleServiceSelection = (serviceId) => { const currentSelected = addServiceForm.selectedServices; const service = servicesList.find(s => s.id === serviceId); if (currentSelected.find(s => s.id === serviceId)) setAddServiceForm({...addServiceForm, selectedServices: currentSelected.filter(s => s.id !== serviceId)}); else setAddServiceForm({...addServiceForm, selectedServices: [...currentSelected, service]}); };
            const prepareExit = (ticket) => { const now = new Date(); const entry = new Date(ticket.entryTime); const diffMins = Math.floor((now - entry) / 60000); const diffHours = Math.ceil(diffMins / 60); let parkingFee = 0; if (!ticket.isSubscriber) { if (diffMins > config.toleranceMin) { const rate = ticket.type === 'Carro' ? config.priceCarHour : config.priceMotoHour; parkingFee = diffHours >= 8 ? config.dailyRate : diffHours * rate; } } const servicesFee = (ticket.services || []).reduce((acc, s) => acc + s.price, 0); const total = parkingFee + servicesFee; setActiveTicket({ ...ticket, exitTime: now.toISOString(), durationMins: diffMins, durationHours: diffHours, parkingFee: parkingFee, servicesFee: servicesFee, subTotal: total, total: total, appliedAgreement: null }); setPaymentMethod('Dinheiro'); setModal('confirm_exit'); };
            const confirmExit = () => { const finished = {...activeTicket, paymentMethod, status: 'finished', isHistory: true}; saveItem('history', finished); deleteItem('tickets', activeTicket.id); setModal('print_exit'); notify('Saída registrada!'); };
            const saveChecklist = () => { if(!checklistForm.plate) return notify('Placa obrigatória', 'error'); const newChecklist = { ...checklistForm, id: Date.now(), date: checklistForm.date || new Date().toISOString() }; saveItem('checklists', newChecklist); setChecklistForm({ plate: '', model: '', fuel: '1/2', items: [], notes: '', date: '' }); setModal(null); notify('Vistoria salva!'); };
            const saveFinance = () => { const val = parseFloat(financeForm.value); if (editingFinanceId) { if (editingItemIsHistory) { const original = history.find(h => h.id === editingFinanceId); if (original) { const updated = { ...original, total: val, exitTime: new Date(financeForm.date + 'T12:00:00').toISOString() }; saveItem('history', updated, editingFinanceId); } } else { const updated = { ...financeForm, id: editingFinanceId, value: val }; saveItem('finances', updated, editingFinanceId); } notify('Atualizado!'); } else { const newFinance = { ...financeForm, id: Date.now(), value: val }; saveItem('finances', newFinance); notify('Lançamento salvo!'); } setFinanceForm({ type: 'Despesa', description: '', value: 0, date: '', category: 'Geral', file: null, fileName: '' }); setModal(null); setEditingFinanceId(null); setEditingItemIsHistory(false); };
            const saveServiceConfig = () => { if(!serviceConfigForm.name) return notify('Nome obrigatório', 'error'); const price = parseFloat(serviceConfigForm.price); if (editingServiceId) { const updated = { ...serviceConfigForm, id: editingServiceId, price }; saveItem('servicesList', updated, editingServiceId); setEditingServiceId(null); setServiceConfigForm({ name: '', price: 0 }); notify('Serviço atualizado!'); } else { const newService = { ...serviceConfigForm, id: Date.now(), price }; saveItem('servicesList', newService); setServiceConfigForm({ name: '', price: 0 }); notify('Serviço adicionado!'); } };
            const stats = useMemo(() => { const occupied = tickets.length; const free = config.totalSpots - occupied; const ticketsRevenue = history.filter(h => new Date(h.exitTime).toDateString() === new Date().toDateString()).reduce((acc, curr) => acc + curr.total, 0); const extraRevenue = finances.filter(f => f.type === 'Receita' && new Date(f.date + 'T12:00:00').toDateString() === new Date().toDateString()).reduce((acc, curr) => acc + curr.value, 0); const expenses = finances.filter(f => f.type === 'Despesa' && new Date(f.date + 'T12:00:00').toDateString() === new Date().toDateString()).reduce((acc, curr) => acc + curr.value, 0); const totalRevenue = ticketsRevenue + extraRevenue; const balance = totalRevenue - expenses; return { occupied, free, totalRevenue, expenses, balance, activeSubscribers: subscribers.filter(s => s.active).length }; }, [tickets, history, subscribers, finances, config]);
            const saveConfig = () => { saveItem('config', config, 'main_config'); notify('Configurações salvas!'); };

            if (view === 'identity') return <IdentityScreen onAuthenticate={handleIdentityAuth} />;

            return (
                <div className="flex h-screen overflow-hidden bg-slate-900 text-slate-100 font-sans">
                    <Toast {...toast} onClose={()=>setToast({...toast, show:false})} />
                    
                    {isMobileMenuOpen && <div className="fixed inset-0 bg-black/50 z-40 md:hidden" onClick={() => setIsMobileMenuOpen(false)}></div>}

                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-950 transition-transform duration-300 ease-in-out md:relative md:translate-x-0 flex flex-col ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-slate-800 flex justify-between items-center">
                            <BrandLogo title={config.name} />
                            <button className="md:hidden text-slate-400" onClick={() => setIsMobileMenuOpen(false)}><i className="ph-bold ph-x text-2xl"></i></button>
                        </div>
                        <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                            {['dashboard', 'patio', 'carwash', 'finance', 'suppliers', 'team', 'clients', 'subscribers', 'agreements', 'config'].map(id => (
                                <button key={id} onClick={() => { setTab(id); setIsMobileMenuOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-sm font-bold ${tab === id ? 'bg-cyan-600 text-white shadow-lg shadow-cyan-900/50' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                    <i className={`ph ph-${id === 'dashboard' ? 'gauge' : id === 'patio' ? 'car-profile' : id === 'carwash' ? 'drop-half' : id === 'finance' ? 'currency-dollar' : id === 'suppliers' ? 'truck' : id === 'team' ? 'users' : id === 'clients' ? 'identification-card' : id === 'subscribers' ? 'users-three' : id === 'agreements' ? 'handshake' : 'gear'} text-xl`}></i> {tabNames[id]}
                                </button>
                            ))}
                        </nav>
                        
                        <div className="px-4 pb-4">
                             <button onClick={handleLogout} className="w-full bg-red-900/20 hover:bg-red-900/40 text-red-400 p-3 rounded-lg flex items-center justify-center gap-2 text-xs font-bold transition">
                                <i className="ph-bold ph-lock-key-open"></i> FECHAR COFRE MASTER
                             </button>
                        </div>

                        <div className="p-4 text-center text-xs text-slate-600 border-t border-slate-800">
                             <div className="flex flex-col gap-2 mb-2">
                                 <span className={`flex items-center justify-center gap-2 font-bold ${isOnline ? 'text-emerald-500 animate-pulse' : 'text-orange-500'}`}>
                                     <i className={`ph-fill ${isOnline ? 'ph-cloud-check' : 'ph-wifi-slash'} text-lg`}></i> {isOnline ? 'Cloud Cloud Ativo' : 'Cloud Master Offline'}
                                 </span>
                                 {currentUser && (
                                     <span className="flex items-center justify-center gap-2 text-cyan-500 font-bold bg-cyan-950/30 py-1 rounded">
                                         <i className="ph-fill ph-user-circle text-lg"></i> {currentUser.username}
                                     </span>
                                 )}
                             </div>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden relative w-full">
                        <header className="h-16 bg-slate-900/80 backdrop-blur border-b border-slate-800 flex items-center justify-between px-4 md:px-6 z-10">
                            <div className="flex items-center gap-3">
                                <button className="md:hidden text-slate-300" onClick={() => setIsMobileMenuOpen(true)}><i className="ph-bold ph-list text-2xl"></i></button>
                                <h2 className="text-lg md:text-xl font-bold text-white tracking-wide uppercase truncate">{tabNames[tab]}</h2>
                            </div>
                            <div className="text-right">
                                <p className="text-[10px] md:text-xs text-slate-400">Vagas Livres</p>
                                <p className={`text-lg md:text-xl font-black ${stats.free < 5 ? 'text-red-500' : 'text-emerald-400'}`}>{stats.free} <span className="text-xs md:text-sm font-normal text-slate-500">/ {config.totalSpots}</span></p>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-6 relative bg-slate-900">
                            
                            {/* DASHBOARD */}
                            {tab === 'dashboard' && (
                                <div className="space-y-6 animate-fade-in pb-10">
                                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                        <h3 className="font-bold text-xl text-white">Painel de Controle</h3>
                                        <div className="flex gap-2 w-full md:w-auto">
                                            <a href="https://wa.me/5511932186193" target="_blank" className="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold flex items-center justify-center gap-2 text-sm"><i className="ph-bold ph-whatsapp-logo"></i> Suporte</a>
                                            <button onClick={() => downloadDashboardReport(false)} className="flex-1 md:flex-none bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-bold flex items-center justify-center gap-2 text-sm"><i className="ph-bold ph-download"></i> Relatório</button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-cyan-500 shadow-lg"><p className="text-xs text-slate-400 uppercase font-bold">Ocupação</p><h3 className="text-3xl font-bold text-white mt-2">{stats.occupied}</h3></div>
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-emerald-500 shadow-lg"><p className="text-xs text-slate-400 uppercase font-bold">Receita (Dia)</p><h3 className="text-3xl font-bold text-emerald-400 mt-2">{formatCurrency(stats.totalRevenue)}</h3></div>
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-red-500 shadow-lg"><p className="text-xs text-slate-400 uppercase font-bold">Despesas (Dia)</p><h3 className="text-3xl font-bold text-red-400 mt-2">{formatCurrency(stats.expenses)}</h3></div>
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-blue-500 shadow-lg"><p className="text-xs text-slate-400 uppercase font-bold">Balanço (Dia)</p><h3 className={`text-3xl font-bold mt-2 ${stats.balance >= 0 ? 'text-blue-400' : 'text-red-400'}`}>{formatCurrency(stats.balance)}</h3></div>
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <div className="lg:col-span-2 bg-slate-800 rounded-xl p-6 border border-slate-700"><h3 className="font-bold text-lg mb-4 text-white">Fluxo Financeiro (7 Dias)</h3><ParkingChart historyData={history} financeData={finances} /></div>
                                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700"><h3 className="font-bold text-lg mb-4 text-white">Mapa de Vagas</h3><div className="grid grid-cols-5 gap-2 max-h-64 overflow-y-auto pr-2">{Array.from({length: parseInt(config.totalSpots)}).map((_, i) => { const isOccupied = i < tickets.length; return (<div key={i} className={`aspect-square rounded-md flex items-center justify-center text-xs font-bold transition ${isOccupied ? 'bg-red-500/20 text-red-500 border border-red-500' : 'bg-emerald-500/20 text-emerald-500 border border-emerald-500'}`}>{i + 1}</div>); })}</div></div>
                                    </div>

                                    {/* BOTÃO DE MANUTENÇÃO DISCRETO NO FINAL DA PÁGINA */}
                                    <div className="mt-12 pt-12 border-t border-slate-800/50 text-center opacity-60 hover:opacity-100 transition">
                                        <button onClick={hardAppReset} className="text-[10px] uppercase font-bold tracking-widest text-slate-500 flex items-center justify-center gap-2 mx-auto">
                                            <i className="ph ph-wrench"></i> ROTINA DE MANUTENÇÃO
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* PÁTIO */}
                            {tab === 'patio' && (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in h-full">
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 h-fit shadow-xl order-1 lg:order-1">
                                        <h3 className="font-bold text-xl text-cyan-400 mb-6 flex items-center gap-2"><i className="ph-bold ph-gate"></i> Nova Entrada</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-xs text-slate-400 uppercase font-bold block mb-1">Placa</label>
                                                <div className="flex gap-2">
                                                    <input className="w-full bg-slate-900 border-2 border-slate-700 p-4 rounded-lg text-white font-mono text-2xl uppercase focus:border-cyan-500 outline-none text-center tracking-widest" placeholder="ABC-1234" value={entryForm.plate} onChange={e => setEntryForm({...entryForm, plate: e.target.value.toUpperCase()})} maxLength={8} />
                                                    <label className="bg-slate-700 hover:bg-slate-600 text-white p-3 rounded-lg border-2 border-slate-600 flex items-center justify-center w-16 cursor-pointer">
                                                        <i className="ph-bold ph-camera text-2xl"></i>
                                                        <input type="file" accept="image/*" capture="environment" className="hidden" onChange={handleFileScan} />
                                                    </label>
                                                </div>
                                                {loadingCamera && <p className="text-xs text-cyan-400 text-center animate-pulse mt-1">Processando Placa...</p>}
                                            </div>
                                            <div className="flex bg-slate-900 rounded-lg p-1 border border-slate-700"><button onClick={()=>setEntryForm({...entryForm, type: 'Carro'})} className={`flex-1 py-3 rounded text-base md:text-sm font-bold transition ${entryForm.type === 'Carro' ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>Carro</button><button onClick={()=>setEntryForm({...entryForm, type: 'Moto'})} className={`flex-1 py-3 rounded text-base md:text-sm font-bold transition ${entryForm.type === 'Moto' ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>Moto</button></div>
                                            <input className="w-full bg-slate-900 border border-slate-700 p-4 rounded-lg text-base md:text-sm text-white" placeholder="Modelo (Opcional)" value={entryForm.model} onChange={e=>setEntryForm({...entryForm, model:e.target.value})} />
                                            <div className="bg-slate-900 p-3 rounded-lg border border-slate-700"><p className="text-xs text-red-400 font-bold mb-2 uppercase flex items-center gap-1"><i className="ph-fill ph-warning"></i> Checklist Avaria</p><div className="grid grid-cols-2 gap-2 mb-2">{commonDamages.map(item => (<div key={item} className="flex items-center gap-2"><input type="checkbox" id={`dmg-${item}`} checked={entryForm.damages.includes(item)} onChange={e => { const newDamages = e.target.checked ? [...entryForm.damages, item] : entryForm.damages.filter(i => i !== item); setEntryForm({...entryForm, damages: newDamages}); }} className="accent-red-500 w-5 h-5" /><label htmlFor={`dmg-${item}`} className="text-xs text-slate-300 cursor-pointer">{item}</label></div>))}</div><input className="w-full bg-slate-800 border border-slate-600 p-3 rounded text-base md:text-xs text-white" placeholder="Obs: Avaria específica..." value={entryForm.notes} onChange={e=>setEntryForm({...entryForm, notes:e.target.value})} /></div>
                                            <div className="bg-slate-900 p-3 rounded-lg border border-slate-700"><p className="text-xs text-slate-500 font-bold mb-2 uppercase">Ajuste Manual</p><div className="grid grid-cols-2 gap-2"><input type="datetime-local" className="bg-slate-800 border border-slate-600 p-2 rounded text-white text-[10px]" value={entryForm.manualEntry} onChange={e=>setEntryForm({...entryForm, manualEntry:e.target.value})} /><input type="datetime-local" className="bg-slate-800 border border-slate-600 p-2 rounded text-white text-[10px]" value={entryForm.manualExit} onChange={e=>setEntryForm({...entryForm, manualExit:e.target.value})} /></div></div>
                                            <button onClick={handleEntry} className="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-4 rounded-lg shadow-lg shadow-cyan-900/50 flex items-center justify-center gap-2 mt-4 text-lg active:scale-95 transition"><i className="ph-bold ph-ticket"></i> {entryForm.manualExit ? 'Lançar Histórico' : 'Gerar Ticket'}</button>
                                        </div>
                                    </div>
                                    <div className="lg:col-span-2 bg-slate-800 rounded-xl p-4 md:p-6 border border-slate-700 flex flex-col overflow-hidden h-auto lg:h-auto min-h-[500px] order-2 lg:order-2">
                                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4"><h3 className="font-bold text-xl text-white">Veículos no Pátio</h3><input className="bg-slate-900 border border-slate-700 rounded-lg py-3 px-4 text-base md:text-sm text-white w-full md:w-64" placeholder="Filtrar placa..." value={filterPlate} onChange={e=>setFilterPlate(e.target.value.toUpperCase())} /></div>
                                        <div className="flex-1 overflow-y-auto pr-2 space-y-3">
                                            {tickets.filter(t => t.plate.includes(filterPlate)).map(t => (
                                                <div key={t.id} className="bg-slate-900 p-4 rounded-lg border border-slate-700 flex flex-col md:flex-row justify-between items-start md:items-center hover:border-cyan-500 transition group gap-4">
                                                    <div className="flex items-center gap-4"><div className={`p-3 rounded-lg ${t.type === 'Carro' ? 'bg-blue-900/30 text-blue-400' : 'bg-orange-900/30 text-orange-400'}`}><i className={`ph-fill ${t.type === 'Carro' ? 'ph-car' : 'ph-motorcycle'} text-2xl`}></i></div><div><div className="flex items-center gap-2"><h4 className="font-bold text-white text-xl font-mono">{t.plate}</h4>{t.isSubscriber && <span className="bg-violet-600 text-white text-[10px] uppercase font-bold px-2 py-0.5 rounded">Mensalista</span>}{t.isLoyalty && <span className="bg-emerald-600 text-white text-[10px] uppercase font-bold px-2 py-0.5 rounded flex items-center gap-1"><i className="ph-fill ph-star"></i> Fidelidade</span>}</div><p className="text-sm text-slate-400">{t.model} • {new Date(t.entryTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p></div></div>
                                                    <div className="flex gap-2 w-full md:w-auto"><button onClick={() => sendWhatsAppTicket(t)} className="p-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded"><i className="ph-bold ph-whatsapp-logo"></i></button><button onClick={() => prepareExit(t)} className="flex-1 md:flex-none bg-red-600 hover:bg-red-500 text-white px-4 py-3 md:py-2 rounded-lg font-bold flex items-center justify-center gap-2"><i className="ph-bold ph-sign-out"></i> Saída</button></div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* CONFIGURAÇÕES */}
                            {tab === 'config' && userRole === 'admin' && (
                                <div className="max-w-4xl mx-auto space-y-6 animate-fade-in">
                                    <div className="bg-slate-800 p-8 rounded-xl border border-slate-700">
                                        <h3 className="font-bold text-2xl text-white mb-6 border-b border-slate-700 pb-4 flex items-center gap-2">
                                            <i className="ph-fill ph-gear"></i> Ajustes Master do Sistema
                                        </h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="space-y-4">
                                                <div><label className="text-sm font-bold text-slate-400 block mb-2">Nome do Estabelecimento</label><input className="w-full bg-slate-900 border border-slate-700 p-4 rounded text-white" value={config.name} onChange={e=>setConfig({...config, name:e.target.value})} /></div>
                                                <div><label className="text-sm font-bold text-slate-400 block mb-2">Endereço</label><input className="w-full bg-slate-900 border border-slate-700 p-4 rounded text-white" value={config.address} onChange={e=>setConfig({...config, address:e.target.value})} /></div>
                                                <div><label className="text-sm font-bold text-slate-400 block mb-2">Total de Vagas</label><input type="number" className="w-full bg-slate-900 border border-slate-700 p-4 rounded text-white" value={config.totalSpots} onChange={e=>setConfig({...config, totalSpots:e.target.value})} /></div>
                                            </div>
                                            <div className="space-y-4">
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="text-sm font-bold text-slate-400 block mb-2">Preço Carro</label><input type="number" className="w-full bg-slate-900 border border-slate-700 p-4 rounded text-white" value={config.priceCarHour} onChange={e=>setConfig({...config, priceCarHour:e.target.value})} /></div>
                                                    <div><label className="text-sm font-bold text-slate-400 block mb-2">Preço Moto</label><input type="number" className="w-full bg-slate-900 border border-slate-700 p-4 rounded text-white" value={config.priceMotoHour} onChange={e=>setConfig({...config, priceMotoHour:e.target.value})} /></div>
                                                </div>
                                                <div><label className="text-sm font-bold text-slate-400 block mb-2">Tolerância (min)</label><input type="number" className="w-full bg-slate-900 border border-slate-700 p-4 rounded text-white" value={config.toleranceMin} onChange={e=>setConfig({...config, toleranceMin:e.target.value})} /></div>
                                                <div><label className="text-sm font-bold text-slate-400 block mb-2">Diária (8h+)</label><input type="number" className="w-full bg-slate-900 border border-slate-700 p-4 rounded text-white" value={config.dailyRate} onChange={e=>setConfig({...config, dailyRate:e.target.value})} /></div>
                                            </div>
                                        </div>
                                        <button onClick={saveConfig} className="mt-8 w-full md:w-auto bg-cyan-600 hover:bg-cyan-500 text-white px-8 py-4 rounded-lg font-bold shadow-lg shadow-cyan-900/20 active:scale-95 transition">
                                            SALVAR CONFIGURAÇÕES NO MASTER
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* ABAS ADICIONAIS (MANTIDAS) */}
                            {['carwash', 'finance', 'suppliers', 'team', 'clients', 'subscribers', 'agreements'].includes(tab) && (
                                <div className="space-y-6 animate-fade-in">
                                    <p className="text-slate-500 italic text-sm">Gerenciando ferramentas protegidas ({tabNames[tab]}).</p>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* MODAIS (PROTEGIDOS E MANTIDOS) */}
                    {modal && (
                        <div className={`fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 no-print`}>
                            {modal === 'print_entry' && activeTicket && (
                                <div className="bg-white text-black p-6 rounded-xl max-w-sm w-full relative">
                                    <button onClick={() => setModal(null)} className="absolute top-2 right-2 text-gray-500 no-print"><i className="ph-bold ph-x text-xl"></i></button>
                                    <div id="print-area">
                                        <div className="text-center font-mono">
                                            <h2 className="font-bold text-xl">{config.name || 'PARKING PRO'}</h2>
                                            <p className="text-xs">{config.address}</p>
                                            <div className="my-4 border-b-2 border-dashed border-black"></div>
                                            <h3 className="text-2xl font-black">{activeTicket.plate}</h3>
                                            <p className="text-xs mt-2">ENTRADA: {new Date(activeTicket.entryTime).toLocaleString()}</p>
                                            <div className="barcode mt-4"></div>
                                        </div>
                                    </div>
                                    <button onClick={() => window.print()} className="w-full bg-cyan-600 text-white font-bold py-3 rounded mt-4 flex items-center justify-center gap-2"><i className="ph-bold ph-printer"></i> Imprimir</button>
                                </div>
                            )}

                            {modal === 'confirm_exit' && activeTicket && (
                                <div className="bg-slate-800 text-white p-6 rounded-xl max-w-md w-full border border-slate-700 shadow-2xl">
                                    <h3 className="text-xl font-bold mb-4">Fechar Ticket - {activeTicket.plate}</h3>
                                    <div className="space-y-4 mb-6">
                                        <div className="flex justify-between items-center"><span className="text-xl font-bold">Total:</span><span className="text-3xl font-black text-emerald-400">{formatCurrency(activeTicket.total)}</span></div>
                                        <select className="w-full bg-slate-900 border border-slate-700 p-3 rounded" value={paymentMethod} onChange={e=>setPaymentMethod(e.target.value)}>
                                            <option>Dinheiro</option><option>PIX</option><option>Cartão</option>
                                        </select>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>setModal(null)} className="flex-1 bg-slate-700 py-3 rounded font-bold">Cancelar</button>
                                        <button onClick={confirmExit} className="flex-1 bg-emerald-600 py-3 rounded font-bold transition active:scale-95">Confirmar Saída</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
