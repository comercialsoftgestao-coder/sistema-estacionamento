<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parking Pro - Gestão de Estacionamento & Lava-rápido</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tesseract.js para OCR (Leitura de Placas) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Firebase App (o núcleo do SDK do Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <!-- Firebase Firestore (o banco de dados) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; user-select: none; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            .no-print { display: none !important; }
        }
        .ticket-paper { font-family: 'Courier New', Courier, monospace; width: 300px; margin: 0 auto; background: #fff; color: #000; padding: 10px; text-align: center; border: 1px dashed #ccc; }
        .ticket-divider { border-bottom: 1px dashed #000; margin: 10px 0; }
        .os-paper { font-family: 'Arial', sans-serif; width: 100%; background: #fff; color: #000; padding: 20px; border: 1px solid #000; }
        .barcode { height: 40px; width: 100%; background-image: linear-gradient(90deg, #000 2%, transparent 2%, transparent 4%, #000 4%, #000 5%, transparent 5%, transparent 6%, #000 6%, #000 8%, transparent 8%, transparent 9%, #000 9%, #000 12%, transparent 12%, transparent 13%, #000 13%, #000 15%, transparent 15%, transparent 16%, #000 16%, #000 19%, transparent 19%, transparent 20%, #000 20%, #000 23%, transparent 23%, transparent 24%, #000 24%, #000 25%, transparent 25%, transparent 26%, #000 26%, #000 29%, transparent 29%, transparent 30%, #000 30%, #000 31%, transparent 31%, transparent 32%, #000 32%, #000 35%, transparent 35%, transparent 36%, #000 36%, #000 38%, transparent 38%, transparent 39%, #000 39%, #000 42%, transparent 42%, transparent 43%, #000 43%, #000 45%, transparent 45%, transparent 46%, #000 46%); background-size: 100% 100%; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator, input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Toast = ({ message, type, show, onClose }) => {
            if (!show) return null;
            const colors = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-emerald-600' : 'bg-cyan-600');
            return (
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 md:left-auto md:translate-x-0 md:right-4 ${colors} text-white px-6 py-4 rounded-lg shadow-2xl z-[70] flex items-center gap-3 animate-fade-in w-[90%] md:w-auto`}>
                    <i className="ph-fill ph-info text-xl"></i>
                    <span className="font-bold text-sm md:text-base">{message}</span>
                </div>
            );
        };

        const BrandLogo = () => (
            <div className="flex items-center gap-2">
                <div className="w-8 h-8 md:w-10 md:h-10 bg-cyan-500 rounded flex items-center justify-center shadow-lg"><i className="ph-fill ph-car text-white text-xl md:text-2xl"></i></div>
                <div><h1 className="text-lg md:text-xl font-black italic text-white leading-none">PARKING<span className="text-cyan-400">PRO</span></h1></div>
            </div>
        );

        const ParkingChart = ({ historyData, financeData }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);
            useEffect(() => {
                if (!canvasRef.current) return;
                if (chartRef.current) chartRef.current.destroy();
                const ctx = canvasRef.current.getContext('2d');
                const last7Days = [...Array(7)].map((_, i) => { const d = new Date(); d.setDate(d.getDate() - i); return d.toLocaleDateString('pt-BR'); }).reverse();
                const parkingRevenue = last7Days.map(date => (Array.isArray(historyData) ? historyData : []).filter(h => h && h.exitTime && new Date(h.exitTime).toLocaleDateString('pt-BR') === date).reduce((acc, curr) => acc + (Number(curr.total) || 0), 0));
                const expensesData = last7Days.map(date => (Array.isArray(financeData) ? financeData : []).filter(f => f && f.type === 'Despesa' && f.date && new Date(f.date + 'T12:00:00').toLocaleDateString('pt-BR') === date).reduce((acc, curr) => acc + (Number(curr.value) || 0), 0));
                chartRef.current = new Chart(ctx, { type: 'bar', data: { labels: last7Days, datasets: [{ label: 'Receita', data: parkingRevenue, backgroundColor: '#0891b2', borderRadius: 4 }, { label: 'Despesas', data: expensesData, backgroundColor: '#ef4444', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } } } });
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [historyData, financeData]);
            return <div className="h-64 w-full"><canvas ref={canvasRef}></canvas></div>;
        };

        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);

        const LoginScreen = ({ onLogin }) => {
            const [u, setU] = useState(''); const [p, setP] = useState('');
            useEffect(() => { const user = localStorage.getItem('parkingpro_user'); const pass = localStorage.getItem('parkingpro_pass'); if (user && pass) { setU(user); setP(pass); } }, []);
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950 p-4">
                    <div className="bg-slate-900 p-8 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-800">
                        <div className="flex justify-center mb-6"><BrandLogo /></div>
                        <form onSubmit={(e) => {e.preventDefault(); onLogin(u, p, true);}} className="space-y-4">
                            <input className="w-full p-3 bg-slate-950 border border-slate-800 rounded text-white" placeholder="Usuário" value={u} onChange={e=>setU(e.target.value)} />
                            <input type="password" className="w-full p-3 bg-slate-950 border border-slate-800 rounded text-white" placeholder="Senha" value={p} onChange={e=>setP(e.target.value)} />
                            <button className="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded">ABRIR SISTEMA</button>
                        </form>
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('login');
            const [toast, setToast] = useState({ show: false, msg: '', type: 'info' });
            const notify = (msg, type='success') => { setToast(prev => ({ ...prev, show: true, msg, type })); setTimeout(() => setToast(prev => ({ ...prev, show: false })), 3000); };

            const FIREBASE_CONFIG = { apiKey: "AIzaSyDYdrt4kbKtyPbx7ipHHb7wftUAlKeOZeE", authDomain: "estacionamento-332eb.firebaseapp.com", projectId: "estacionamento-332eb", storageBucket: "estacionamento-332eb.firebasestorage.app", messagingSenderId: "467691522256", appId: "1:467691522256:web:6d4495458c494e753cb6d5" };
            const [db, setDb] = useState(null); const [isOnline, setIsOnline] = useState(false);

            // Dados
            const [tickets, setTickets] = useState([]); const [history, setHistory] = useState([]); const [finances, setFinances] = useState([]);
            const [subscribers, setSubscribers] = useState([]); const [clients, setClients] = useState([]); const [team, setTeam] = useState([]);
            const [suppliers, setSuppliers] = useState([]); const [servicesList, setServicesList] = useState([]); const [agreements, setAgreements] = useState([]);
            const [config, setConfig] = useState({ name: 'Estacionamento', totalSpots: 50, priceCarHour: 10, priceMotoHour: 5, toleranceMin: 15, dailyRate: 50 });

            // UI
            const [tab, setTab] = useState('dashboard'); const [modal, setModal] = useState(null); const [activeTicket, setActiveTicket] = useState(null);
            const [filterPlate, setFilterPlate] = useState(''); const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false); const [loadingCamera, setLoadingCamera] = useState(false);

            // IDs de Edição
            const [editingId, setEditingId] = useState(null); // Financeiro
            const [editingTeamId, setEditingTeamId] = useState(null);
            const [editingClientId, setEditingClientId] = useState(null);
            const [editingAgreementId, setEditingAgreementId] = useState(null);
            const [editingSupplierId, setEditingSupplierId] = useState(null);
            const [editingServiceId, setEditingServiceId] = useState(null);
            const [editingSubscriberId, setEditingSubscriberId] = useState(null);

            // Formulários
            const [entryForm, setEntryForm] = useState({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] });
            const [editTicketForm, setEditTicketForm] = useState(null);
            const [financeForm, setFinanceForm] = useState({ type: 'Despesa', description: '', value: 0, date: '', category: 'Geral' });
            const [clientForm, setClientForm] = useState({ name: '', phone: '', plate: '', points: 0, notes: '' });
            const [supplierForm, setSupplierForm] = useState({ name: '', contact: '', category: 'Peças', notes: '' });
            const [teamForm, setTeamForm] = useState({ name: '', role: 'Operador', shift: 'Manhã', phone: '' });
            const [serviceConfigForm, setServiceConfigForm] = useState({ name: '', price: 0 });
            const [agreementForm, setAgreementForm] = useState({ name: '', discountType: 'free_time', value: 0 });
            const [checklistForm, setChecklistForm] = useState({ plate: '', model: '', fuel: '1/2', items: [], notes: '' });
            const [subscriberForm, setSubscriberForm] = useState({ name: '', plate: '', model: '', plan: 'Integral', dueDay: 10, active: true });
            const [addServiceForm, setAddServiceForm] = useState({ ticketId: null, selectedServices: [] });
            const [paymentMethod, setPaymentMethod] = useState('Dinheiro');
            const [passwordForm, setPasswordForm] = useState({ current: '', new: '', confirm: '' });

            const commonDamages = ['Arranhões', 'Amassados', 'Vidro Trincado', 'Farol Quebrado', 'Pneu Murcho', 'Antena Quebrada', 'Retrovisor Danif.'];
            const tabNames = { dashboard: 'Visão Geral', patio: 'Pátio & Entrada', carwash: 'Lava-rápido', finance: 'Financeiro', suppliers: 'Fornecedores', team: 'Equipe', clients: 'Fidelidade', subscribers: 'Mensalistas', agreements: 'Convênios', config: 'Configurações' };

            useEffect(() => {
                if (!firebase.apps.length) { try { firebase.initializeApp(FIREBASE_CONFIG); setDb(firebase.firestore()); setIsOnline(true); } catch (e) { console.error("Erro Firebase", e); setIsOnline(false); } } else { setDb(firebase.firestore()); setIsOnline(true); }
            }, []);

            const useSync = (colName, setFn) => {
                useEffect(() => {
                    if (db) return db.collection(colName).onSnapshot(snap => { const data = snap.docs.map(d => ({ ...d.data(), id: d.id })); setFn(data); }, err => console.log("Sync wait/offline", err));
                    else if (view === 'app') { try { const local = localStorage.getItem(`parkingpro_${colName}`); if (local) setFn(JSON.parse(local)); } catch(e) { console.error("Erro localStorage", e); } }
                }, [db, view]);
            };

            useSync('tickets', setTickets); useSync('history', setHistory); useSync('finances', setFinances); useSync('subscribers', setSubscribers);
            useSync('clients', setClients); useSync('team', setTeam); useSync('suppliers', setSuppliers); useSync('servicesList', setServicesList); useSync('agreements', setAgreements);

            useEffect(() => { const savedConfig = localStorage.getItem('parkingpro_config'); if (savedConfig) try { setConfig(JSON.parse(savedConfig)); } catch(e){} }, []);
            
            // Populate services if empty
            useEffect(() => {
                 if (servicesList.length === 0 && !db) {
                     setServicesList([
                        {id: 's1', name: 'Lavagem Simples', price: 40.00}, {id: 's2', name: 'Lavagem Completa + Cera', price: 80.00}, {id: 's3', name: 'Lavagem de Motor', price: 60.00},
                        {id: 's4', name: 'Higienização Interna', price: 150.00}, {id: 's5', name: 'Polimento', price: 250.00}, {id: 's6', name: 'Cristalização', price: 350.00},
                        {id: 's7', name: 'Vitrificação', price: 800.00}, {id: 's8', name: 'Lavagem de Bancos', price: 120.00}, {id: 's9', name: 'Oxi-Sanitização', price: 100.00},
                        {id: 's10', name: 'Hidratação de Couro', price: 180.00}, {id: 's11', name: 'Remoção de Chuva Ácida', price: 150.00}, {id: 's12', name: 'Pretinho Pneus', price: 10.00}
                     ]);
                 }
            }, []);

            const saveItem = async (col, item, idOverwrite) => {
                const id = idOverwrite ? String(idOverwrite) : String(item.id || Date.now());
                const data = { ...item, id: id };
                if (db) try { await db.collection(col).doc(id).set(data); } catch (e) { notify('Erro ao salvar na nuvem', 'error'); }
                return data;
            };

            const deleteItem = async (col, id) => { if (db) await db.collection(col).doc(String(id)).delete(); };

            useEffect(() => {
                if(view === 'app') {
                    const saveData = (k, v) => localStorage.setItem(`parkingpro_${k}`, JSON.stringify(v));
                    saveData('tickets', tickets); saveData('history', history); saveData('finances', finances); saveData('subscribers', subscribers);
                    saveData('clients', clients); saveData('team', team); saveData('suppliers', suppliers); saveData('servicesList', servicesList); saveData('agreements', agreements); saveData('config', config);
                }
            }, [tickets, history, finances, subscribers, clients, team, suppliers, servicesList, agreements, config]);

            const handleLogin = (u, p, remember) => { if (u === 'admin' && p === '1234') { if(remember) { localStorage.setItem('parkingpro_user', u); localStorage.setItem('parkingpro_pass', p); } setView('app'); } else notify('Senha incorreta', 'error'); };
            const handleFileScan = async (e) => { const file = e.target.files[0]; if (!file) return; setLoadingCamera(true); notify('Lendo imagem...'); try { const { data: { text } } = await Tesseract.recognize(file, 'eng'); const clean = text.replace(/[^A-Z0-9]/ig, '').toUpperCase(); const match = clean.match(/[A-Z]{3}[0-9][A-Z0-9][0-9]{2}/) || clean.match(/[A-Z]{3}[0-9]{4}/); if (match) { setEntryForm(p => ({...p, plate: match[0]})); notify('Placa encontrada!'); } else notify('Placa não identificada', 'error'); } catch(err) { notify('Erro na leitura', 'error'); } finally { setLoadingCamera(false); } };
            const handleEntry = () => { if(!entryForm.plate) return notify('Digite a placa', 'error'); const newItem = { ...entryForm, id: Date.now(), entryTime: (entryForm.manualEntry || new Date()).toString(), services: [], status: 'active', plate: entryForm.plate.toUpperCase() }; if (entryForm.manualExit) { const exitTime = new Date(entryForm.manualExit); const entryTime = new Date(newItem.entryTime); if (exitTime <= entryTime) return notify('Saída anterior à entrada', 'error'); newItem.exitTime = exitTime.toString(); newItem.status = 'finished'; newItem.total = 0; saveItem('history', newItem); if(!db) setHistory(prev => [newItem, ...prev]); notify('Histórico adicionado'); } else { saveItem('tickets', newItem); if(!db) setTickets(prev => [...prev, newItem]); notify('Veículo estacionado'); setActiveTicket(newItem); setModal('print_entry'); } setEntryForm({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] }); };
            
            // --- FUNÇÕES DE SALVAR ESPECÍFICAS (COM EDIÇÃO) ---
            const handleFinanceSave = () => { const item = { ...financeForm, value: parseFloat(financeForm.value) || 0 }; const id = editingId || Date.now(); saveItem('finances', { ...item, id }, id); if(!db) setFinances(prev => editingId ? prev.map(f => f.id === id ? {...item, id} : f) : [{...item, id}, ...prev]); setModal(null); notify('Salvo!'); };
            const handleTeamSave = () => { const item = { ...teamForm }; const id = editingTeamId || Date.now(); saveItem('team', { ...item, id }, id); if(!db) setTeam(prev => editingTeamId ? prev.map(m => m.id === id ? {...item, id} : m) : [...prev, {...item, id}]); setModal(null); notify('Salvo!'); };
            const handleClientSave = () => { const item = { ...clientForm, points: parseInt(clientForm.points) || 0 }; const id = editingClientId || Date.now(); saveItem('clients', { ...item, id }, id); if(!db) setClients(prev => editingClientId ? prev.map(c => c.id === id ? {...item, id} : c) : [...prev, {...item, id}]); setModal(null); notify('Salvo!'); };
            const handleAgreementSave = () => { const item = { ...agreementForm, value: parseFloat(agreementForm.value) || 0 }; const id = editingAgreementId || Date.now(); saveItem('agreements', { ...item, id }, id); if(!db) setAgreements(prev => editingAgreementId ? prev.map(a => a.id === id ? {...item, id} : a) : [...prev, {...item, id}]); setModal(null); notify('Salvo!'); };
            const handleSupplierSave = () => { const item = { ...supplierForm }; const id = editingSupplierId || Date.now(); saveItem('suppliers', { ...item, id }, id); if(!db) setSuppliers(prev => editingSupplierId ? prev.map(s => s.id === id ? {...item, id} : s) : [...prev, {...item, id}]); setModal(null); notify('Salvo!'); };
            const handleSubscriberSave = () => { const item = { ...subscriberForm, dueDay: parseInt(subscriberForm.dueDay) || 10 }; const id = editingSubscriberId || Date.now(); saveItem('subscribers', { ...item, id }, id); if(!db) setSubscribers(prev => editingSubscriberId ? prev.map(s => s.id === id ? {...item, id} : s) : [...prev, {...item, id}]); setModal(null); notify('Salvo!'); };
            
            // --- FUNÇÕES DE PREPARAR EDIÇÃO ---
            const handleEditTeam = (item) => { setTeamForm(item); setEditingTeamId(item.id); setModal('team'); };
            const handleEditClient = (item) => { setClientForm(item); setEditingClientId(item.id); setModal('client'); };
            const handleEditAgreement = (item) => { setAgreementForm(item); setEditingAgreementId(item.id); setModal('agreement'); };
            const handleEditSupplier = (item) => { setSupplierForm(item); setEditingSupplierId(item.id); setModal('supplier'); };
            const handleEditSubscriber = (item) => { setSubscriberForm(item); setEditingSubscriberId(item.id); setModal('subscriber'); };
            
            // Finance Edit/Delete Logic (Unified)
            const handleEditFinance = (item) => { setFinanceForm(item); setEditingId(item.id); setModal('finance'); };

            const handleDelete = (col, id, setFn) => { if(confirm('Tem certeza? Isso removerá o registro.')) { deleteItem(col, id); if(!db) setFn(prev => prev.filter(i => i.id !== id)); notify('Removido'); } };
            const saveChecklist = () => { if(!checklistForm.plate) return notify('Placa obrigatória', 'error'); const newItem = { ...checklistForm, id: Date.now(), date: new Date().toString() }; saveItem('checklists', newItem); if(!db) setChecklists(prev => [newItem, ...prev]); setChecklistForm({ plate: '', model: '', fuel: '1/2', items: [], notes: '' }); setModal(null); notify('Vistoria salva!'); };
            
            // Ticket logic
            const saveTicketEdit = () => { const t = tickets.find(x => x.id === editTicketForm.id); if(t) { const updated = { ...t, ...editTicketForm }; saveItem('tickets', updated, t.id); if(!db) setTickets(p => p.map(x => x.id === t.id ? updated : x)); setModal(null); notify('Veículo atualizado'); } };
            const handleDeleteTicket = (id) => { if(confirm('Remover do pátio?')) { deleteItem('tickets', id); if(!db) setTickets(p => p.filter(t => t.id !== id)); notify('Veículo removido'); } };
            const handleAddServices = () => { const t = tickets.find(t => t.id === addServiceForm.ticketId); if (t) { const updated = { ...t, services: addServiceForm.selectedServices }; saveItem('tickets', updated, t.id); if (!db) setTickets(p => p.map(tk => tk.id === t.id ? updated : tk)); setModal(null); notify('Serviços salvos!'); } };
            const saveConfig = () => { localStorage.setItem('parkingpro_config', JSON.stringify(config)); notify('Configurações salvas!'); };
            const downloadDashboardReport = () => { const content = `RELATÓRIO\nData: ${new Date().toLocaleDateString()}\nReceita: ${formatCurrency(stats.totalRevenue)}\nDespesas: ${formatCurrency(stats.expenses)}\n\nMOVIMENTAÇÕES:\n${history.slice(0,50).map(h=>`[${new Date(h.exitTime).toLocaleTimeString()}] ${h.plate} - ${formatCurrency(h.total)}`).join('\n')}`; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content], {type:'text/plain'})); a.download = 'relatorio.txt'; a.click(); };
            const addPoints = (clientId, amount) => { const c = clients.find(c=>c.id===clientId); if(c) { const updated = { ...c, points: Math.max(0, (c.points || 0) + amount) }; saveItem('clients', updated, clientId); if(!db) setClients(prev => prev.map(cl => cl.id === clientId ? updated : cl)); notify(amount > 0 ? 'Pontos add!' : 'Pontos resgatados!'); } };
            const saveServiceConfig = () => { if(!serviceConfigForm.name) return notify('Nome obrigatório', 'error'); const price = parseFloat(serviceConfigForm.price); if (editingServiceId) { const updated = { ...serviceConfigForm, id: editingServiceId, price }; saveItem('servicesList', updated, editingServiceId); if(!db) setServicesList(p => p.map(s => s.id === editingServiceId ? updated : s)); setEditingServiceId(null); notify('Serviço atualizado!'); } else { const newS = { ...serviceConfigForm, id: Date.now(), price }; saveItem('servicesList', newS, newS.id); if(!db) setServicesList(p => [...p, newS]); notify('Serviço criado!'); } setServiceConfigForm({ name: '', price: 0 }); };
            const handleEditService = (service) => { setServiceConfigForm({ name: service.name, price: service.price }); setEditingServiceId(service.id); };
            const removeServiceConfig = (id) => { deleteItem('servicesList', id); if(!db) setServicesList(p => p.filter(s => s.id !== id)); };

            const stats = useMemo(() => {
                const occ = tickets.length;
                const rev = (Array.isArray(finances) ? finances : []).filter(f => f.type === 'Receita').reduce((a, b) => a + (Number(b.value) || 0), 0);
                const exp = (Array.isArray(finances) ? finances : []).filter(f => f.type === 'Despesa').reduce((a, b) => a + (Number(b.value) || 0), 0);
                const todayTickets = (Array.isArray(history) ? history : []).filter(h => new Date(h.exitTime).toLocaleDateString() === new Date().toLocaleDateString()).reduce((a,b) => a + (Number(b.total) || 0), 0);
                return { occupied: occ, free: config.totalSpots - occ, totalRevenue: rev + todayTickets, expenses: exp, balance: (rev + todayTickets) - exp };
            }, [tickets, finances, history, config]);

            if (view === 'login') return <LoginScreen onLogin={handleLogin} />;

            return (
                <div className="flex h-screen bg-slate-900 text-slate-100 font-sans overflow-hidden">
                    <Toast {...toast} onClose={()=>setToast(p=>({...p, show:false}))} />
                    <aside className={`fixed inset-y-0 z-50 w-64 bg-slate-950 transition-transform ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0`}>
                        <div className="p-6 border-b border-slate-800 flex justify-between items-center"><BrandLogo /><button className="md:hidden" onClick={()=>setIsMobileMenuOpen(false)}><i className="ph-bold ph-x text-2xl"></i></button></div>
                        <nav className="p-4 space-y-1 overflow-y-auto h-full">
                            {Object.keys(tabNames).map(key => (<button key={key} onClick={()=>{setTab(key); setIsMobileMenuOpen(false);}} className={`w-full flex items-center gap-3 px-4 py-3 rounded transition ${tab===key ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}><span className="capitalize">{tabNames[key]}</span></button>))}
                            <div className="mt-8 p-4 text-center text-xs text-slate-600">{isOnline ? <span className="text-emerald-500">● Online (Nuvem)</span> : <span className="text-orange-500">● Offline (Local)</span>}</div>
                        </nav>
                    </aside>

                    <main className="flex-1 flex flex-col relative w-full overflow-hidden">
                        <header className="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6">
                            <button className="md:hidden" onClick={()=>setIsMobileMenuOpen(true)}><i className="ph-bold ph-list text-2xl"></i></button>
                            <h2 className="text-xl font-bold uppercase">{tabNames[tab]}</h2>
                            <div className="text-right"><p className="text-xs text-slate-400">Vagas</p><p className={`text-xl font-bold ${stats.free < 5 ? 'text-red-500' : 'text-emerald-400'}`}>{stats.free}</p></div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-6">
                            {tab === 'dashboard' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div className="bg-slate-800 p-4 rounded border-t-4 border-cyan-500"><h3>Ocupação</h3><p className="text-2xl font-bold">{stats.occupied}</p></div>
                                        <div className="bg-slate-800 p-4 rounded border-t-4 border-emerald-500"><h3>Receita</h3><p className="text-2xl font-bold text-emerald-400">{formatCurrency(stats.totalRevenue)}</p></div>
                                        <div className="bg-slate-800 p-4 rounded border-t-4 border-red-500"><h3>Despesas</h3><p className="text-2xl font-bold text-red-400">{formatCurrency(stats.expenses)}</p></div>
                                        <div className="bg-slate-800 p-4 rounded border-t-4 border-blue-500"><h3>Balanço</h3><p className="text-2xl font-bold text-blue-400">{formatCurrency(stats.balance)}</p></div>
                                    </div>
                                    <div className="bg-slate-800 p-4 rounded border border-slate-700"><ParkingChart historyData={history} financeData={finances} /></div>
                                </div>
                            )}

                            {tab === 'patio' && (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in h-full">
                                    <div className="bg-slate-800 p-6 rounded h-fit">
                                        <h3 className="font-bold text-xl mb-4">Nova Entrada</h3>
                                        <div className="space-y-3">
                                            <div className="flex gap-2"><input className="w-full bg-slate-900 p-3 rounded uppercase text-center text-xl font-bold" placeholder="ABC-1234" value={entryForm.plate} onChange={e=>setEntryForm({...entryForm, plate:e.target.value})} /><label className="bg-slate-700 p-3 rounded cursor-pointer"><i className="ph-bold ph-camera text-xl"></i><input type="file" className="hidden" onChange={handleFileScan} /></label></div>
                                            <div className="flex gap-2"><button onClick={()=>setEntryForm({...entryForm, type:'Carro'})} className={`flex-1 py-2 rounded ${entryForm.type==='Carro'?'bg-cyan-600':'bg-slate-700'}`}>Carro</button><button onClick={()=>setEntryForm({...entryForm, type:'Moto'})} className={`flex-1 py-2 rounded ${entryForm.type==='Moto'?'bg-cyan-600':'bg-slate-700'}`}>Moto</button></div>
                                            <input className="w-full bg-slate-900 p-3 rounded" placeholder="Modelo" value={entryForm.model} onChange={e=>setEntryForm({...entryForm, model:e.target.value})} />
                                            <button onClick={handleEntry} className="w-full bg-emerald-600 py-3 rounded font-bold">Registrar Entrada</button>
                                        </div>
                                    </div>
                                    <div className="lg:col-span-2 space-y-3">
                                        <input className="w-full bg-slate-800 p-3 rounded" placeholder="Buscar placa..." value={filterPlate} onChange={e=>setFilterPlate(e.target.value.toUpperCase())} />
                                        {tickets.filter(t=>t.plate && t.plate.includes(filterPlate)).map(t => (<div key={t.id} className="bg-slate-800 p-4 rounded flex justify-between items-center border-l-4 border-cyan-500"><div><h4 className="font-bold text-lg">{t.plate}</h4><p className="text-sm text-slate-400">{t.model}</p></div><button onClick={()=>{setActiveTicket(t); setModal('exit_confirm');}} className="bg-red-600 px-4 py-2 rounded font-bold">Saída</button></div>))}
                                    </div>
                                </div>
                            )}

                            {tab === 'carwash' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="flex justify-between items-center"><h3 className="font-bold text-xl">Lava-rápido</h3><button onClick={()=>setModal('new_wash_entry')} className="bg-emerald-600 px-4 py-2 rounded font-bold">+ Nova Lavagem</button></div>
                                    <div className="grid gap-4">
                                        {tickets.filter(t=>t.plate.includes(filterPlate)).map(t=>(<div key={t.id} className="bg-slate-800 p-4 rounded border border-slate-700 flex justify-between items-center"><div className="flex gap-4 items-center"><div className="p-3 bg-slate-700 rounded"><i className="ph-fill ph-car text-xl"></i></div><div><h4 className="font-bold font-mono">{t.plate}</h4><p className="text-xs text-slate-400">{t.model}</p></div></div><div className="flex-1 px-4"><div className="flex flex-wrap gap-2">{t.services?.map(s=><span key={s.id} className="text-xs bg-cyan-900 text-cyan-300 px-2 py-1 rounded">{s.name}</span>)}</div></div><div className="flex gap-2 items-center"><span className="font-bold text-emerald-400">{formatCurrency((t.services||[]).reduce((a,b)=>a+b.price,0))}</span><button onClick={()=>{setAddServiceForm({ticketId:t.id, selectedServices:t.services||[]}); setModal('service_manager');}} className="p-2 bg-blue-600 rounded"><i className="ph-bold ph-list-plus"></i></button><button onClick={()=>handleEditTicket(t)} className="p-2 bg-slate-600 rounded"><i className="ph-bold ph-pencil"></i></button><button onClick={()=>handleDeleteTicket(t.id)} className="p-2 bg-red-900/50 text-red-400 rounded"><i className="ph-bold ph-trash"></i></button></div></div>))}
                                    </div>
                                </div>
                            )}

                            {tab === 'finance' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="flex justify-end"><button onClick={()=>{setEditingId(null); setFinanceForm({type:'Despesa', description:'', value:0, date:new Date().toISOString().split('T')[0], category:'Geral'}); setModal('finance');}} className="bg-emerald-600 px-4 py-2 rounded font-bold">Novo Lançamento</button></div>
                                    <div className="bg-slate-800 rounded overflow-x-auto">
                                        <table className="w-full text-left text-sm"><thead className="bg-slate-900 text-slate-400"><tr><th className="p-3">Data</th><th className="p-3">Desc</th><th className="p-3">Tipo</th><th className="p-3">Valor</th><th className="p-3">Ações</th></tr></thead><tbody>{(Array.isArray(finances) ? finances : []).concat(Array.isArray(history) ? history.map(h => ({...h, date: h.exitTime, description: `Ticket ${h.plate}`, type: 'Receita', value: h.total, isHistory: true})) : []).sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 50).map((item, i) => (<tr key={i} className="border-b border-slate-700"><td className="p-3">{new Date(item.date).toLocaleDateString()}</td><td className="p-3">{item.description || item.desc}</td><td className="p-3"><span className={`px-2 py-1 rounded text-xs ${item.type==='Receita'?'bg-emerald-900 text-emerald-400':'bg-red-900 text-red-400'}`}>{item.type}</span></td><td className="p-3 font-bold">{formatCurrency(item.value)}</td><td className="p-3"><div className="flex gap-2">{!item.isHistory && <button onClick={()=>{setFinanceForm(item); setEditingId(item.id); setModal('finance');}} className="text-blue-400"><i className="ph-bold ph-pencil"></i></button>}<button onClick={()=>handleDelete(item.isHistory ? 'history' : 'finances', item.id, item.isHistory ? setHistory : setFinances)} className="text-red-400"><i className="ph-bold ph-trash"></i></button></div></td></tr>))}</tbody></table>
                                    </div>
                                </div>
                            )}

                            {tab === 'team' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="flex justify-end"><button onClick={()=>{setEditingTeamId(null); setTeamForm({name:'', role:'Operador', shift:'Manhã', phone:''}); setModal('team');}} className="bg-emerald-600 px-4 py-2 rounded font-bold">Novo Funcionário</button></div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">{team.map(m => (<div key={m.id} className="bg-slate-800 p-4 rounded border border-slate-700 flex justify-between items-center"><div><h4 className="font-bold">{m.name}</h4><p className="text-sm text-slate-400">{m.role} - {m.shift}</p></div><div className="flex gap-2"><button onClick={()=>handleEditTeam(m)} className="text-blue-400 p-2"><i className="ph-bold ph-pencil"></i></button><button onClick={()=>handleDelete('team', m.id, setTeam)} className="text-red-400 p-2"><i className="ph-bold ph-trash"></i></button></div></div>))}</div>
                                </div>
                            )}

                            {tab === 'clients' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="flex justify-end"><button onClick={()=>{setEditingClientId(null); setClientForm({name:'', phone:'', plate:'', points:0, notes:''}); setModal('client');}} className="bg-emerald-600 px-4 py-2 rounded font-bold">Novo Cliente</button></div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">{clients.map(c => (<div key={c.id} className="bg-slate-800 p-4 rounded border border-slate-700 flex justify-between items-center"><div><h4 className="font-bold">{c.name}</h4><p className="text-sm text-slate-400">{c.plate} • {c.points} pts</p></div><div className="flex gap-2"><button onClick={()=>handleEditClient(c)} className="text-blue-400 p-2"><i className="ph-bold ph-pencil"></i></button><button onClick={()=>handleDelete('clients', c.id, setClients)} className="text-red-400 p-2"><i className="ph-bold ph-trash"></i></button></div></div>))}</div>
                                </div>
                            )}

                            {tab === 'agreements' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="flex justify-end"><button onClick={()=>{setEditingAgreementId(null); setAgreementForm({name:'', discountType:'free_time', value:0}); setModal('agreement');}} className="bg-emerald-600 px-4 py-2 rounded font-bold">Novo Convênio</button></div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">{agreements.map(a => (<div key={a.id} className="bg-slate-800 p-4 rounded border border-slate-700 flex justify-between items-center"><div><h4 className="font-bold">{a.name}</h4><p className="text-sm text-slate-400">{a.discountType==='free_time' ? `${a.value} min` : `${a.value}%`}</p></div><div className="flex gap-2"><button onClick={()=>handleEditAgreement(a)} className="text-blue-400 p-2"><i className="ph-bold ph-pencil"></i></button><button onClick={()=>handleDelete('agreements', a.id, setAgreements)} className="text-red-400 p-2"><i className="ph-bold ph-trash"></i></button></div></div>))}</div>
                                </div>
                            )}

                            {tab === 'suppliers' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="flex justify-end"><button onClick={()=>{setEditingSupplierId(null); setSupplierForm({name:'', contact:'', category:'Peças', notes:''}); setModal('supplier');}} className="bg-emerald-600 px-4 py-2 rounded font-bold">Novo Fornecedor</button></div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">{suppliers.map(s => (<div key={s.id} className="bg-slate-800 p-4 rounded border border-slate-700 flex justify-between items-center"><div><h4 className="font-bold">{s.name}</h4><p className="text-sm text-slate-400">{s.category}</p></div><div className="flex gap-2"><button onClick={()=>handleEditSupplier(s)} className="text-blue-400 p-2"><i className="ph-bold ph-pencil"></i></button><button onClick={()=>handleDelete('suppliers', s.id, setSuppliers)} className="text-red-400 p-2"><i className="ph-bold ph-trash"></i></button></div></div>))}</div>
                                </div>
                            )}

                            {tab === 'subscribers' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="flex justify-end"><button onClick={()=>{setEditingSubscriberId(null); setSubscriberForm({name:'', plate:'', model:'', plan:'Integral', dueDay:10, active:true}); setModal('subscriber');}} className="bg-emerald-600 px-4 py-2 rounded font-bold">Novo Mensalista</button></div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">{subscribers.map(s => (<div key={s.id} className="bg-slate-800 p-4 rounded border border-slate-700 flex justify-between items-center"><div><h4 className="font-bold">{s.name}</h4><p className="text-sm text-slate-400">{s.plate} • Dia {s.dueDay}</p></div><div className="flex gap-2"><button onClick={()=>handleEditSubscriber(s)} className="text-blue-400 p-2"><i className="ph-bold ph-pencil"></i></button><button onClick={()=>handleDelete('subscribers', s.id, setSubscribers)} className="text-red-400 p-2"><i className="ph-bold ph-trash"></i></button></div></div>))}</div>
                                </div>
                            )}

                            {tab === 'config' && (
                                <div className="space-y-6 animate-fade-in max-w-3xl mx-auto">
                                    <div className="bg-slate-800 p-6 rounded border border-slate-700">
                                        <h3 className="font-bold text-xl mb-4">Geral</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div><label className="text-xs block mb-1">Nome</label><input className="w-full bg-slate-900 p-2 rounded" value={config.name} onChange={e=>setConfig({...config, name:e.target.value})} /></div>
                                            <div><label className="text-xs block mb-1">Vagas</label><input type="number" className="w-full bg-slate-900 p-2 rounded" value={config.totalSpots} onChange={e=>setConfig({...config, totalSpots:e.target.value})} /></div>
                                            <div><label className="text-xs block mb-1">Preço Hora (Carro)</label><input type="number" className="w-full bg-slate-900 p-2 rounded" value={config.priceCarHour} onChange={e=>setConfig({...config, priceCarHour:e.target.value})} /></div>
                                            <div><label className="text-xs block mb-1">Preço Hora (Moto)</label><input type="number" className="w-full bg-slate-900 p-2 rounded" value={config.priceMotoHour} onChange={e=>setConfig({...config, priceMotoHour:e.target.value})} /></div>
                                        </div>
                                        <button onClick={saveConfig} className="mt-4 bg-cyan-600 px-6 py-2 rounded font-bold">Salvar Configurações</button>
                                    </div>

                                    <div className="bg-slate-800 p-6 rounded border border-slate-700">
                                        <h3 className="font-bold text-xl mb-4">Catálogo de Serviços</h3>
                                        <div className="flex gap-2 mb-4">
                                            <input className="flex-1 bg-slate-900 p-2 rounded" placeholder="Nome do Serviço" value={serviceConfigForm.name} onChange={e=>setServiceConfigForm({...serviceConfigForm, name:e.target.value})} />
                                            <input className="w-24 bg-slate-900 p-2 rounded" type="number" placeholder="R$" value={serviceConfigForm.price} onChange={e=>setServiceConfigForm({...serviceConfigForm, price:e.target.value})} />
                                            <button onClick={()=>{
                                                if (editingServiceId) {
                                                     const updated = { ...serviceConfigForm, id: editingServiceId, price: parseFloat(serviceConfigForm.price) || 0 };
                                                     saveItem('servicesList', updated, editingServiceId);
                                                     if (!db) setServicesList(p => p.map(s => s.id === editingServiceId ? updated : s));
                                                     setEditingServiceId(null);
                                                } else {
                                                     const newItem = { ...serviceConfigForm, id: Date.now(), price: parseFloat(serviceConfigForm.price) || 0 };
                                                     saveItem('servicesList', newItem, newItem.id);
                                                     if (!db) setServicesList(prev => [...prev, newItem]);
                                                }
                                                setServiceConfigForm({name:'', price:0}); notify('Serviço Salvo');
                                            }} className="bg-emerald-600 px-4 rounded font-bold">{editingServiceId ? 'ok' : '+'}</button>
                                            {editingServiceId && <button onClick={() => {setEditingServiceId(null); setServiceConfigForm({name:'', price:0})}} className="bg-red-500 px-4 rounded font-bold">x</button>}
                                        </div>
                                        <div className="space-y-2">
                                            {servicesList.map(s => (
                                                <div key={s.id} className="flex justify-between items-center bg-slate-900 p-3 rounded">
                                                    <span>{s.name}</span>
                                                    <div className="flex items-center gap-4">
                                                        <span className="font-bold text-emerald-400">{formatCurrency(s.price)}</span>
                                                        <button onClick={() => handleEditService(s)} className="text-blue-400"><i className="ph-bold ph-pencil"></i></button>
                                                        <button onClick={()=>handleDelete('servicesList', s.id, setServicesList)} className="text-red-400"><i className="ph-bold ph-trash"></i></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* MODALS */}
                    {modal === 'finance' && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 p-6 rounded w-full max-w-md">
                                <h3 className="font-bold text-xl mb-4">{editingId ? 'Editar' : 'Novo'} Lançamento</h3>
                                <div className="space-y-3">
                                    <select className="w-full bg-slate-900 p-3 rounded" value={financeForm.type} onChange={e=>setFinanceForm({...financeForm, type:e.target.value})}><option>Receita</option><option>Despesa</option></select>
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Descrição" value={financeForm.description} onChange={e=>setFinanceForm({...financeForm, description:e.target.value})} />
                                    <input type="number" className="w-full bg-slate-900 p-3 rounded" placeholder="Valor" value={financeForm.value} onChange={e=>setFinanceForm({...financeForm, value:e.target.value})} />
                                    <input type="date" className="w-full bg-slate-900 p-3 rounded" value={financeForm.date} onChange={e=>setFinanceForm({...financeForm, date:e.target.value})} />
                                </div>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button onClick={()=>setModal(null)} className="px-4 py-2 text-slate-400">Cancelar</button>
                                    <button onClick={handleFinanceSave} className="bg-emerald-600 px-4 py-2 rounded font-bold">Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* TEAM MODAL */}
                    {modal === 'team' && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 p-6 rounded w-full max-w-md">
                                <h3 className="font-bold text-xl mb-4">{editingTeamId ? 'Editar' : 'Novo'} Funcionário</h3>
                                <div className="space-y-3">
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Nome" value={teamForm.name} onChange={e=>setTeamForm({...teamForm, name:e.target.value})} />
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Cargo" value={teamForm.role} onChange={e=>setTeamForm({...teamForm, role:e.target.value})} />
                                    <select className="w-full bg-slate-900 p-3 rounded" value={teamForm.shift} onChange={e=>setTeamForm({...teamForm, shift:e.target.value})}><option>Manhã</option><option>Tarde</option><option>Noite</option></select>
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Telefone" value={teamForm.phone} onChange={e=>setTeamForm({...teamForm, phone:e.target.value})} />
                                </div>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button onClick={()=>setModal(null)} className="px-4 py-2 text-slate-400">Cancelar</button>
                                    <button onClick={handleTeamSave} className="bg-emerald-600 px-4 py-2 rounded font-bold">Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* CLIENT MODAL */}
                    {modal === 'client' && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 p-6 rounded w-full max-w-md">
                                <h3 className="font-bold text-xl mb-4">{editingClientId ? 'Editar' : 'Novo'} Cliente</h3>
                                <div className="space-y-3">
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Nome" value={clientForm.name} onChange={e=>setClientForm({...clientForm, name:e.target.value})} />
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Telefone" value={clientForm.phone} onChange={e=>setClientForm({...clientForm, phone:e.target.value})} />
                                    <input className="w-full bg-slate-900 p-3 rounded uppercase" placeholder="Placa" value={clientForm.plate} onChange={e=>setClientForm({...clientForm, plate:e.target.value.toUpperCase()})} />
                                    <input type="number" className="w-full bg-slate-900 p-3 rounded" placeholder="Pontos" value={clientForm.points} onChange={e=>setClientForm({...clientForm, points:e.target.value})} />
                                </div>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button onClick={()=>setModal(null)} className="px-4 py-2 text-slate-400">Cancelar</button>
                                    <button onClick={handleClientSave} className="bg-emerald-600 px-4 py-2 rounded font-bold">Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* AGREEMENT MODAL */}
                    {modal === 'agreement' && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 p-6 rounded w-full max-w-md">
                                <h3 className="font-bold text-xl mb-4">{editingAgreementId ? 'Editar' : 'Novo'} Convênio</h3>
                                <div className="space-y-3">
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Nome Parceiro" value={agreementForm.name} onChange={e=>setAgreementForm({...agreementForm, name:e.target.value})} />
                                    <select className="w-full bg-slate-900 p-3 rounded" value={agreementForm.discountType} onChange={e=>setAgreementForm({...agreementForm, discountType:e.target.value})}><option value="free_time">Tempo (min)</option><option value="percentage">Desconto (%)</option></select>
                                    <input type="number" className="w-full bg-slate-900 p-3 rounded" placeholder="Valor" value={agreementForm.value} onChange={e=>setAgreementForm({...agreementForm, value:e.target.value})} />
                                </div>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button onClick={()=>setModal(null)} className="px-4 py-2 text-slate-400">Cancelar</button>
                                    <button onClick={handleAgreementSave} className="bg-emerald-600 px-4 py-2 rounded font-bold">Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SUPPLIER MODAL */}
                    {modal === 'supplier' && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 p-6 rounded w-full max-w-md">
                                <h3 className="font-bold text-xl mb-4">{editingSupplierId ? 'Editar' : 'Novo'} Fornecedor</h3>
                                <div className="space-y-3">
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Empresa" value={supplierForm.name} onChange={e=>setSupplierForm({...supplierForm, name:e.target.value})} />
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Contato" value={supplierForm.contact} onChange={e=>setSupplierForm({...supplierForm, contact:e.target.value})} />
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Categoria" value={supplierForm.category} onChange={e=>setSupplierForm({...supplierForm, category:e.target.value})} />
                                </div>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button onClick={()=>setModal(null)} className="px-4 py-2 text-slate-400">Cancelar</button>
                                    <button onClick={handleSupplierSave} className="bg-emerald-600 px-4 py-2 rounded font-bold">Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SUBSCRIBER MODAL */}
                    {modal === 'subscriber' && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 p-6 rounded w-full max-w-md">
                                <h3 className="font-bold text-xl mb-4">{editingSubscriberId ? 'Editar' : 'Novo'} Mensalista</h3>
                                <div className="space-y-3">
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Nome" value={subscriberForm.name} onChange={e=>setSubscriberForm({...subscriberForm, name:e.target.value})} />
                                    <input className="w-full bg-slate-900 p-3 rounded uppercase" placeholder="Placa" value={subscriberForm.plate} onChange={e=>setSubscriberForm({...subscriberForm, plate:e.target.value.toUpperCase()})} />
                                    <input className="w-full bg-slate-900 p-3 rounded" placeholder="Modelo" value={subscriberForm.model} onChange={e=>setSubscriberForm({...subscriberForm, model:e.target.value})} />
                                    <div className="flex gap-2">
                                        <select className="flex-1 bg-slate-900 p-3 rounded" value={subscriberForm.plan} onChange={e=>setSubscriberForm({...subscriberForm, plan:e.target.value})}><option>Integral</option><option>Diurno</option><option>Noturno</option></select>
                                        <input type="number" className="w-24 bg-slate-900 p-3 rounded" placeholder="Dia" value={subscriberForm.dueDay} onChange={e=>setSubscriberForm({...subscriberForm, dueDay:e.target.value})} />
                                    </div>
                                    <div className="flex items-center gap-2"><input type="checkbox" checked={subscriberForm.active} onChange={e=>setSubscriberForm({...subscriberForm, active:e.target.checked})} /><label>Ativo</label></div>
                                </div>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button onClick={()=>setModal(null)} className="px-4 py-2 text-slate-400">Cancelar</button>
                                    <button onClick={handleSubscriberSave} className="bg-emerald-600 px-4 py-2 rounded font-bold">Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* OTHER MODALS (EXISTING) */}
                    {modal === 'print_entry' && activeTicket && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-white text-black p-4 rounded w-[320px]">
                                <div id="print-area" className="ticket-paper">
                                    <div className="font-bold text-lg uppercase">{config.name}</div>
                                    <div className="text-3xl font-mono font-bold my-4">{activeTicket.plate}</div>
                                    <div>{new Date(activeTicket.entryTime).toLocaleString()}</div>
                                </div>
                                <div className="flex gap-2 mt-4 no-print">
                                    <button onClick={()=>window.print()} className="flex-1 bg-blue-600 text-white py-2 rounded font-bold">Imprimir</button>
                                    <button onClick={()=>setModal(null)} className="flex-1 bg-slate-600 text-white py-2 rounded font-bold">Fechar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {modal === 'exit_confirm' && activeTicket && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 p-6 rounded w-full max-w-sm">
                                <h3 className="font-bold text-xl mb-4">Confirmar Saída</h3>
                                <div className="bg-slate-900 p-4 rounded mb-4 text-center">
                                    <div className="text-2xl font-bold font-mono mb-2">{activeTicket.plate}</div>
                                    <div className="text-slate-400">Permanência: {Math.ceil((new Date() - new Date(activeTicket.entryTime)) / 60000)} min</div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={()=>setModal(null)} className="flex-1 py-3 text-slate-400 font-bold">Cancelar</button>
                                    <button onClick={()=>{
                                        const exitTime = new Date();
                                        const durationMins = Math.ceil((exitTime - new Date(activeTicket.entryTime)) / 60000);
                                        const hours = Math.ceil(durationMins / 60);
                                        const total = hours * (activeTicket.type === 'Carro' ? config.priceCarHour : config.priceMotoHour);
                                        const finished = { ...activeTicket, exitTime: exitTime.toString(), durationMins, total, status: 'finished' };
                                        
                                        saveItem('history', finished);
                                        deleteItem('tickets', activeTicket.id);
                                        
                                        if(!db) {
                                            setTickets(p => p.filter(t => t.id !== activeTicket.id));
                                            setHistory(p => [finished, ...p]);
                                        }
                                        setModal('print_exit'); notify('Saída registrada!');
                                    }} className="flex-1 bg-red-600 text-white py-3 rounded font-bold">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {modal === 'print_exit' && activeTicket && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-white text-black p-4 rounded w-[320px]">
                                <div id="print-area" className="ticket-paper">
                                    <div className="font-bold text-lg uppercase">{config.name}</div>
                                    <div className="text-xl font-bold my-4">RECIBO</div>
                                    <div className="text-left text-sm mb-4">
                                        <div className="flex justify-between"><span>Placa:</span><span className="font-bold">{activeTicket.plate}</span></div>
                                        <div className="flex justify-between"><span>Total:</span><span className="font-bold">{formatCurrency(activeTicket.total)}</span></div>
                                    </div>
                                    <div className="text-xs text-center">Obrigado pela preferência!</div>
                                </div>
                                <div className="flex gap-2 mt-4 no-print">
                                    <button onClick={()=>window.print()} className="flex-1 bg-blue-600 text-white py-2 rounded font-bold">Imprimir</button>
                                    <button onClick={()=>setModal(null)} className="flex-1 bg-slate-600 text-white py-2 rounded font-bold">Fechar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* LAVARÁPIDO: NOVA LAVAGEM MODAL */}
                    {modal === 'new_wash_entry' && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 p-6 rounded w-full max-w-md">
                                <h3 className="font-bold text-xl mb-4">Nova Lavagem</h3>
                                <div className="space-y-3">
                                    <div className="flex gap-2">
                                        <input className="w-full bg-slate-900 border-2 border-slate-700 p-3 rounded text-xl uppercase text-center font-bold" placeholder="ABC-1234" value={entryForm.plate} onChange={e=>setEntryForm({...entryForm, plate:e.target.value.toUpperCase()})} />
                                    </div>
                                    <div className="flex bg-slate-900 rounded p-1">
                                        <button onClick={()=>setEntryForm({...entryForm, type: 'Carro'})} className={`flex-1 py-2 rounded font-bold ${entryForm.type==='Carro'?'bg-cyan-600':'text-slate-400'}`}>Carro</button>
                                        <button onClick={()=>setEntryForm({...entryForm, type: 'Moto'})} className={`flex-1 py-2 rounded font-bold ${entryForm.type==='Moto'?'bg-cyan-600':'text-slate-400'}`}>Moto</button>
                                    </div>
                                    <input className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-base" placeholder="Modelo" value={entryForm.model} onChange={e=>setEntryForm({...entryForm, model:e.target.value})} />
                                    <button onClick={()=>{ handleEntry(); setModal(null); notify('Veículo cadastrado no Lava-rápido!'); }} className="w-full bg-emerald-600 py-3 rounded font-bold text-lg shadow-lg">Cadastrar</button>
                                </div>
                                <div className="flex justify-end mt-4"><button onClick={()=>setModal(null)} className="text-slate-400">Cancelar</button></div>
                            </div>
                        </div>
                    )}

                    {/* LAVARÁPIDO: ADD SERVIÇOS MODAL */}
                    {modal === 'service_manager' && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 w-full max-w-md p-6 rounded-xl border border-slate-700">
                                <h3 className="text-xl font-bold mb-4">Adicionar Serviços</h3>
                                <div className="space-y-2 mb-6 max-h-60 overflow-y-auto">
                                    {servicesList.map(s => {
                                        const sel = addServiceForm.selectedServices.find(x => x.id === s.id);
                                        return (
                                            <div key={s.id} onClick={() => {
                                                const current = addServiceForm.selectedServices;
                                                const updated = sel ? current.filter(x => x.id !== s.id) : [...current, s];
                                                setAddServiceForm({ ...addServiceForm, selectedServices: updated });
                                            }} className={`p-3 rounded border cursor-pointer flex justify-between ${sel ? 'bg-cyan-900 border-cyan-500' : 'bg-slate-900 border-slate-700'}`}>
                                                <span>{s.name}</span><span className="font-bold text-emerald-400">{formatCurrency(s.price)}</span>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="flex gap-2 justify-end">
                                    <button onClick={()=>setModal(null)} className="text-slate-400 px-4">Cancelar</button>
                                    <button onClick={handleAddServices} className="bg-cyan-600 text-white px-4 py-2 rounded font-bold">Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* LAVARÁPIDO: GERENCIAR TIPOS */}
                    {modal === 'service_types' && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 w-full max-w-lg p-6 rounded-xl border border-slate-700">
                                <h3 className="text-xl font-bold mb-4">Gerenciar Tipos</h3>
                                <div className="flex gap-2 mb-4">
                                    <input className="flex-1 bg-slate-900 border border-slate-700 p-3 rounded" placeholder="Nome" value={serviceConfigForm.name} onChange={e=>setServiceConfigForm({...serviceConfigForm, name:e.target.value})} />
                                    <input className="w-24 bg-slate-900 border border-slate-700 p-3 rounded" type="number" placeholder="R$" value={serviceConfigForm.price} onChange={e=>setServiceConfigForm({...serviceConfigForm, price:e.target.value})} />
                                    <button onClick={saveServiceConfig} className="bg-emerald-600 px-4 rounded font-bold">{editingServiceId ? 'OK' : '+'}</button>
                                    {editingServiceId && <button onClick={()=>{setEditingServiceId(null); setServiceConfigForm({name:'', price:0})}} className="bg-red-500 px-4 rounded font-bold">X</button>}
                                </div>
                                <div className="space-y-2 max-h-60 overflow-y-auto">
                                    {servicesList.map(s=>(
                                        <div key={s.id} className="flex justify-between items-center bg-slate-900 p-3 rounded border border-slate-700">
                                            <span>{s.name}</span>
                                            <div className="flex gap-2 items-center">
                                                <span className="text-emerald-400 font-bold">{formatCurrency(s.price)}</span>
                                                <button onClick={()=>{setServiceConfigForm({name:s.name, price:s.price}); setEditingServiceId(s.id);}} className="text-blue-400"><i className="ph-bold ph-pencil"></i></button>
                                                <button onClick={()=>removeServiceConfig(s.id)} className="text-red-400"><i className="ph-bold ph-trash"></i></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={()=>setModal(null)} className="mt-4 w-full bg-slate-700 py-2 rounded">Fechar</button>
                            </div>
                        </div>
                    )}
                    
                    {/* LAVARÁPIDO: EDITAR VEÍCULO */}
                    {modal === 'edit_ticket' && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                            <div className="bg-slate-800 p-6 rounded w-full max-w-md">
                                <h3 className="text-xl font-bold mb-4">Editar Veículo</h3>
                                <div className="space-y-3">
                                    <div className="flex gap-2">
                                        <input className="flex-1 bg-slate-900 p-3 rounded" value={editTicketForm.plate} onChange={e=>setEditTicketForm({...editTicketForm, plate:e.target.value.toUpperCase()})} />
                                        <select className="bg-slate-900 p-3 rounded" value={editTicketForm.type} onChange={e=>setEditTicketForm({...editTicketForm, type:e.target.value})}><option>Carro</option><option>Moto</option></select>
                                    </div>
                                    <input className="w-full bg-slate-900 p-3 rounded" value={editTicketForm.model} onChange={e=>setEditTicketForm({...editTicketForm, model:e.target.value})} />
                                    <textarea className="w-full bg-slate-900 p-3 rounded h-20" value={editTicketForm.notes} onChange={e=>setEditTicketForm({...editTicketForm, notes:e.target.value})}></textarea>
                                </div>
                                <div className="flex justify-end gap-2 mt-4">
                                    <button onClick={()=>setModal(null)} className="text-slate-400 px-4">Cancelar</button>
                                    <button onClick={saveTicketEdit} className="bg-cyan-600 text-white px-4 py-2 rounded font-bold">Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
