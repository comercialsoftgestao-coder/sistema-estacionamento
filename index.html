<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parking Pro - Gest√£o de Estacionamento & Lava-r√°pido</title>
    
    <!-- PWA META TAGS -->
    <meta name="theme-color" content="#0891b2">
    <meta name="description" content="Parking Pro - Gest√£o Inteligente de Estacionamento e Lava-r√°pido">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Parking Pro">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/256/75/75905.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/256/75/75905.png">

    <!-- PWA MANIFEST DYNAMIC INJECTION -->
    <script>
        (function() {
            const manifest = {
                "name": "Parking Pro - Gest√£o Master",
                "short_name": "Parking Pro",
                "start_url": "./",
                "display": "standalone",
                "background_color": "#0f172a",
                "theme_color": "#0891b2",
                "icons": [
                    {
                        "src": "https://cdn-icons-png.flaticon.com/512/3079/3079645.png",
                        "sizes": "512x512",
                        "type": "image/png"
                    }
                ]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);
        })();
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tesseract.js para OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Firebase SDKs (v10.7.1 Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; user-select: none; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
        }
        .barcode { height: 40px; width: 100%; background-image: linear-gradient(90deg, #000 2%, transparent 2%, transparent 4%, #000 4%, #000 5%, transparent 5%, transparent 6%, #000 6%, #000 8%, transparent 8%, transparent 9%, #000 9%, #000 12%, transparent 12%, transparent 13%, #000 13%, #000 15%, transparent 15%, transparent 16%, #000 16%, #000 19%, transparent 19%, transparent 20%, #000 20%, #000 23%, transparent 23%, transparent 24%, #000 24%, #000 25%, transparent 25%, transparent 26%, #000 26%, #000 29%, transparent 29%, transparent 30%, #000 30%, #000 31%, transparent 31%, transparent 32%, #000 32%, #000 35%, transparent 35%, transparent 36%, #000 36%, #000 38%, transparent 38%, transparent 39%, #000 39%, #000 42%, transparent 42%, transparent 43%, #000 43%, #000 45%, transparent 45%, transparent 46%, #000 46% ); background-size: 100% 100%; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- AMBIENTE E CONFIGURA√á√ÉO (OBRIGAT√ìRIO) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'parking-pro-master';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- SECURITY HELPER (COFRE DIGITAL) ---
        const Security = {
            encrypt: (data) => {
                if (!data) return data;
                const str = typeof data === 'object' ? JSON.stringify(data) : String(data);
                return btoa(unescape(encodeURIComponent(str)));
            },
            decrypt: (encryptedData) => {
                try {
                    if (typeof encryptedData !== 'string') return encryptedData;
                    const decoded = decodeURIComponent(escape(atob(encryptedData)));
                    try { return JSON.parse(decoded); } catch(e) { return decoded; }
                } catch (e) { return encryptedData; }
            }
        };

        // --- COMPONENTS ---
        const Toast = ({ message, type, show }) => {
            if (!show) return null;
            const colors = type === 'error' ? 'bg-red-600' : 'bg-emerald-600';
            return (
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 ${colors} text-white px-6 py-4 rounded-lg shadow-2xl z-[100] flex items-center gap-3 animate-fade-in`}>
                    <i className="ph-fill ph-info text-xl"></i>
                    <span className="font-bold">{message}</span>
                </div>
            );
        };

        const BrandLogo = ({ title }) => (
            <div className="flex items-center gap-2">
                <div className="w-10 h-10 bg-cyan-500 rounded flex items-center justify-center shadow-lg flex-shrink-0">
                    <i className="ph-fill ph-car text-white text-2xl"></i>
                </div>
                <div className="text-left">
                    <h1 className="text-lg md:text-xl font-black italic text-white uppercase truncate max-w-[180px]">
                        {title || "PARKING PRO"}
                    </h1>
                    <p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Cofre Digital Ativo</p>
                </div>
            </div>
        );

        // --- LOGIN SCREEN ---
        const LoginScreen = ({ onLogin, loginMode, setLoginMode, systemName }) => {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [email, setEmail] = useState('');

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950 px-4">
                    <div className="bg-slate-900 border border-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md">
                        <div className="flex justify-center mb-8"><BrandLogo title={systemName} /></div>
                        <h2 className="text-center text-cyan-500 font-black uppercase text-sm mb-6 tracking-widest">
                            {loginMode === 'register' ? 'Criar Identidade na Nuvem' : 'Acesso ao Cofre Master'}
                        </h2>
                        <form onSubmit={(e) => { e.preventDefault(); onLogin(u, p, email); }} className="space-y-4">
                            <div>
                                <label className="block text-xs font-black text-slate-500 uppercase mb-2 tracking-tighter">Nome de Usu√°rio (Login)</label>
                                <input className="w-full p-4 bg-slate-950 border border-slate-800 rounded-xl text-white outline-none focus:border-cyan-500" placeholder="Ex: gestor_pro" value={u} onChange={e=>setU(e.target.value)} />
                            </div>
                            {loginMode === 'register' && (
                                <div>
                                    <label className="block text-xs font-black text-slate-500 uppercase mb-2 tracking-tighter">E-mail de Recupera√ß√£o</label>
                                    <input type="email" className="w-full p-4 bg-slate-950 border border-slate-800 rounded-xl text-white outline-none focus:border-cyan-500" placeholder="seu@email.com" value={email} onChange={e=>setEmail(e.target.value)} />
                                </div>
                            )}
                            <div>
                                <label className="block text-xs font-black text-slate-500 uppercase mb-2 tracking-tighter">Sua Senha</label>
                                <input type="password" className="w-full p-4 bg-slate-950 border border-slate-800 rounded-xl text-white outline-none focus:border-cyan-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={p} onChange={e=>setP(e.target.value)} />
                            </div>
                            <button className="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-black py-4 rounded-xl uppercase tracking-widest transition-all shadow-lg active:scale-95">
                                {loginMode === 'register' ? 'Cadastrar e Abrir' : 'Entrar no Sistema'}
                            </button>
                        </form>
                        <button onClick={() => setLoginMode(loginMode === 'login' ? 'register' : 'login')} className="w-full mt-6 text-cyan-500 text-xs font-bold uppercase hover:underline">
                            {loginMode === 'login' ? 'PRIMEIRO ACESSO? CADASTRE-SE AQUI' : 'J√Å TENHO CADASTRO. FAZER LOGIN'}
                        </button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [db, setDb] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [isLogged, setIsLogged] = useState(false);
            const [userLogin, setUserLogin] = useState('');
            const [loginMode, setLoginMode] = useState('login');
            const [view, setView] = useState('loading');
            const [tab, setTab] = useState('dashboard');
            const [toast, setToast] = useState({ show: false, msg: '', type: 'info' });

            const [config, setConfig] = useState({ name: '', totalSpots: 50, priceCarHour: 15.00, priceMotoHour: 8.00, toleranceMin: 15, dailyRate: 60.00 });
            const [tickets, setTickets] = useState([]);
            const [history, setHistory] = useState([]);
            const [finances, setFinances] = useState([]);
            const [subscribers, setSubscribers] = useState([]);
            const [clients, setClients] = useState([]);
            const [team, setTeam] = useState([]);
            
            const [modal, setModal] = useState(null);
            const [activeTicket, setActiveTicket] = useState(null);
            const [paymentMethod, setPaymentMethod] = useState('Dinheiro');
            const [entryForm, setEntryForm] = useState({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] });
            const [financeForm, setFinanceForm] = useState({ type: 'Despesa', description: '', value: 0, date: '', category: 'Geral' });

            const notify = (msg, type='success') => { 
                setToast({ show: true, msg, type }); 
                setTimeout(()=>setToast(prev => ({...prev, show: false})), 3000); 
            };

            // INICIALIZA√á√ÉO FIREBASE E AUTENTICA√á√ÉO (MANDATORY PATTERN RULE 3)
            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const app = firebase.initializeApp(firebaseConfig);
                        const auth = firebase.auth(app);
                        const firestore = firebase.firestore(app);
                        setDb(firestore);

                        // Autentica√ß√£o Inicial
                        if (initialAuthToken) {
                            await auth.signInWithCustomToken(initialAuthToken);
                        } else {
                            await auth.signInAnonymously();
                        }

                        const unsubscribe = auth.onAuthStateChanged((user) => {
                            setCurrentUser(user);
                            const savedUser = localStorage.getItem('parkingpro_session_user');
                            const savedActive = localStorage.getItem('parkingpro_session_active');
                            if (savedActive === 'true' && savedUser) {
                                setUserLogin(savedUser);
                                setIsLogged(true);
                                setView('app');
                            } else {
                                setView('login');
                            }
                        });
                        return () => unsubscribe();
                    } catch (e) {
                        console.error("Firebase Init/Auth Error:", e);
                        notify("Erro ao conectar com o servi√ßo seguro.", "error");
                        setView('login');
                    }
                };
                initFirebase();
            }, []);

            // FIREBASE PATH HELPER (RULE 1)
            const getCol = (name) => {
                if (!db || !userLogin) return null;
                // Caminho obrigat√≥rio: /artifacts/{appId}/public/data/{collectionName}
                // Adicionamos o prefixo do usu√°rio para o isolamento do Cofre Digital
                return db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`${userLogin}_${name}`);
            };

            // SINCRONIZA√á√ÉO UNIFICADA
            const useSync = (name, setter) => {
                useEffect(() => {
                    if (!currentUser || !isLogged) return;
                    const col = getCol(name);
                    if (!col) return;
                    const unsubscribe = col.onSnapshot(snap => {
                        const data = snap.docs.map(doc => {
                            const d = doc.data();
                            const decrypted = d.payload ? Security.decrypt(d.payload) : d;
                            return { ...decrypted, id: doc.id };
                        });
                        setter(data);
                    }, err => console.warn(`Erro na sincroniza√ß√£o de ${name}:`, err.message));
                    return () => unsubscribe();
                }, [currentUser, isLogged, userLogin]);
            };

            useSync('config', (data) => data.length > 0 && setConfig(data[0]));
            useSync('tickets', setTickets);
            useSync('history', setHistory);
            useSync('finances', setFinances);
            useSync('subscribers', setSubscribers);
            useSync('clients', setClients);
            useSync('team', setTeam);

            const handleIdentityLogin = async (u, p, e) => {
                if (!u || !p || !currentUser) return notify("Conex√£o n√£o estabelecida", "error");
                try {
                    // Documento de seguran√ßa isolado por nome de usu√°rio
                    const statusDoc = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`${u}_security`).doc('status');
                    const snap = await statusDoc.get();

                    if (loginMode === 'register') {
                        if (snap.exists) return notify("Este usu√°rio j√° existe", "error");
                        await statusDoc.set({ payload: Security.encrypt({ login: u, pass: Security.encrypt(p), email: e, createdAt: new Date().toISOString() }) });
                        notify("Identidade criada! Entre agora.");
                        setLoginMode('login');
                        return;
                    }

                    if (!snap.exists) return notify("Usu√°rio n√£o encontrado", "error");
                    const data = Security.decrypt(snap.data().payload);
                    if (Security.decrypt(data.pass) === p) {
                        setUserLogin(u);
                        setIsLogged(true);
                        localStorage.setItem('parkingpro_session_active', 'true');
                        localStorage.setItem('parkingpro_session_user', u);
                        setView('app');
                    } else notify("Senha incorreta", "error");
                } catch (err) { 
                    console.error("Login Error:", err);
                    notify("Erro ao acessar o Cofre Digital.", "error"); 
                }
            };

            const saveItem = async (colName, item, idOverride) => {
                if (!currentUser) return;
                const col = getCol(colName);
                if (!col) return;
                const id = idOverride || String(Date.now());
                // Criptografia Master antes de salvar
                await col.doc(id).set({ payload: Security.encrypt(item) });
            };

            const deleteItem = async (colName, id) => {
                const col = getCol(colName);
                if (col) await col.doc(String(id)).delete();
            };

            // --- L√ìGICA DE NEG√ìCIO ---
            const handleEntry = () => { 
                if (!entryForm.plate) return notify('Placa √© obrigat√≥ria', 'error'); 
                const entryDateObj = entryForm.manualEntry ? new Date(entryForm.manualEntry) : new Date(); 
                const isSub = subscribers.find(s => s.plate === entryForm.plate.toUpperCase() && s.active); 
                const loyaltyClient = clients.find(c => c.plate === entryForm.plate.toUpperCase()); 
                
                if (loyaltyClient) { 
                    const updated = { ...loyaltyClient, points: (loyaltyClient.points || 0) + 1 }; 
                    saveItem('clients', updated, updated.id); 
                } 
                
                const newTicket = { id: Date.now(), plate: entryForm.plate.toUpperCase(), model: entryForm.model, type: entryForm.type, entryTime: entryDateObj.toISOString(), isSubscriber: !!isSub, isLoyalty: !!loyaltyClient, notes: entryForm.notes, status: 'active', damages: entryForm.damages || [], services: [] }; 

                if (entryForm.manualExit) {
                    const exitDateObj = new Date(entryForm.manualExit);
                    const diffMins = Math.floor((exitDateObj - entryDateObj) / 60000);
                    const diffHours = Math.ceil(diffMins / 60);
                    let total = 0;
                    if (!isSub && diffMins > config.toleranceMin) {
                        const rate = entryForm.type === 'Carro' ? config.priceCarHour : config.priceMotoHour;
                        total = diffHours >= 8 ? config.dailyRate : diffHours * rate;
                    }
                    saveItem('history', { ...newTicket, exitTime: exitDateObj.toISOString(), total, status: 'finished' });
                    setEntryForm({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] });
                    notify('Hist√≥rico registrado!');
                    return;
                }
                saveItem('tickets', newTicket);
                setEntryForm({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] });
                setActiveTicket(newTicket);
                setModal('print_entry');
                notify('Entrada registrada!');
            };

            const confirmExit = () => { 
                const finished = {...activeTicket, paymentMethod, exitTime: new Date().toISOString(), status: 'finished'}; 
                saveItem('history', finished); 
                deleteItem('tickets', activeTicket.id);
                setModal('print_exit'); notify('Sa√≠da conclu√≠da!'); 
            };

            const stats = useMemo(() => {
                const occupied = tickets.length;
                const free = (config.totalSpots || 50) - occupied;
                const revenue = history.filter(h => new Date(h.exitTime).toDateString() === new Date().toDateString()).reduce((a,b)=>a+(b.total||0), 0);
                return { occupied, free, revenue };
            }, [tickets, history, config]);

            if (view === 'loading') return <div className="h-screen bg-slate-950 flex items-center justify-center text-cyan-500 font-bold animate-pulse uppercase tracking-widest">Sincronizando Cofre Master...</div>;
            if (!isLogged) return <LoginScreen onLogin={handleIdentityLogin} loginMode={loginMode} setLoginMode={setLoginMode} systemName={config.name} />;

            return (
                <div className="flex h-screen bg-slate-900 text-slate-100 font-sans overflow-hidden">
                    <Toast {...toast} />
                    
                    <aside className="w-64 bg-slate-950 border-r border-slate-800 p-6 flex flex-col">
                        <BrandLogo title={config.name} />
                        <nav className="mt-10 space-y-2 flex-1">
                            {['dashboard', 'patio', 'finance', 'config'].map(t => (
                                <button key={t} onClick={() => setTab(t)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all ${tab === t ? 'bg-cyan-600 text-white shadow-lg shadow-cyan-900/40' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                    <i className={`ph-bold ph-${t === 'patio' ? 'car' : (t === 'finance' ? 'currency-dollar' : (t === 'config' ? 'gear' : 'gauge'))} text-xl`}></i>
                                    <span className="capitalize">{t}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="pt-6 border-t border-slate-800 text-center">
                            <p className="text-[10px] text-slate-500 uppercase font-black tracking-tighter">ID: {userLogin}</p>
                            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="mt-2 text-red-500 text-[10px] font-bold uppercase hover:underline">Sair do Sistema</button>
                        </div>
                    </aside>

                    <main className="flex-1 overflow-y-auto p-8 relative">
                        <header className="flex justify-between items-center mb-10">
                            <h2 className="text-2xl font-black uppercase tracking-widest text-cyan-500 italic">{tab}</h2>
                            <div className="text-right">
                                <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Vagas Livres</p>
                                <p className={`text-2xl font-black ${stats.free < 5 ? 'text-red-500' : 'text-emerald-400'}`}>{stats.free} <span className="text-sm font-normal text-slate-600">/ {config.totalSpots}</span></p>
                            </div>
                        </header>

                        {tab === 'dashboard' && (
                            <div className="space-y-8 animate-fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-slate-800 p-6 rounded-2xl border-t-4 border-cyan-500 shadow-xl">
                                        <p className="text-xs text-slate-400 uppercase font-black">Ocupa√ß√£o Atual</p>
                                        <h3 className="text-4xl font-black mt-2">{stats.occupied}</h3>
                                    </div>
                                    <div className="bg-slate-800 p-6 rounded-2xl border-t-4 border-emerald-500 shadow-xl">
                                        <p className="text-xs text-slate-400 uppercase font-black">Receita Hoje</p>
                                        <h3 className="text-4xl font-black mt-2">R$ {stats.revenue.toFixed(2)}</h3>
                                    </div>
                                    <div className="bg-slate-800 p-6 rounded-2xl border-t-4 border-violet-500 shadow-xl">
                                        <p className="text-xs text-slate-400 uppercase font-black">Prote√ß√£o</p>
                                        <h3 className="text-lg font-black mt-2 text-cyan-400">COFRE ATIVO ‚úì</h3>
                                    </div>
                                </div>

                                <div className="bg-gradient-to-br from-gray-900 to-black p-8 rounded-3xl border border-cyan-900/30 shadow-2xl flex flex-col md:flex-row items-center justify-between gap-6">
                                    <div className="flex items-center gap-6">
                                        <div className="text-5xl">üõ°Ô∏è</div>
                                        <div>
                                            <h4 className="text-2xl font-black uppercase italic text-white tracking-tighter">Cofre Digital Parking Pro</h4>
                                            <p className="text-slate-400 font-bold text-sm">Dados criptografados e isolados por Identidade Master.</p>
                                        </div>
                                    </div>
                                    <a href="https://wa.me/5511932186193" target="_blank" className="bg-emerald-600 px-8 py-4 rounded-2xl font-black uppercase text-xs hover:scale-105 transition-all shadow-lg shadow-emerald-900/30 flex items-center gap-2">
                                        <i className="ph-bold ph-whatsapp-logo text-lg"></i> Suporte Master
                                    </a>
                                </div>
                            </div>
                        )}

                        {tab === 'patio' && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in">
                                <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 h-fit shadow-2xl">
                                    <h3 className="font-black uppercase mb-6 text-cyan-500 tracking-widest italic">Nova Entrada</h3>
                                    <div className="space-y-4">
                                        <input className="w-full p-4 bg-slate-950 border border-slate-700 rounded-xl text-center text-3xl font-mono text-white uppercase focus:border-cyan-500 outline-none" placeholder="PLACA" value={entryForm.plate} onChange={e=>setEntryForm({...entryForm, plate:e.target.value.toUpperCase()})} />
                                        <input className="w-full p-4 bg-slate-950 border border-slate-700 rounded-xl text-white outline-none focus:border-cyan-500" placeholder="Modelo do Ve√≠culo" value={entryForm.model} onChange={e=>setEntryForm({...entryForm, model:e.target.value})} />
                                        <button onClick={handleEntry} className="w-full bg-cyan-600 py-5 rounded-xl font-black uppercase shadow-lg hover:bg-cyan-500 active:scale-95 transition-all">Registrar no Cofre</button>
                                    </div>
                                </div>
                                <div className="lg:col-span-2 space-y-4">
                                    <h3 className="font-black uppercase mb-4 tracking-widest text-slate-400 italic">No P√°tio Agora</h3>
                                    {tickets.length === 0 && <p className="text-slate-600 italic">Nenhum ve√≠culo registrado no momento.</p>}
                                    {tickets.map(t => (
                                        <div key={t.id} className="bg-slate-800 p-6 rounded-2xl border border-slate-700 flex justify-between items-center hover:border-cyan-500 transition-all group shadow-lg">
                                            <div className="flex items-center gap-5">
                                                <div className="w-14 h-14 bg-slate-900 rounded-xl flex items-center justify-center text-2xl text-cyan-500 shadow-inner group-hover:bg-cyan-600 group-hover:text-white transition-all"><i className="ph-fill ph-car"></i></div>
                                                <div>
                                                    <h4 className="font-black text-2xl font-mono tracking-tighter">{t.plate}</h4>
                                                    <p className="text-[10px] text-slate-500 uppercase font-bold tracking-widest">{t.model || 'Ve√≠culo Master'} ‚Ä¢ {new Date(t.entryTime).toLocaleTimeString()}</p>
                                                </div>
                                            </div>
                                            <button onClick={() => {
                                                const now = new Date();
                                                const entry = new Date(t.entryTime);
                                                const diffHours = Math.ceil((now - entry) / (1000 * 60 * 60));
                                                const total = diffHours * config.priceCarHour;
                                                setActiveTicket({...t, exitTime: now.toISOString(), total, parkingFee: total, durationHours: diffHours});
                                                setModal('confirm_exit');
                                            }} className="bg-red-600 hover:bg-red-500 px-6 py-3 rounded-xl font-black uppercase text-xs shadow-lg transition-all active:scale-95">Finalizar</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {tab === 'finance' && (
                             <div className="space-y-6 animate-fade-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-black uppercase tracking-widest text-slate-400 italic">Movimenta√ß√µes</h3>
                                    <button onClick={() => { setFinanceForm({type:'Despesa', description:'', value:0, date: new Date().toISOString().split('T')[0], category:'Geral'}); setModal('finance'); }} className="bg-emerald-600 px-6 py-3 rounded-xl font-black uppercase text-xs shadow-lg">Lan√ßar Avulso</button>
                                </div>
                                <div className="bg-slate-800 rounded-2xl overflow-hidden border border-slate-700 shadow-xl">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-950 text-slate-500 text-[10px] font-black uppercase tracking-widest">
                                            <tr><th className="p-4">Data</th><th className="p-4">Descri√ß√£o</th><th className="p-4">Tipo</th><th className="p-4 text-right">Valor</th></tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-700">
                                            {[...history.map(h => ({date: h.exitTime, desc: `Venda Ticket ${h.plate}`, type: 'Receita', value: h.total})), ...finances]
                                                .sort((a,b) => new Date(b.date) - new Date(a.date))
                                                .map((item, idx) => (
                                                <tr key={idx} className="hover:bg-slate-700/30 transition-all group">
                                                    <td className="p-4 text-slate-500 text-xs font-bold">{new Date(item.date).toLocaleDateString()}</td>
                                                    <td className="p-4 font-black uppercase text-sm">{item.desc || item.description}</td>
                                                    <td className="p-4"><span className={`px-2 py-1 rounded-md text-[10px] font-black uppercase ${item.type === 'Receita' ? 'bg-emerald-900/30 text-emerald-400' : 'bg-red-900/30 text-red-400'}`}>{item.type}</span></td>
                                                    <td className={`p-4 text-right font-black ${item.type === 'Receita' ? 'text-emerald-400' : 'text-red-400'}`}>R$ {(item.value || 0).toFixed(2)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                             </div>
                        )}

                        {tab === 'config' && (
                            <div className="max-w-2xl bg-slate-800 p-8 rounded-3xl border border-slate-700 animate-fade-in shadow-2xl">
                                <h3 className="font-black uppercase mb-8 text-cyan-500 italic tracking-widest">Ajustes Master</h3>
                                <div className="space-y-6">
                                    <div><label className="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Nome Fantasia</label><input className="w-full p-4 bg-slate-950 border border-slate-700 rounded-xl text-white outline-none focus:border-cyan-500" value={config.name} onChange={e=>setConfig({...config, name:e.target.value})} /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Vagas Totais</label><input type="number" className="w-full p-4 bg-slate-950 border border-slate-700 rounded-xl text-white outline-none" value={config.totalSpots} onChange={e=>setConfig({...config, totalSpots:parseInt(e.target.value)})} /></div>
                                        <div><label className="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Valor Hora (R$)</label><input type="number" className="w-full p-4 bg-slate-950 border border-slate-700 rounded-xl text-white outline-none" value={config.priceCarHour} onChange={e=>setConfig({...config, priceCarHour:parseFloat(e.target.value)})} /></div>
                                    </div>
                                    <button onClick={() => { saveItem('config', config, 'current'); notify("Configura√ß√µes atualizadas no Cofre!"); }} className="w-full bg-cyan-600 py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg shadow-cyan-900/30 hover:bg-cyan-500 active:scale-95 transition-all">Salvar no Cofre Digital</button>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* MODAIS */}
                    {modal && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 no-print">
                            {modal === 'print_entry' && activeTicket && (
                                <div className="bg-white text-black p-6 rounded-2xl max-w-sm w-full relative shadow-2xl">
                                    <button onClick={() => setModal(null)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-900"><i className="ph-bold ph-x text-2xl"></i></button>
                                    <div id="print-area" className="text-center font-mono py-4">
                                        <h2 className="font-black text-2xl tracking-tighter uppercase">{config.name || 'PARKING PRO'}</h2>
                                        <div className="my-6 border-b-2 border-dashed border-black"></div>
                                        <h3 className="text-4xl font-black tracking-tighter uppercase mb-2">{activeTicket.plate}</h3>
                                        <p className="text-xs uppercase font-bold text-slate-600">{activeTicket.model || 'SISTEMA MASTER'}</p>
                                        <p className="text-[10px] mt-6 font-bold">ENTRADA: {new Date(activeTicket.entryTime).toLocaleString()}</p>
                                        <div className="barcode mt-8"></div>
                                        <p className="text-[8px] mt-6 uppercase font-bold tracking-widest">Obrigado pela prefer√™ncia</p>
                                    </div>
                                    <button onClick={() => window.print()} className="w-full bg-cyan-600 text-white font-black py-5 rounded-2xl mt-6 uppercase text-xs tracking-widest shadow-xl">Imprimir Ticket</button>
                                </div>
                            )}

                            {modal === 'confirm_exit' && activeTicket && (
                                <div className="bg-slate-800 text-white p-8 rounded-3xl max-w-md w-full border border-slate-700 shadow-2xl animate-fade-in">
                                    <h3 className="text-xl font-black uppercase italic tracking-tighter mb-8 text-cyan-500">Encerrar: {activeTicket.plate}</h3>
                                    <div className="space-y-4 mb-8">
                                        <div className="flex justify-between border-b border-slate-700 pb-3"><span className="text-slate-400 text-xs font-bold uppercase tracking-widest">Tempo Total</span><span className="font-black text-sm">{activeTicket.durationHours}h</span></div>
                                        <div className="flex justify-between items-center"><span className="text-sm font-bold uppercase text-slate-400 tracking-widest">Valor Master</span><span className="text-4xl font-black text-emerald-400 tracking-tighter">R$ {(activeTicket.total||0).toFixed(2)}</span></div>
                                        <div className="pt-6"><label className="text-[10px] font-black text-slate-500 uppercase mb-3 block tracking-widest">Pagamento</label>
                                            <select className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white outline-none focus:border-cyan-500 font-bold" value={paymentMethod} onChange={e=>setPaymentMethod(e.target.value)}>
                                                <option>Dinheiro</option><option>PIX</option><option>Cart√£o Cr√©dito</option><option>Cart√£o D√©bito</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={()=>setModal(null)} className="flex-1 bg-slate-700 py-4 rounded-xl font-black uppercase text-xs tracking-widest shadow-lg">Cancelar</button>
                                        <button onClick={confirmExit} className="flex-1 bg-emerald-600 py-4 rounded-xl font-black uppercase text-xs tracking-widest shadow-lg shadow-emerald-900/20 active:scale-95 transition-all">Confirmar e Finalizar</button>
                                    </div>
                                </div>
                            )}

                            {modal === 'finance' && (
                                <div className="bg-slate-800 w-full max-w-md p-8 rounded-3xl border border-slate-700 shadow-2xl">
                                    <h3 className="text-xl font-black text-white mb-8 uppercase tracking-tighter italic text-cyan-500">Lan√ßamento no Cofre</h3>
                                    <div className="space-y-5">
                                        <div><label className="text-[10px] font-black text-slate-500 uppercase mb-2 block tracking-widest">Tipo</label>
                                            <select className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white font-bold" value={financeForm.type} onChange={e=>setFinanceForm({...financeForm, type:e.target.value})}><option>Receita</option><option>Despesa</option></select>
                                        </div>
                                        <div><label className="text-[10px] font-black text-slate-500 uppercase mb-2 block tracking-widest">Descri√ß√£o</label>
                                            <input className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white outline-none focus:border-cyan-500" placeholder="Ex: Pagamento de Luz" value={financeForm.description} onChange={e=>setFinanceForm({...financeForm, description:e.target.value})} />
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-[10px] font-black text-slate-500 uppercase mb-2 block tracking-widest">Valor (R$)</label>
                                                <input className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white" type="number" placeholder="0.00" value={financeForm.value} onChange={e=>setFinanceForm({...financeForm, value:parseFloat(e.target.value)})} />
                                            </div>
                                            <div><label className="text-[10px] font-black text-slate-500 uppercase mb-2 block tracking-widest">Data</label>
                                                <input className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white" type="date" value={financeForm.date} onChange={e=>setFinanceForm({...financeForm, date:e.target.value})} />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex justify-end gap-4 mt-10">
                                        <button onClick={()=>setModal(null)} className="text-slate-500 font-black text-xs uppercase tracking-widest">Cancelar</button>
                                        <button onClick={() => { saveItem('finances', financeForm); setModal(null); notify("Lan√ßamento registrado!"); }} className="bg-emerald-600 text-white px-8 py-3 rounded-xl font-black uppercase text-xs shadow-lg">Salvar Agora</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
