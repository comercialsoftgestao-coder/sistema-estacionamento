<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parking Pro - Gestão de Estacionamento & Lava-rápido</title>
    
    <!-- PWA META TAGS -->
    <meta name="theme-color" content="#0891b2">
    <meta name="description" content="Parking Pro - Gestão Inteligente de Estacionamento e Lava-rápido">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Parking Pro">
    
    <!-- ÍCONE ATUALIZADO -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/256/75/75905.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tesseract.js para OCR (Leitura de Placas) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Firebase App, Auth & Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; user-select: none; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            .no-print { display: none !important; }
        }
        .barcode {
            height: 40px;
            width: 100%;
            background-image: linear-gradient(90deg, #000 2%, transparent 2%, transparent 4%, #000 4%, #000 5%, transparent 5%, transparent 6%, #000 6%, #000 8%, transparent 8%, transparent 9%, #000 9%, #000 12%, transparent 12%, transparent 13%, #000 13%, #000 15%, transparent 15%, transparent 16%, #000 16%, #000 19%, transparent 19%, transparent 20%, #000 20%, #000 23%, transparent 23%, transparent 24%, #000 24%, #000 25%, transparent 25%, transparent 26%, #000 26%, #000 29%, transparent 29%, transparent 30%, #000 30%, #000 31%, transparent 31%, transparent 32%, #000 32%, #000 35%, transparent 35%, transparent 36%, #000 36%, #000 38%, transparent 38%, transparent 39%, #000 39%, #000 42%, transparent 42%, transparent 43%, #000 43%, #000 45%, transparent 45%, transparent 46%, #000 46%);
            background-size: 100% 100%;
        }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator, input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>

    <!-- GERAÇÃO DINÂMICA DO MANIFESTO (Correção de start_url) -->
    <script>
        (function() {
            const manifest = {
                "name": "Parking Pro",
                "short_name": "ParkingPro",
                "start_url": window.location.href,
                "display": "standalone",
                "background_color": "#0f172a",
                "theme_color": "#0891b2",
                "icons": [{
                    "src": "https://cdn-icons-png.flaticon.com/256/75/75905.png",
                    "sizes": "256x256",
                    "type": "image/png"
                }]
            };
            const stringManifest = JSON.stringify(manifest);
            const blob = new Blob([stringManifest], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            manifestLink.href = manifestURL;
            document.head.appendChild(manifestLink);
        })();
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- COFRE DIGITAL (Criptografia de Dados) ---
        const Vault = {
            encrypt: (data) => {
                const str = JSON.stringify(data);
                return btoa(unescape(encodeURIComponent(str))); // Base64 Safe
            },
            decrypt: (cipher) => {
                try {
                    const str = decodeURIComponent(escape(atob(cipher)));
                    return JSON.parse(str);
                } catch(e) { return null; }
            }
        };

        const Toast = ({ message, type, show, onClose }) => {
            if (!show) return null;
            const colors = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-emerald-600' : 'bg-cyan-600');
            return (
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 md:left-auto md:translate-x-0 md:right-4 ${colors} text-white px-6 py-4 rounded-lg shadow-2xl z-[70] flex items-center gap-3 animate-fade-in w-[90%] md:w-auto`}>
                    <i className="ph-fill ph-shield-check text-xl"></i>
                    <span className="font-bold text-sm md:text-base">{message}</span>
                </div>
            );
        };

        const ParkingChart = ({ historyData, financeData }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);
            useEffect(() => {
                if (!canvasRef.current) return;
                if (chartRef.current) chartRef.current.destroy();
                const ctx = canvasRef.current.getContext('2d');
                const last7Days = [...Array(7)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toLocaleDateString('pt-BR');
                }).reverse();
                const parkingRevenue = last7Days.map(date => (historyData || []).filter(h => new Date(h.exitTime).toLocaleDateString('pt-BR') === date).reduce((acc, curr) => acc + (curr.total || 0), 0));
                const expensesData = last7Days.map(date => (financeData || []).filter(f => f.type === 'Despesa' && new Date(f.date + 'T12:00:00').toLocaleDateString('pt-BR') === date).reduce((acc, curr) => acc + (curr.value || 0), 0));
                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: last7Days, datasets: [
                        { label: 'Receita', data: parkingRevenue, backgroundColor: '#0891b2', borderRadius: 4 },
                        { label: 'Despesas', data: expensesData, backgroundColor: '#ef4444', borderRadius: 4 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: '#cbd5e1', font: { size: 10 } } } }, scales: { y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', font: { size: 10 } } }, x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } } } }
                });
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [historyData, financeData]);
            return <div className="h-64 w-full"><canvas ref={canvasRef}></canvas></div>;
        };

        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);

        const BrandLogo = ({ title }) => {
            const displayText = title && title.trim() !== '' ? title : "PARKING PRO";
            return (
                <div className="flex items-center gap-2">
                    <div className="w-8 h-8 md:w-10 md:h-10 bg-cyan-500 rounded flex items-center justify-center shadow-lg shadow-cyan-900/50 flex-shrink-0">
                        <i className="ph-fill ph-shield-check text-white text-xl md:text-2xl"></i>
                    </div>
                    <div className="min-w-0">
                        <h1 className="text-lg md:text-xl font-black italic tracking-tighter text-white leading-none uppercase truncate max-w-[180px]">{displayText}</h1>
                        <p className="text-[8px] md:text-[9px] text-cyan-400 font-bold uppercase tracking-widest">Identidade Master</p>
                    </div>
                </div>
            );
        };

        // --- TELA DE LOGIN MASTER ---
        const LoginScreen = ({ onLogin, systemName }) => {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [isSignup, setIsSignup] = useState(false);
            const handleSubmit = (e) => { e.preventDefault(); onLogin(u, p, isSignup); };
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950 relative overflow-hidden px-4">
                    <div className="bg-slate-900/90 backdrop-blur-xl p-8 rounded-2xl shadow-2xl w-full max-w-sm z-10 border border-slate-800">
                        <div className="flex justify-center mb-6"><BrandLogo title={systemName} /></div>
                        <h2 className="text-center text-slate-400 mb-6 text-sm font-bold uppercase">{isSignup ? 'Criar Identidade Digital' : 'Acessar Cofre Digital'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full p-3 bg-slate-950 border border-slate-800 rounded text-white focus:border-cyan-500 outline-none transition" placeholder="E-mail" value={u} onChange={e=>setU(e.target.value)} required type="email" />
                            <input type="password" className="w-full p-3 bg-slate-950 border border-slate-800 rounded text-white focus:border-cyan-500 outline-none transition" placeholder="Senha Master" value={p} onChange={e=>setP(e.target.value)} required />
                            <button className="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded transition-all shadow-lg active:scale-95">{isSignup ? 'CADASTRAR IDENTIDADE' : 'ABRIR COFRE'}</button>
                        </form>
                        <button onClick={() => setIsSignup(!isSignup)} className="w-full mt-4 text-xs text-slate-500 hover:text-cyan-400 transition underline">
                            {isSignup ? 'Já tenho uma Identidade' : 'Não tenho Identidade Master'}
                        </button>
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('loading');
            const [user, setUser] = useState(null);
            const [toast, setToast] = useState({ show: false, msg: '', type: 'info' });
            const notify = (msg, type='success') => { setToast({ show: true, msg, type }); setTimeout(()=>setToast(t=>({...t, show: false})), 3000); };

            const [config, setConfig] = useState({ name: 'PARKING PRO', address: 'Av. Paulista, 1000 - SP', totalSpots: 50, priceCarHour: 15, priceMotoHour: 8, toleranceMin: 15, dailyRate: 60 });
            const [tickets, setTickets] = useState([]);
            const [history, setHistory] = useState([]);
            const [subscribers, setSubscribers] = useState([]);
            const [agreements, setAgreements] = useState([]);
            const [finances, setFinances] = useState([]);
            const [servicesList, setServicesList] = useState([]);

            const [tab, setTab] = useState('dashboard');
            const [modal, setModal] = useState(null);
            const [activeTicket, setActiveTicket] = useState(null);
            const [filterPlate, setFilterPlate] = useState('');
            const [paymentMethod, setPaymentMethod] = useState('Dinheiro');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [db, setDb] = useState(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'parking-master-id';

            const [entryForm, setEntryForm] = useState({ plate: '', model: '', type: 'Carro', notes: '', damages: [] });
            const [financeForm, setFinanceForm] = useState({ type: 'Despesa', description: '', value: 0, date: '', category: 'Geral' });
            const [addServiceForm, setAddServiceForm] = useState({ ticketId: '', selectedServices: [] });

            // --- INICIALIZAÇÃO FIREBASE (Isolamento Total) ---
            useEffect(() => {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "AIzaSyDYdrt4kbKtyPbx7ipHHb7wftUAlKeOZeE",
                    authDomain: "estacionamento-332eb.firebaseapp.com",
                    projectId: "estacionamento-332eb",
                    storageBucket: "estacionamento-332eb.firebasestorage.app",
                    messagingSenderId: "467691522256",
                    appId: "1:467691522256:web:6d4495458c494e753cb6d5"
                };
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const firestore = firebase.firestore();
                setDb(firestore);

                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (u) setView('app');
                    else setView('login');
                });
                return () => unsubscribe();
            }, []);

            // --- SINCRONIZAÇÃO ISOLADA E CRIPTOGRAFADA ---
            const useSync = (colName, setState) => {
                useEffect(() => {
                    if (db && user) {
                        // Caminho Privado: /artifacts/appId/users/userId/collection
                        const path = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection(colName);
                        const unsubscribe = path.onSnapshot(snap => {
                            const data = snap.docs.map(doc => {
                                const raw = doc.data();
                                return raw.v ? { ...Vault.decrypt(raw.v), id: doc.id } : { ...raw, id: doc.id };
                            });
                            setState(data);
                        }, err => console.error("Snapshot error:", err));
                        return () => unsubscribe();
                    }
                }, [db, user]);
            };

            useSync('tickets', setTickets);
            useSync('history', setHistory);
            useSync('finances', setFinances);
            useSync('subscribers', setSubscribers);
            useSync('agreements', setAgreements);
            useSync('servicesList', setServicesList);

            const saveItem = async (col, item, idOverride) => {
                if (!db || !user) return;
                const id = idOverride ? String(idOverride) : String(item.id || Date.now());
                const encrypted = { v: Vault.encrypt(item) };
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection(col).doc(id).set(encrypted);
            };

            const deleteItem = async (col, id) => {
                if (!db || !user) return;
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection(col).doc(String(id)).delete();
            };

            const handleLogin = async (email, pass, isSignup) => {
                try {
                    const auth = firebase.auth();
                    if (isSignup) await auth.createUserWithEmailAndPassword(email, pass);
                    else await auth.signInWithEmailAndPassword(email, pass);
                    notify('Cofre Digital Aberto!');
                } catch (e) {
                    notify(e.message, 'error');
                }
            };

            const logout = () => { firebase.auth().signOut(); notify('Sessão Encerrada'); };

            const handleEntry = () => {
                if (!entryForm.plate) return notify('Placa obrigatória', 'error');
                const isSub = subscribers.find(s => s.plate === entryForm.plate.toUpperCase() && s.active);
                const newTicket = { id: Date.now(), plate: entryForm.plate.toUpperCase(), model: entryForm.model, type: entryForm.type, entryTime: new Date().toISOString(), isSubscriber: !!isSub, damages: entryForm.damages || [], services: [], status: 'active' };
                saveItem('tickets', newTicket);
                setEntryForm({ plate: '', model: '', type: 'Carro', notes: '', damages: [] });
                setActiveTicket(newTicket);
                setModal('print_entry');
                notify('Veículo Registrado!');
            };

            const prepareExit = (ticket) => {
                const now = new Date();
                const entry = new Date(ticket.entryTime);
                const diffMins = Math.floor((now - entry) / 60000);
                const diffHours = Math.ceil(diffMins / 60);
                let parkingFee = 0;
                if (!ticket.isSubscriber) {
                    if (diffMins > config.toleranceMin) {
                        const rate = ticket.type === 'Carro' ? config.priceCarHour : config.priceMotoHour;
                        parkingFee = diffHours >= 8 ? config.dailyRate : diffHours * rate;
                    }
                }
                const servicesFee = (ticket.services || []).reduce((acc, s) => acc + s.price, 0);
                const total = parkingFee + servicesFee;
                setActiveTicket({ ...ticket, exitTime: now.toISOString(), durationHours: diffHours, total });
                setModal('confirm_exit');
            };

            const confirmExit = () => {
                const finished = { ...activeTicket, paymentMethod, status: 'finished' };
                saveItem('history', finished);
                deleteItem('tickets', activeTicket.id);
                setModal('print_exit'); notify('Saída Concluída');
            };

            if (view === 'loading') return <div className="h-screen bg-slate-950 flex flex-col items-center justify-center gap-4"><div className="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div><p className="text-cyan-400 font-bold tracking-widest animate-pulse">VALIDANDO COFRE...</p></div>;
            if (view === 'login') return <LoginScreen onLogin={handleLogin} systemName={config.name} />;

            return (
                <div className="flex h-screen overflow-hidden bg-slate-900 text-slate-100">
                    <Toast {...toast} onClose={()=>setToast(t=>({...t, show:false}))} />
                    
                    {/* SIDEBAR */}
                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-950 transition-transform md:relative md:translate-x-0 flex flex-col ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-slate-800 flex justify-between items-center">
                            <BrandLogo title={config.name} />
                            <button className="md:hidden text-slate-400" onClick={() => setIsMobileMenuOpen(false)}><i className="ph-bold ph-x text-2xl"></i></button>
                        </div>
                        <nav className="flex-1 p-4 space-y-1">
                            {[
                                { id: 'dashboard', label: 'Visão Geral', icon: 'gauge' },
                                { id: 'patio', label: 'Pátio & Entrada', icon: 'car-profile' },
                                { id: 'carwash', label: 'Lava-rápido', icon: 'drop-half' },
                                { id: 'finance', label: 'Financeiro', icon: 'currency-dollar' },
                                { id: 'config', label: 'Configurações', icon: 'gear' }
                            ].map(item => (
                                <button key={item.id} onClick={() => { setTab(item.id); setIsMobileMenuOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition ${tab === item.id ? 'bg-cyan-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                    <i className={`ph ph-${item.icon} text-xl`}></i> {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 space-y-2">
                             <div className="bg-emerald-500/10 border border-emerald-500/30 p-3 rounded-lg text-center">
                                <p className="text-[10px] text-emerald-400 font-black uppercase tracking-tighter flex items-center justify-center gap-1">
                                    <i className="ph-fill ph-lock-key"></i> COFRE ATIVO & PROTEGIDO
                                </p>
                             </div>
                             <button onClick={logout} className="w-full py-3 text-slate-500 hover:text-red-400 font-bold text-xs flex items-center justify-center gap-2 transition">
                                <i className="ph-bold ph-sign-out"></i> SAIR DA IDENTIDADE
                             </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden">
                        <header className="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6">
                            <div className="flex items-center gap-3">
                                <button className="md:hidden text-slate-300" onClick={() => setIsMobileMenuOpen(true)}><i className="ph-bold ph-list text-2xl"></i></button>
                                <h2 className="text-xl font-bold uppercase">{tab === 'dashboard' ? 'Painel Master' : tab}</h2>
                            </div>
                            <div className="flex items-center gap-4">
                                <a href="https://wa.me/5511932186193" target="_blank" className="hidden md:flex bg-emerald-600 px-4 py-1.5 rounded-full text-xs font-bold items-center gap-2 hover:bg-emerald-500 transition shadow-lg">
                                    <i className="ph-bold ph-whatsapp-logo"></i> SUPORTE MASTER
                                </a>
                                <div className="text-right">
                                    <p className="text-[10px] text-slate-500 font-bold uppercase">Sessão</p>
                                    <p className="text-xs font-black text-cyan-400 truncate max-w-[120px]">{user?.email}</p>
                                </div>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-6 bg-slate-900">
                            {tab === 'dashboard' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-cyan-500 shadow-xl">
                                            <p className="text-xs text-slate-400 uppercase font-bold">Ocupação</p>
                                            <h3 className="text-3xl font-bold mt-2">{tickets.length} <span className="text-sm font-normal text-slate-500">vagas</span></h3>
                                        </div>
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-emerald-500 shadow-xl">
                                            <p className="text-xs text-slate-400 uppercase font-bold">Receita Hoje</p>
                                            <h3 className="text-3xl font-bold text-emerald-400 mt-2">{formatCurrency(history.filter(h => new Date(h.exitTime).toDateString() === new Date().toDateString()).reduce((a,c)=>a+c.total,0))}</h3>
                                        </div>
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-red-500 shadow-xl">
                                            <p className="text-xs text-slate-400 uppercase font-bold">Despesas</p>
                                            <h3 className="text-3xl font-bold text-red-400 mt-2">{formatCurrency(finances.filter(f => f.type === 'Despesa').reduce((a,c)=>a+c.value,0))}</h3>
                                        </div>
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-blue-500 shadow-xl">
                                            <p className="text-xs text-slate-400 uppercase font-bold">Vagas Livres</p>
                                            <h3 className="text-3xl font-bold text-blue-400 mt-2">{config.totalSpots - tickets.length}</h3>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                            <h3 className="font-bold text-lg mb-4">Fluxo de Caixa</h3>
                                            <ParkingChart historyData={history} financeData={finances} />
                                        </div>
                                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                            <h3 className="font-bold text-lg mb-4">Recentes no Pátio</h3>
                                            <div className="space-y-3">
                                                {tickets.slice(0, 5).map(t => (
                                                    <div key={t.id} className="flex justify-between items-center p-3 bg-slate-900 rounded-lg">
                                                        <span className="font-mono font-bold text-cyan-400">{t.plate}</span>
                                                        <span className="text-xs text-slate-500">{new Date(t.entryTime).toLocaleTimeString()}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {tab === 'patio' && (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 shadow-2xl h-fit">
                                        <h3 className="font-bold text-xl text-cyan-400 mb-6 flex items-center gap-2"><i className="ph-bold ph-gate"></i> Registro de Entrada</h3>
                                        <div className="space-y-4">
                                            <input className="w-full bg-slate-900 border-2 border-slate-700 p-4 rounded-lg text-white font-mono text-2xl uppercase focus:border-cyan-500 outline-none text-center tracking-widest" placeholder="ABC-1234" value={entryForm.plate} onChange={e => setEntryForm({...entryForm, plate: e.target.value.toUpperCase()})} />
                                            <div className="flex bg-slate-900 rounded-lg p-1 border border-slate-700">
                                                <button onClick={()=>setEntryForm({...entryForm, type: 'Carro'})} className={`flex-1 py-3 rounded font-bold transition ${entryForm.type === 'Carro' ? 'bg-cyan-600 text-white' : 'text-slate-400'}`}>Carro</button>
                                                <button onClick={()=>setEntryForm({...entryForm, type: 'Moto'})} className={`flex-1 py-3 rounded font-bold transition ${entryForm.type === 'Moto' ? 'bg-cyan-600 text-white' : 'text-slate-400'}`}>Moto</button>
                                            </div>
                                            <input className="w-full bg-slate-900 border border-slate-700 p-4 rounded-lg text-white" placeholder="Modelo do Veículo" value={entryForm.model} onChange={e=>setEntryForm({...entryForm, model:e.target.value})} />
                                            <button onClick={handleEntry} className="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-4 rounded-lg shadow-xl flex items-center justify-center gap-2 transition active:scale-95"><i className="ph-bold ph-ticket"></i> GERAR TICKET</button>
                                        </div>
                                    </div>
                                    <div className="lg:col-span-2 bg-slate-800 rounded-xl p-6 border border-slate-700 min-h-[500px]">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="font-bold text-xl">Pátio Atual</h3>
                                            <input className="bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-sm" placeholder="Buscar placa..." value={filterPlate} onChange={e=>setFilterPlate(e.target.value.toUpperCase())} />
                                        </div>
                                        <div className="space-y-3">
                                            {tickets.filter(t => t.plate.includes(filterPlate)).map(t => (
                                                <div key={t.id} className="bg-slate-900 p-4 rounded-xl border border-slate-700 flex justify-between items-center group hover:border-cyan-500 transition">
                                                    <div className="flex items-center gap-4">
                                                        <div className={`p-3 rounded-lg ${t.type === 'Carro' ? 'bg-blue-900/30 text-blue-400' : 'bg-orange-900/30 text-orange-400'}`}><i className={`ph-fill ${t.type === 'Carro' ? 'ph-car' : 'ph-motorcycle'} text-2xl`}></i></div>
                                                        <div>
                                                            <h4 className="font-bold text-white text-lg font-mono">{t.plate}</h4>
                                                            <p className="text-xs text-slate-500">{t.model} • Entrada: {new Date(t.entryTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => prepareExit(t)} className="bg-red-600 hover:bg-red-500 text-white px-6 py-2 rounded-lg font-bold transition">SAÍDA</button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {tab === 'carwash' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="flex justify-between items-center">
                                        <h3 className="font-bold text-xl">Lava-rápido & Serviços</h3>
                                        <button onClick={() => setModal('service_types')} className="bg-cyan-600 px-4 py-2 rounded font-bold text-sm">Gerenciar Tabela</button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {tickets.map(t => (
                                            <div key={t.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                                                <div>
                                                    <p className="font-mono font-bold text-white">{t.plate}</p>
                                                    <p className="text-xs text-slate-500">{t.services.length} serviços selecionados</p>
                                                </div>
                                                <button onClick={()=>{setAddServiceForm({ticketId: t.id, selectedServices: t.services || []}); setModal('service_manager');}} className="bg-slate-700 p-2 rounded hover:text-cyan-400 transition"><i className="ph-bold ph-plus-circle text-xl"></i></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {tab === 'finance' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="flex justify-between items-center">
                                        <h3 className="font-bold text-xl">Gestão Financeira</h3>
                                        <button onClick={() => setModal('finance')} className="bg-emerald-600 px-4 py-2 rounded font-bold text-sm">Lançar Despesa</button>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl overflow-hidden border border-slate-700">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-900 text-slate-400 uppercase text-[10px] font-black">
                                                <tr><th className="p-4">Data</th><th className="p-4">Descrição</th><th className="p-4">Valor</th><th className="p-4">Status</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-700">
                                                {finances.map((f, i) => (
                                                    <tr key={i} className="hover:bg-slate-700/30">
                                                        <td className="p-4 text-slate-500">{new Date(f.date).toLocaleDateString()}</td>
                                                        <td className="p-4 font-bold">{f.description}</td>
                                                        <td className="p-4 text-red-400">{formatCurrency(f.value)}</td>
                                                        <td className="p-4"><span className="bg-red-900/30 text-red-400 px-2 py-0.5 rounded text-[10px] font-bold">PAGO</span></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {tab === 'config' && (
                                <div className="max-w-2xl bg-slate-800 p-8 rounded-xl border border-slate-700 space-y-6">
                                    <h3 className="font-bold text-xl flex items-center gap-2"><i className="ph-fill ph-gear"></i> Ajustes de Pátio</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs text-slate-400 font-bold block mb-2">Preço Hora (Carro)</label><input className="w-full bg-slate-900 p-3 rounded" type="number" value={config.priceCarHour} onChange={e=>setConfig({...config, priceCarHour: e.target.value})} /></div>
                                        <div><label className="text-xs text-slate-400 font-bold block mb-2">Preço Hora (Moto)</label><input className="w-full bg-slate-900 p-3 rounded" type="number" value={config.priceMotoHour} onChange={e=>setConfig({...config, priceMotoHour: e.target.value})} /></div>
                                    </div>
                                    <button onClick={()=>{localStorage.setItem('parkingpro_config', JSON.stringify(config)); notify('Salvo com Sucesso!');}} className="w-full bg-cyan-600 py-3 rounded font-bold">SALVAR CONFIGURAÇÕES</button>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* MODAIS */}
                    {modal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 no-print">
                            {modal === 'print_entry' && activeTicket && (
                                <div className="bg-white text-black p-6 rounded-xl max-w-sm w-full font-mono text-center">
                                    <h2 className="font-bold text-xl">{config.name}</h2>
                                    <div className="my-4 border-b-2 border-dashed border-black"></div>
                                    <h3 className="text-3xl font-black">{activeTicket.plate}</h3>
                                    <p className="text-xs mt-2">ENTRADA: {new Date(activeTicket.entryTime).toLocaleString()}</p>
                                    <div className="barcode mt-6"></div>
                                    <button onClick={() => window.print()} className="mt-6 w-full bg-cyan-600 text-white py-3 rounded no-print">IMPRIMIR</button>
                                    <button onClick={() => setModal(null)} className="mt-2 w-full text-slate-500 no-print">FECHAR</button>
                                </div>
                            )}

                            {modal === 'confirm_exit' && activeTicket && (
                                <div className="bg-slate-800 p-6 rounded-xl max-w-md w-full border border-slate-700 shadow-2xl">
                                    <h3 className="text-xl font-bold mb-4">Fechar Ticket</h3>
                                    <div className="space-y-4 mb-6">
                                        <div className="flex justify-between"><span>Placa:</span><span className="font-mono font-bold">{activeTicket.plate}</span></div>
                                        <div className="flex justify-between"><span>Permanência:</span><span className="font-bold">{activeTicket.durationHours}h</span></div>
                                        <div className="flex justify-between text-2xl font-black text-emerald-400"><span>Total:</span><span>{formatCurrency(activeTicket.total)}</span></div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>setModal(null)} className="flex-1 bg-slate-700 py-3 rounded font-bold">Cancelar</button>
                                        <button onClick={confirmExit} className="flex-1 bg-emerald-600 py-3 rounded font-bold">Confirmar</button>
                                    </div>
                                </div>
                            )}

                            {modal === 'finance' && (
                                <div className="bg-slate-800 p-6 rounded-xl max-w-sm w-full border border-slate-700">
                                    <h3 className="text-xl font-bold mb-4">Nova Despesa</h3>
                                    <div className="space-y-3">
                                        <input className="w-full bg-slate-900 p-3 rounded" placeholder="Descrição" value={financeForm.description} onChange={e=>setFinanceForm({...financeForm, description:e.target.value})} />
                                        <input className="w-full bg-slate-900 p-3 rounded" type="number" placeholder="Valor" value={financeForm.value} onChange={e=>setFinanceForm({...financeForm, value:e.target.value})} />
                                        <input className="w-full bg-slate-900 p-3 rounded" type="date" value={financeForm.date} onChange={e=>setFinanceForm({...financeForm, date:e.target.value})} />
                                    </div>
                                    <div className="flex justify-end gap-2 mt-6">
                                        <button onClick={()=>setModal(null)} className="text-slate-400 px-4">Voltar</button>
                                        <button onClick={()=>{saveItem('finances', {...financeForm, id: Date.now()}); setModal(null); notify('Lançado!');}} className="bg-emerald-600 px-6 py-2 rounded font-bold">Salvar</button>
                                    </div>
                                </div>
                            )}

                            {modal === 'service_manager' && (
                                <div className="bg-slate-800 p-6 rounded-xl max-w-sm w-full border border-slate-700">
                                    <h3 className="text-xl font-bold mb-4">Selecionar Serviços</h3>
                                    <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                                        {(servicesList.length > 0 ? servicesList : [{id:'s1', name:'Lavagem', price: 40}]).map(s => {
                                            const isSel = addServiceForm.selectedServices.find(x => x.id === s.id);
                                            return (
                                                <button key={s.id} onClick={() => {
                                                    const updated = isSel ? addServiceForm.selectedServices.filter(x=>x.id!==s.id) : [...addServiceForm.selectedServices, s];
                                                    setAddServiceForm({...addServiceForm, selectedServices: updated});
                                                }} className={`w-full p-3 rounded flex justify-between border ${isSel ? 'bg-cyan-900/50 border-cyan-500' : 'bg-slate-900 border-slate-700'}`}>
                                                    <span>{s.name}</span><span>{formatCurrency(s.price)}</span>
                                                </button>
                                            );
                                        })}
                                    </div>
                                    <button onClick={() => {
                                        const ticket = tickets.find(t=>t.id===addServiceForm.ticketId);
                                        if(ticket) saveItem('tickets', {...ticket, services: addServiceForm.selectedServices}, ticket.id);
                                        setModal(null);
                                    }} className="w-full bg-cyan-600 py-3 rounded font-bold mt-6">SALVAR SERVIÇOS</button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
