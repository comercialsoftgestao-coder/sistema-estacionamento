<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parking Pro - Gest√£o de Estacionamento & Lava-r√°pido</title>
    
    <!-- PWA META TAGS (Implantado conforme GUIA APP.pdf) -->
    <meta name="theme-color" content="#0891b2">
    <meta name="description" content="Parking Pro - Gest√£o Inteligente de Estacionamento e Lava-r√°pido">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Parking Pro">
    <link rel="manifest" href="manifest.json">
    <!-- √çCONE APPLE ATUALIZADO -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2991/2991201.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tesseract.js para OCR (Leitura de Placas) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Firebase App & Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Scrollbar Dark */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Anima√ß√µes */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        /* Estilos de Impress√£o (Tickets) */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            .no-print { display: none !important; }
        }

        /* Ticket Style (Papel T√©rmico) */
        .ticket-paper {
            font-family: 'Courier New', Courier, monospace;
            width: 300px; /* Largura padr√£o impressora t√©rmica */
            margin: 0 auto;
            background: #fff;
            color: #000;
            padding: 10px;
            text-align: center;
            border: 1px dashed #ccc;
        }

        .ticket-divider { border-bottom: 1px dashed #000; margin: 10px 0; }

        /* Estilo Ordem de Servi√ßo A4/A5 */
        .os-paper {
            font-family: 'Arial', sans-serif;
            width: 100%;
            background: #fff;
            color: #000;
            padding: 20px;
            border: 1px solid #000;
        }

        /* C√≥digo de Barras CSS Simples */
        .barcode {
            height: 40px;
            width: 100%;
            background-image: linear-gradient(90deg, 
                #000 2%, transparent 2%, transparent 4%, #000 4%, #000 5%, transparent 5%, transparent 6%, #000 6%, 
                #000 8%, transparent 8%, transparent 9%, #000 9%, #000 12%, transparent 12%, transparent 13%, #000 13%, 
                #000 15%, transparent 15%, transparent 16%, #000 16%, #000 19%, transparent 19%, transparent 20%, #000 20%,
                #000 23%, transparent 23%, transparent 24%, #000 24%, #000 25%, transparent 25%, transparent 26%, #000 26%,
                #000 29%, transparent 29%, transparent 30%, #000 30%, #000 31%, transparent 31%, transparent 32%, #000 32%,
                #000 35%, transparent 35%, transparent 36%, #000 36%, #000 38%, transparent 38%, transparent 39%, #000 39%,
                #000 42%, transparent 42%, transparent 43%, #000 43%, #000 45%, transparent 45%, transparent 46%, #000 46%
            );
            background-size: 100% 100%;
        }
        
        /* Custom Input Date Dark Mode */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator, input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
    
    <!-- REGISTRO SERVICE WORKER (PWA) - CORRIGIDO PARA AMBIENTES SANDBOX -->
    <script>
        if ('serviceWorker' in navigator && window.location.protocol.startsWith('http')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('PWA: Service Worker registrado com sucesso:', reg.scope))
                    .catch(err => {
                        if (!err.message.includes('protocol')) {
                            console.error('PWA: Erro ao registrar Service Worker:', err);
                        }
                    });
            });
        } else {
            console.log('PWA: Service Worker ignorado (protocolo n√£o suportado ou funcionalidade ausente).');
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- COMPONENTE TOAST ---
        const Toast = ({ message, type, show, onClose }) => {
            if (!show) return null;
            const colors = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-emerald-600' : (type === 'info' ? 'bg-blue-600' : 'bg-cyan-600'));
            return (
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 md:left-auto md:translate-x-0 md:right-4 ${colors} text-white px-6 py-4 rounded-lg shadow-2xl z-[70] flex items-center gap-3 animate-fade-in w-[90%] md:w-auto`}>
                    <i className="ph-fill ph-info text-xl"></i>
                    <span className="font-bold text-sm md:text-base">{message}</span>
                </div>
            );
        };

        // --- COMPONENTE CHART ---
        const ParkingChart = ({ historyData, financeData }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                if (chartRef.current) chartRef.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                
                const last7Days = [...Array(7)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toLocaleDateString('pt-BR');
                }).reverse();

                const parkingRevenue = last7Days.map(date => {
                    return (Array.isArray(historyData) ? historyData : []).filter(h => new Date(h.exitTime).toLocaleDateString('pt-BR') === date)
                                .reduce((acc, curr) => acc + (curr.total || 0), 0);
                });

                const expensesData = last7Days.map(date => {
                    return (Array.isArray(financeData) ? financeData : []).filter(f => f.type === 'Despesa' && new Date(f.date + 'T12:00:00').toLocaleDateString('pt-BR') === date)
                                .reduce((acc, curr) => acc + (curr.value || 0), 0);
                });

                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: last7Days,
                        datasets: [
                            { label: 'Receita', data: parkingRevenue, backgroundColor: '#0891b2', borderRadius: 4 },
                            { label: 'Despesas', data: expensesData, backgroundColor: '#ef4444', borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', labels: { color: '#cbd5e1', font: { size: 10 } } } },
                        scales: {
                            y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', font: { size: 10 } } },
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } }
                        }
                    }
                });

                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [historyData, financeData]);

            return <div className="h-64 w-full"><canvas ref={canvasRef}></canvas></div>;
        };

        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
        const formatDate = (date) => new Date(date).toLocaleString('pt-BR');

        // COMPONENTE LOGO DIN√ÇMICA
        const BrandLogo = ({ title }) => {
            const displayText = title && title.trim() !== '' ? title : "PARKING PRO";
            const isDefault = displayText.replace(/\s/g, '').toUpperCase() === 'PARKINGPRO';

            return (
                <div className="flex items-center gap-2">
                    <div className="w-8 h-8 md:w-10 md:h-10 bg-cyan-500 rounded flex items-center justify-center shadow-lg shadow-cyan-900/50 flex-shrink-0">
                        <i className="ph-fill ph-car text-white text-xl md:text-2xl"></i>
                    </div>
                    <div className="min-w-0">
                        {isDefault ? (
                            <h1 className="text-lg md:text-xl font-black italic tracking-tighter text-white leading-none whitespace-nowrap">PARKING<span className="text-cyan-400">PRO</span></h1>
                        ) : (
                            <h1 className="text-lg md:text-xl font-black italic tracking-tighter text-white leading-none uppercase truncate max-w-[180px]">{displayText}</h1>
                        )}
                        <p className="text-[8px] md:text-[9px] text-slate-400 font-bold uppercase tracking-widest">Sistema Inteligente</p>
                    </div>
                </div>
            );
        };

        // --- TELA DE LOGIN ---
        const LoginScreen = ({ onLogin, systemName }) => {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [remember, setRemember] = useState(false);

            useEffect(() => {
                const savedUser = localStorage.getItem('parkingpro_saved_user');
                const savedPass = localStorage.getItem('parkingpro_saved_pass');
                if (savedUser && savedPass) {
                    setU(savedUser);
                    setP(savedPass);
                    setRemember(true);
                }
            }, []);

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(u, p, remember);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950 relative overflow-hidden px-4">
                    <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'url("https://images.unsplash.com/photo-1506521781263-d8422e82f27a?q=80&w=2070&auto=format&fit=crop")', backgroundSize: 'cover', backgroundPosition: 'center'}}></div>
                    <div className="bg-slate-900/90 backdrop-blur-xl p-8 rounded-2xl shadow-2xl w-full max-w-sm z-10 border border-slate-800">
                        <div className="flex justify-center mb-6"><BrandLogo title={systemName} /></div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full p-3 bg-slate-950 border border-slate-800 rounded text-base md:text-sm text-white focus:border-cyan-500 outline-none transition" placeholder="Usu√°rio" value={u} onChange={e=>setU(e.target.value)} />
                            <input type="password" className="w-full p-3 bg-slate-950 border border-slate-800 rounded text-base md:text-sm text-white focus:border-cyan-500 outline-none transition" placeholder="Senha" value={p} onChange={e=>setP(e.target.value)} />
                            <div className="flex items-center gap-2">
                                <input type="checkbox" id="remember" checked={remember} onChange={e => setRemember(e.target.checked)} className="w-4 h-4 accent-cyan-600 rounded cursor-pointer" />
                                <label htmlFor="remember" className="text-sm text-slate-400 cursor-pointer select-none">Lembrar senha</label>
                            </div>
                            <button className="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded transition-all shadow-lg shadow-cyan-900/20 active:scale-95">ABRIR SISTEMA</button>
                        </form>
                        <div className="mt-4 text-center text-xs text-slate-600">
                            <p>Admin / 1234</p>
                            <div className="mt-6 border-t border-slate-800 pt-4">
                                <p className="font-bold text-slate-500">¬© 2026 SoftGest√£o. Todos os direitos reservados.</p>
                                <p className="mt-1">Pertence a Adriana Mendes da Cruz Sousa.</p>
                                <p className="mt-1">Todos os direitos e marca registrada s√£o dela.</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP ---
        function App() {
            const [view, setView] = useState('login');
            const [userRole, setUserRole] = useState('operator');
            const [toast, setToast] = useState({ show: false, msg: '', type: 'info' });
            const notify = (msg, type='success') => { setToast({ show: true, msg, type }); setTimeout(()=>setToast({...toast, show: false}), 3000); };

            const [credentials, setCredentials] = useState(() => {
                const storedCreds = localStorage.getItem('parkingpro_credentials');
                return storedCreds ? JSON.parse(storedCreds) : { user: 'admin', pass: '1234' };
            });

            const [config, setConfig] = useState({ name: '', address: 'Av. Paulista, 1000 - SP', totalSpots: 50, priceCarHour: 15.00, priceMotoHour: 8.00, toleranceMin: 15, dailyRate: 60.00 });

            const [tickets, setTickets] = useState([]); 
            const [history, setHistory] = useState([]); 
            const [subscribers, setSubscribers] = useState([]); 
            const [agreements, setAgreements] = useState([]); 
            const [checklists, setChecklists] = useState([]); 
            const [finances, setFinances] = useState([]); 
            const [team, setTeam] = useState([]); 
            const [clients, setClients] = useState([]); 
            const [suppliers, setSuppliers] = useState([]); 
            const [servicesList, setServicesList] = useState([]);

            const [tab, setTab] = useState('dashboard');
            const [modal, setModal] = useState(null);
            const [activeTicket, setActiveTicket] = useState(null); 
            const [filterPlate, setFilterPlate] = useState('');
            const [paymentMethod, setPaymentMethod] = useState('Dinheiro');
            const [editClient, setEditClient] = useState(null);
            const [editSubscriber, setEditSubscriber] = useState(null);
            const [editSupplier, setEditSupplier] = useState(null);
            const [editingServiceId, setEditingServiceId] = useState(null);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false); 
            const [loadingCamera, setLoadingCamera] = useState(false);

            const [db, setDb] = useState(null);
            const [isOnline, setIsOnline] = useState(false);

            const FIREBASE_CONFIG = {
                apiKey: "AIzaSyDYdrt4kbKtyPbx7ipHHb7wftUAlKeOZeE",
                authDomain: "estacionamento-332eb.firebaseapp.com",
                projectId: "estacionamento-332eb",
                storageBucket: "estacionamento-332eb.firebasestorage.app",
                messagingSenderId: "467691522256",
                appId: "1:467691522256:web:6d4495458c494e753cb6d5"
            };

            const [entryForm, setEntryForm] = useState({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] });
            const [agreementForm, setAgreementForm] = useState({ name: '', discountType: 'free_time', value: 0 });
            const [checklistForm, setChecklistForm] = useState({ plate: '', model: '', fuel: '1/2', items: [], notes: '', date: '' });
            const [financeForm, setFinanceForm] = useState({ type: 'Despesa', description: '', value: 0, date: '', category: 'Geral', file: null, fileName: '' });
            const [teamForm, setTeamForm] = useState({ name: '', role: 'Operador', shift: 'Manh√£', phone: '' });
            const [serviceConfigForm, setServiceConfigForm] = useState({ name: '', price: 0 });
            const [addServiceForm, setAddServiceForm] = useState({ ticketId: '', selectedServices: [] });
            const [clientForm, setClientForm] = useState({ name: '', phone: '', plate: '', points: 0, notes: '' });
            const [subscriberForm, setSubscriberForm] = useState({ name: '', plate: '', model: '', plan: 'Integral', dueDay: 10, active: true });
            const [passwordForm, setPasswordForm] = useState({ current: '', new: '', confirm: '' });
            const [editTicketForm, setEditTicketForm] = useState({ plate: '', model: '', type: 'Carro', notes: '' });

            const commonDamages = ['Arranh√µes', 'Amassados', 'Vidro Trincado', 'Farol Quebrado', 'Pneu Murcho', 'Antena Quebrada', 'Retrovisor Danif.'];

            const tabNames = {
                dashboard: 'Vis√£o Geral',
                patio: 'P√°tio & Entrada',
                carwash: 'Lava-r√°pido',
                finance: 'Financeiro',
                suppliers: 'Fornecedores',
                team: 'Equipe',
                clients: 'Fidelidade',
                subscribers: 'Mensalistas',
                agreements: 'Conv√™nios',
                config: 'Configura√ß√µes'
            };

            const hardAppReset = async () => {
                if (confirm("Limpar cache e for√ßar atualiza√ß√£o? Isso recarregar√° o sistema.")) {
                    try {
                        if ('serviceWorker' in navigator) {
                            const registrations = await navigator.serviceWorker.getRegistrations();
                            for (let reg of registrations) { await reg.unregister(); }
                        }
                        if ('caches' in window) {
                            const cacheNames = await caches.keys();
                            await Promise.all(cacheNames.map(name => caches.delete(name)));
                        }
                        window.location.reload(true);
                    } catch (e) { 
                        console.error("Erro ao realizar o reset:", e);
                        alert("Erro ao resetar. Por favor, recarregue manualmente.");
                    }
                }
            };

            useEffect(() => {
                if (!firebase.apps.length) {
                    try {
                        firebase.initializeApp(FIREBASE_CONFIG);
                        setDb(firebase.firestore());
                        setIsOnline(true);
                    } catch (e) { setIsOnline(false); }
                } else {
                    setDb(firebase.firestore());
                    setIsOnline(true);
                }
            }, []);

            const useSync = (collectionName, setState, fallbackData) => {
                useEffect(() => {
                    if (db) {
                        const unsubscribe = db.collection(collectionName).onSnapshot(snapshot => {
                            const data = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })); 
                            setState(data);
                        });
                        return () => unsubscribe();
                    } else if (view === 'app') {
                        const stored = localStorage.getItem(`parkingpro_${collectionName}`);
                        if (stored) setState(JSON.parse(stored));
                    }
                }, [db, view]);
            };

            useSync('tickets', setTickets, []);
            useSync('history', setHistory, []);
            useSync('finances', setFinances, []);
            useSync('subscribers', setSubscribers, []);
            useSync('clients', setClients, []);
            useSync('team', setTeam, []);
            useSync('suppliers', setSuppliers, []);
            useSync('agreements', setAgreements, []);
            
            useEffect(() => {
                if (db) {
                    const unsubscribe = db.collection('servicesList').onSnapshot(snapshot => {
                        let data = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        if (data.length > 0) setServicesList(data);
                        else setServicesList([{id: 's1', name: 'Lavagem Simples', price: 40.00}]);
                    });
                    return () => unsubscribe();
                }
            }, [db]);

            const saveItem = async (col, item, idOverride) => {
                const id = String(idOverride || item.id || Date.now());
                if (db) await db.collection(col).doc(id).set({ ...item, id: id });
            };

            const deleteItem = async (col, id) => { if (db) await db.collection(col).doc(String(id)).delete(); };

            const handleLogin = (u, p, remember) => { 
                if (u === credentials.user && p === credentials.pass) { 
                    setUserRole(u.toLowerCase() === 'admin' ? 'admin' : 'operator');
                    setView('app'); 
                } else notify('Acesso negado.', 'error'); 
            };
            
            const handleFileScan = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoadingCamera(true);
                try {
                    const { data: { text } } = await Tesseract.recognize(file, 'eng');
                    const match = text.replace(/[^A-Z0-9]/ig, '').toUpperCase().match(/[A-Z]{3}[0-9][A-Z0-9][0-9]{2}/) || text.replace(/[^A-Z0-9]/ig, '').toUpperCase().match(/[A-Z]{3}[0-9]{4}/);
                    if (match) { setEntryForm(prev => ({ ...prev, plate: match[0] })); notify(`Placa: ${match[0]}`); }
                } catch (err) { notify('Erro OCR', 'error'); }
                finally { setLoadingCamera(false); }
            };
            
            const handleEntry = () => { 
                if (!entryForm.plate) return notify('Placa obrigat√≥ria', 'error'); 
                const newTicket = { id: Date.now(), plate: entryForm.plate.toUpperCase(), model: entryForm.model, type: entryForm.type, entryTime: new Date().toISOString(), damages: entryForm.damages || [], services: [], status: 'active' }; 
                saveItem('tickets', newTicket);
                setEntryForm({ plate: '', model: '', type: 'Carro', notes: '', manualEntry: '', manualExit: '', damages: [] });
                setActiveTicket(newTicket); setModal('print_entry'); 
            };

            const prepareExit = (ticket) => { 
                const now = new Date(); const entry = new Date(ticket.entryTime);
                const diffHours = Math.ceil((now - entry) / 3600000);
                const rate = ticket.type === 'Carro' ? config.priceCarHour : config.priceMotoHour;
                const total = diffHours * rate;
                setActiveTicket({ ...ticket, exitTime: now.toISOString(), durationHours: diffHours, total: total }); 
                setModal('confirm_exit'); 
            };

            const confirmExit = () => { 
                saveItem('history', {...activeTicket, status: 'finished'}); 
                deleteItem('tickets', activeTicket.id);
                setModal('print_exit'); notify('Sa√≠da registrada!'); 
            };

            const saveFinance = () => { 
                const newFinance = { ...financeForm, id: Date.now(), value: parseFloat(financeForm.value) }; 
                saveItem('finances', newFinance); 
                setFinanceForm({ type: 'Despesa', description: '', value: 0, date: '', category: 'Geral' }); 
                setModal(null); notify('Lan√ßamento salvo!');
            };

            const downloadDashboardReport = (isMonthly = false) => { 
                let content = `RELAT√ìRIO ${isMonthly ? 'MENSAL' : 'DI√ÅRIO'}\n\n`;
                const blob = new Blob([content], { type: 'text/plain' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = `Relatorio_${Date.now()}.txt`; a.click();
            };

            const sendWhatsAppTicket = (ticket) => {
                const message = `Ticket: ${ticket.plate}\nEntrada: ${new Date(ticket.entryTime).toLocaleString()}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
            };

            const stats = useMemo(() => ({
                occupied: tickets.length, free: config.totalSpots - tickets.length,
                totalRevenue: history.reduce((acc, curr) => acc + (curr.total || 0), 0),
                expenses: finances.filter(f => f.type === 'Despesa').reduce((acc, curr) => acc + (curr.value || 0), 0)
            }), [tickets, history, finances, config]);

            if (view === 'login') return <LoginScreen onLogin={handleLogin} systemName={config.name} />;

            return (
                <div className="flex h-screen overflow-hidden bg-slate-900 text-slate-100 font-sans">
                    <Toast {...toast} onClose={()=>setToast({...toast, show:false})} />
                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-950 md:relative md:translate-x-0 transition-transform ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-slate-800 flex justify-between items-center"><BrandLogo title={config.name} /></div>
                        <nav className="flex-1 p-4 space-y-1">
                            {[
                                { id: 'dashboard', label: 'Vis√£o Geral', icon: 'gauge', roles: ['admin', 'operator'] },
                                { id: 'patio', label: 'P√°tio & Entrada', icon: 'car-profile', roles: ['admin', 'operator'] },
                                { id: 'carwash', label: 'Lava-r√°pido', icon: 'drop-half', roles: ['admin', 'operator'] }, 
                                { id: 'finance', label: 'Financeiro', icon: 'currency-dollar', roles: ['admin', 'operator'] },
                                { id: 'config', label: 'Configura√ß√µes', icon: 'gear', roles: ['admin'] },
                            ].filter(i => i.roles.includes(userRole)).map(item => (
                                <button key={item.id} onClick={() => setTab(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-bold ${tab === item.id ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}>
                                    <i className={`ph ph-${item.icon} text-xl`}></i> {item.label}
                                </button>
                            ))}
                        </nav>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden">
                        <header className="h-16 bg-slate-900/80 border-b border-slate-800 flex items-center justify-between px-6">
                            <button className="md:hidden" onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}><i className="ph ph-list text-2xl"></i></button>
                            <h2 className="text-xl font-bold uppercase">{tabNames[tab]}</h2>
                            <div className="text-right">
                                <p className="text-xs text-slate-400">Vagas Livres</p>
                                <p className="text-xl font-black text-emerald-400">{stats.free}</p>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            {tab === 'dashboard' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="flex justify-between items-center">
                                        <h3 className="font-bold text-xl">Painel de Controle</h3>
                                        <div className="flex gap-2">
                                            <a href="https://wa.me/5511932186193?text=Suporte" target="_blank" className="bg-emerald-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2"><i className="ph ph-whatsapp-logo"></i> Suporte</a>
                                            <button onClick={() => downloadDashboardReport(true)} className="bg-blue-600 px-4 py-2 rounded-lg font-bold">Relat√≥rio Mensal</button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-cyan-500">
                                            <p className="text-xs text-slate-400 uppercase font-bold">Ocupa√ß√£o</p>
                                            <h3 className="text-3xl font-bold mt-2">{stats.occupied}</h3>
                                        </div>
                                        <div className="bg-slate-800 p-5 rounded-xl border-t-4 border-emerald-500">
                                            <p className="text-xs text-slate-400 uppercase font-bold">Receita</p>
                                            <h3 className="text-3xl font-bold text-emerald-400 mt-2">{formatCurrency(stats.totalRevenue)}</h3>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-xl shadow-lg p-6 border-t-4 border-yellow-600">
                                        <h3 className="text-xl font-bold text-gray-800 mb-4">üõ†Ô∏è Manuten√ß√£o</h3>
                                        <div className="space-y-4">
                                            <p className="text-sm text-gray-600">Limpe o cache local para receber atualiza√ß√µes do sistema e do √≠cone do aplicativo.</p>
                                            <button onClick={hardAppReset} className="w-full bg-red-600 text-white py-4 rounded-lg font-bold hover:bg-red-700 flex items-center justify-center gap-2">
                                                <span className="text-lg">üîÑ</span> LIMPAR CACHE E ATUALIZAR √çCONE
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {tab === 'patio' && (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                        <h3 className="font-bold text-xl text-cyan-400 mb-6">Nova Entrada</h3>
                                        <div className="space-y-4">
                                            <div className="flex gap-2">
                                                <input className="w-full bg-slate-900 border-2 border-slate-700 p-4 rounded-lg text-white font-mono text-2xl uppercase text-center" placeholder="ABC-1234" value={entryForm.plate} onChange={e => setEntryForm({...entryForm, plate: e.target.value.toUpperCase()})} />
                                                <label className="bg-slate-700 p-3 rounded-lg flex items-center justify-center w-16 cursor-pointer">
                                                    <i className="ph ph-camera text-2xl"></i>
                                                    <input type="file" accept="image/*" capture="environment" className="hidden" onChange={handleFileScan} />
                                                </label>
                                            </div>
                                            <button onClick={handleEntry} className="w-full bg-cyan-600 text-white font-bold py-4 rounded-lg text-lg">Gerar Ticket</button>
                                        </div>
                                    </div>
                                    <div className="lg:col-span-2 space-y-3">
                                        {tickets.map(t => (
                                            <div key={t.id} className="bg-slate-800 p-4 rounded-lg flex justify-between items-center">
                                                <div><h4 className="font-bold text-xl font-mono">{t.plate}</h4><p className="text-sm text-slate-400">{new Date(t.entryTime).toLocaleTimeString()}</p></div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => sendWhatsAppTicket(t)} className="p-3 bg-emerald-600 rounded"><i className="ph ph-whatsapp-logo"></i></button>
                                                    <button onClick={() => prepareExit(t)} className="bg-red-600 px-4 py-2 rounded-lg font-bold">Sa√≠da</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {modal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 no-print">
                            {modal === 'print_entry' && activeTicket && (
                                <div className="bg-white text-black p-6 rounded-xl max-w-sm w-full text-center">
                                    <div id="print-area">
                                        <h2 className="font-bold text-xl">PARKING PRO</h2>
                                        <div className="my-4 border-b-2 border-dashed border-black"></div>
                                        <h3 className="text-2xl font-black">{activeTicket.plate}</h3>
                                        <p className="text-xs mt-2">ENTRADA: {new Date(activeTicket.entryTime).toLocaleString()}</p>
                                    </div>
                                    <button onClick={() => { window.print(); setModal(null); }} className="w-full bg-cyan-600 text-white font-bold py-3 rounded mt-4">Imprimir</button>
                                </div>
                            )}
                            {modal === 'confirm_exit' && activeTicket && (
                                <div className="bg-slate-800 text-white p-6 rounded-xl max-w-md w-full">
                                    <h3 className="text-xl font-bold mb-4">Fechar Ticket - {activeTicket.plate}</h3>
                                    <div className="space-y-4 mb-6">
                                        <div className="flex justify-between items-center"><span className="text-xl font-bold">Total:</span><span className="text-3xl font-black text-emerald-400">{formatCurrency(activeTicket.total)}</span></div>
                                    </div>
                                    <button onClick={confirmExit} className="w-full bg-emerald-600 py-3 rounded font-bold">Confirmar Sa√≠da</button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
